# æ–‡ä»¶ç®¡ç†ç³»ç»Ÿå®æ–½æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜å¦‚ä½•åœ¨æ™ºæ…§æ ¡å›­ç®¡ç†ç³»ç»Ÿä¸­å®ç°å®Œæ•´çš„æ–‡ä»¶ç®¡ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ã€ç‰ˆæœ¬ç®¡ç†å’Œæƒé™æ§åˆ¶ã€‚

## ğŸ¯ åŠŸèƒ½ç›®æ ‡

- âœ… æ”¯æŒå¤šç§æ–‡ä»¶ç±»å‹ä¸Šä¼ ä¸‹è½½
- âœ… æ–‡æ¡£ç‰ˆæœ¬ç®¡ç†å’Œå†å²è¿½è¸ª
- âœ… ç»†ç²’åº¦æ–‡ä»¶æƒé™æ§åˆ¶
- âœ… æ–‡ä»¶å®‰å…¨æ‰«æå’ŒéªŒè¯
- âœ… åˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨æ”¯æŒ

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
æ–‡ä»¶ç®¡ç†ç³»ç»Ÿæ¶æ„
â”œâ”€â”€ æ–‡ä»¶ä¸Šä¼ å±‚
â”‚   â”œâ”€â”€ æ–‡ä»¶éªŒè¯
â”‚   â”œâ”€â”€ ç—…æ¯’æ‰«æ
â”‚   â””â”€â”€ å­˜å‚¨è·¯ç”±
â”œâ”€â”€ å­˜å‚¨ç®¡ç†å±‚
â”‚   â”œâ”€â”€ æœ¬åœ°å­˜å‚¨
â”‚   â”œâ”€â”€ OSSå­˜å‚¨
â”‚   â””â”€â”€ MinIOå­˜å‚¨
â”œâ”€â”€ ç‰ˆæœ¬æ§åˆ¶å±‚
â”‚   â”œâ”€â”€ ç‰ˆæœ¬åˆ›å»º
â”‚   â”œâ”€â”€ ç‰ˆæœ¬æ¯”è¾ƒ
â”‚   â””â”€â”€ ç‰ˆæœ¬å›æ»š
â””â”€â”€ æƒé™æ§åˆ¶å±‚
    â”œâ”€â”€ ç”¨æˆ·æƒé™
    â”œâ”€â”€ è§’è‰²æƒé™
    â””â”€â”€ æ—¶é—´æƒé™
```

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### 1. æ–‡ä»¶ä¿¡æ¯è¡¨

```sql
-- æ–‡ä»¶ä¿¡æ¯ä¸»è¡¨
CREATE TABLE tb_file_info (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'æ–‡ä»¶ID',
    file_name VARCHAR(255) NOT NULL COMMENT 'åŸå§‹æ–‡ä»¶å',
    stored_file_name VARCHAR(255) NOT NULL COMMENT 'å­˜å‚¨æ–‡ä»¶å',
    file_path VARCHAR(500) NOT NULL COMMENT 'æ–‡ä»¶å­˜å‚¨è·¯å¾„',
    file_type VARCHAR(50) NOT NULL COMMENT 'æ–‡ä»¶ç±»å‹',
    file_size BIGINT NOT NULL COMMENT 'æ–‡ä»¶å¤§å°(å­—èŠ‚)',
    md5_hash VARCHAR(32) NOT NULL COMMENT 'æ–‡ä»¶MD5å€¼',
    sha256_hash VARCHAR(64) COMMENT 'æ–‡ä»¶SHA256å€¼',
    mime_type VARCHAR(100) COMMENT 'MIMEç±»å‹',
    
    -- ä¸šåŠ¡å…³è”
    business_type VARCHAR(50) COMMENT 'ä¸šåŠ¡ç±»å‹',
    business_id VARCHAR(100) COMMENT 'ä¸šåŠ¡ID',
    
    -- ä¸Šä¼ ä¿¡æ¯
    upload_user_id BIGINT NOT NULL COMMENT 'ä¸Šä¼ ç”¨æˆ·ID',
    upload_ip VARCHAR(50) COMMENT 'ä¸Šä¼ IP',
    upload_user_agent TEXT COMMENT 'ä¸Šä¼ ç”¨æˆ·ä»£ç†',
    
    -- è®¿é—®ç»Ÿè®¡
    download_count INT DEFAULT 0 COMMENT 'ä¸‹è½½æ¬¡æ•°',
    view_count INT DEFAULT 0 COMMENT 'æŸ¥çœ‹æ¬¡æ•°',
    last_access_time DATETIME COMMENT 'æœ€åè®¿é—®æ—¶é—´',
    
    -- æ–‡ä»¶çŠ¶æ€
    file_status TINYINT DEFAULT 1 COMMENT 'æ–‡ä»¶çŠ¶æ€ï¼š1-æ­£å¸¸ï¼Œ2-éš”ç¦»ï¼Œ3-åˆ é™¤',
    virus_scan_status TINYINT DEFAULT 0 COMMENT 'ç—…æ¯’æ‰«æçŠ¶æ€ï¼š0-æœªæ‰«æï¼Œ1-å®‰å…¨ï¼Œ2-å¨èƒ',
    virus_scan_time DATETIME COMMENT 'ç—…æ¯’æ‰«ææ—¶é—´',
    
    -- å­˜å‚¨é…ç½®
    storage_type VARCHAR(20) DEFAULT 'local' COMMENT 'å­˜å‚¨ç±»å‹ï¼šlocal,oss,minio',
    storage_bucket VARCHAR(100) COMMENT 'å­˜å‚¨æ¡¶åç§°',
    
    -- å®¡è®¡å­—æ®µ
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    deleted TINYINT NOT NULL DEFAULT 0 COMMENT 'æ˜¯å¦åˆ é™¤',
    
    -- ç´¢å¼•
    INDEX idx_business (business_type, business_id, deleted),
    INDEX idx_upload_user (upload_user_id, created_at),
    INDEX idx_file_type (file_type, file_status, deleted),
    INDEX idx_md5_hash (md5_hash),
    INDEX idx_created_at (created_at),
    
    -- å¤–é”®çº¦æŸ
    FOREIGN KEY (upload_user_id) REFERENCES tb_user(id) ON DELETE RESTRICT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ–‡ä»¶ä¿¡æ¯è¡¨';
```

### 2. æ–‡æ¡£ç‰ˆæœ¬è¡¨

```sql
-- æ–‡æ¡£ç‰ˆæœ¬ç®¡ç†è¡¨
CREATE TABLE tb_document_version (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'ç‰ˆæœ¬ID',
    document_id BIGINT NOT NULL COMMENT 'æ–‡æ¡£ID',
    file_id BIGINT NOT NULL COMMENT 'å…³è”æ–‡ä»¶ID',
    version_number VARCHAR(20) NOT NULL COMMENT 'ç‰ˆæœ¬å·',
    version_name VARCHAR(100) COMMENT 'ç‰ˆæœ¬åç§°',
    change_log TEXT COMMENT 'å˜æ›´æ—¥å¿—',
    
    -- ç‰ˆæœ¬çŠ¶æ€
    is_active TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦ä¸ºå½“å‰ç‰ˆæœ¬',
    is_major TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦ä¸ºä¸»è¦ç‰ˆæœ¬',
    
    -- åˆ›å»ºä¿¡æ¯
    created_by BIGINT NOT NULL COMMENT 'åˆ›å»ºè€…ID',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    
    -- å®¡æ‰¹ä¿¡æ¯
    approval_status TINYINT DEFAULT 0 COMMENT 'å®¡æ‰¹çŠ¶æ€ï¼š0-å¾…å®¡æ‰¹ï¼Œ1-å·²é€šè¿‡ï¼Œ2-å·²æ‹’ç»',
    approved_by BIGINT COMMENT 'å®¡æ‰¹è€…ID',
    approved_at DATETIME COMMENT 'å®¡æ‰¹æ—¶é—´',
    approval_comment TEXT COMMENT 'å®¡æ‰¹æ„è§',
    
    -- å…¶ä»–å­—æ®µ
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    deleted TINYINT NOT NULL DEFAULT 0 COMMENT 'æ˜¯å¦åˆ é™¤',
    
    -- ç´¢å¼•
    UNIQUE KEY uk_document_version (document_id, version_number, deleted),
    INDEX idx_document_active (document_id, is_active, deleted),
    INDEX idx_created_by (created_by, created_at),
    INDEX idx_file_id (file_id),
    
    -- å¤–é”®çº¦æŸ
    FOREIGN KEY (file_id) REFERENCES tb_file_info(id) ON DELETE RESTRICT,
    FOREIGN KEY (created_by) REFERENCES tb_user(id) ON DELETE RESTRICT,
    FOREIGN KEY (approved_by) REFERENCES tb_user(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ–‡æ¡£ç‰ˆæœ¬è¡¨';
```

### 3. æ–‡ä»¶æƒé™è¡¨

```sql
-- æ–‡ä»¶æƒé™æ§åˆ¶è¡¨
CREATE TABLE tb_file_permission (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'æƒé™ID',
    file_id BIGINT NOT NULL COMMENT 'æ–‡ä»¶ID',
    
    -- æƒé™ä¸»ä½“
    permission_type TINYINT NOT NULL COMMENT 'æƒé™ç±»å‹ï¼š1-ç”¨æˆ·ï¼Œ2-è§’è‰²ï¼Œ3-éƒ¨é—¨',
    target_id BIGINT NOT NULL COMMENT 'ç›®æ ‡IDï¼ˆç”¨æˆ·ID/è§’è‰²ID/éƒ¨é—¨IDï¼‰',
    
    -- æƒé™å†…å®¹
    can_read TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦å¯è¯»',
    can_write TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦å¯å†™',
    can_delete TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦å¯åˆ é™¤',
    can_share TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦å¯åˆ†äº«',
    can_download TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦å¯ä¸‹è½½',
    
    -- æƒé™é™åˆ¶
    access_count_limit INT COMMENT 'è®¿é—®æ¬¡æ•°é™åˆ¶',
    access_count_used INT DEFAULT 0 COMMENT 'å·²ä½¿ç”¨è®¿é—®æ¬¡æ•°',
    expire_time DATETIME COMMENT 'æƒé™è¿‡æœŸæ—¶é—´',
    ip_whitelist TEXT COMMENT 'IPç™½åå•ï¼ˆJSONæ ¼å¼ï¼‰',
    
    -- æˆæƒä¿¡æ¯
    granted_by BIGINT NOT NULL COMMENT 'æˆæƒè€…ID',
    granted_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'æˆæƒæ—¶é—´',
    grant_reason VARCHAR(200) COMMENT 'æˆæƒåŸå› ',
    
    -- å®¡è®¡å­—æ®µ
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    deleted TINYINT NOT NULL DEFAULT 0 COMMENT 'æ˜¯å¦åˆ é™¤',
    
    -- ç´¢å¼•
    UNIQUE KEY uk_file_permission (file_id, permission_type, target_id, deleted),
    INDEX idx_target (permission_type, target_id, deleted),
    INDEX idx_granted_by (granted_by, granted_at),
    INDEX idx_expire_time (expire_time),
    
    -- å¤–é”®çº¦æŸ
    FOREIGN KEY (file_id) REFERENCES tb_file_info(id) ON DELETE CASCADE,
    FOREIGN KEY (granted_by) REFERENCES tb_user(id) ON DELETE RESTRICT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ–‡ä»¶æƒé™è¡¨';
```

### 4. æ–‡ä»¶è®¿é—®æ—¥å¿—è¡¨

```sql
-- æ–‡ä»¶è®¿é—®æ—¥å¿—è¡¨
CREATE TABLE tb_file_access_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'æ—¥å¿—ID',
    file_id BIGINT NOT NULL COMMENT 'æ–‡ä»¶ID',
    user_id BIGINT COMMENT 'è®¿é—®ç”¨æˆ·ID',
    
    -- è®¿é—®ä¿¡æ¯
    access_type TINYINT NOT NULL COMMENT 'è®¿é—®ç±»å‹ï¼š1-æŸ¥çœ‹ï¼Œ2-ä¸‹è½½ï¼Œ3-ç¼–è¾‘ï¼Œ4-åˆ é™¤',
    access_result TINYINT NOT NULL COMMENT 'è®¿é—®ç»“æœï¼š1-æˆåŠŸï¼Œ2-å¤±è´¥',
    failure_reason VARCHAR(200) COMMENT 'å¤±è´¥åŸå› ',
    
    -- å®¢æˆ·ç«¯ä¿¡æ¯
    client_ip VARCHAR(50) COMMENT 'å®¢æˆ·ç«¯IP',
    user_agent TEXT COMMENT 'ç”¨æˆ·ä»£ç†',
    referer VARCHAR(500) COMMENT 'æ¥æºé¡µé¢',
    
    -- æ€§èƒ½ä¿¡æ¯
    response_time INT COMMENT 'å“åº”æ—¶é—´(æ¯«ç§’)',
    file_size BIGINT COMMENT 'ä¼ è¾“æ–‡ä»¶å¤§å°',
    
    -- æ—¶é—´ä¿¡æ¯
    access_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'è®¿é—®æ—¶é—´',
    
    -- ç´¢å¼•
    INDEX idx_file_user (file_id, user_id, access_time),
    INDEX idx_access_type (access_type, access_result, access_time),
    INDEX idx_client_ip (client_ip, access_time),
    INDEX idx_access_time (access_time),
    
    -- å¤–é”®çº¦æŸ
    FOREIGN KEY (file_id) REFERENCES tb_file_info(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES tb_user(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ–‡ä»¶è®¿é—®æ—¥å¿—è¡¨';
```

## ğŸ”§ æ ¸å¿ƒå®ä½“ç±»

### 1. æ–‡ä»¶ä¿¡æ¯å®ä½“

```java
// ä½ç½®ï¼šsrc/main/java/com/campus/domain/entity/system/FileInfo.java
package com.campus.domain.entity.system;

import com.campus.domain.entity.infrastructure.BaseEntity;
import com.campus.shared.security.EncryptionConfig.EncryptedField;
import com.campus.shared.security.EncryptionConfig.EncryptionEntityListener;
import com.fasterxml.jackson.annotation.JsonFormat;
import jakarta.persistence.*;
import jakarta.validation.constraints.*;
import lombok.Data;
import lombok.EqualsAndHashCode;

import java.time.LocalDateTime;

@Data
@EqualsAndHashCode(callSuper = true)
@Entity
@Table(name = "tb_file_info")
@EntityListeners(EncryptionEntityListener.class)
public class FileInfo extends BaseEntity {

    /**
     * åŸå§‹æ–‡ä»¶å
     */
    @NotBlank(message = "æ–‡ä»¶åä¸èƒ½ä¸ºç©º")
    @Size(max = 255, message = "æ–‡ä»¶åé•¿åº¦ä¸èƒ½è¶…è¿‡255ä¸ªå­—ç¬¦")
    @Column(name = "file_name", nullable = false)
    private String fileName;

    /**
     * å­˜å‚¨æ–‡ä»¶å
     */
    @NotBlank(message = "å­˜å‚¨æ–‡ä»¶åä¸èƒ½ä¸ºç©º")
    @Size(max = 255, message = "å­˜å‚¨æ–‡ä»¶åé•¿åº¦ä¸èƒ½è¶…è¿‡255ä¸ªå­—ç¬¦")
    @Column(name = "stored_file_name", nullable = false)
    private String storedFileName;

    /**
     * æ–‡ä»¶å­˜å‚¨è·¯å¾„
     */
    @NotBlank(message = "æ–‡ä»¶è·¯å¾„ä¸èƒ½ä¸ºç©º")
    @Size(max = 500, message = "æ–‡ä»¶è·¯å¾„é•¿åº¦ä¸èƒ½è¶…è¿‡500ä¸ªå­—ç¬¦")
    @Column(name = "file_path", nullable = false, length = 500)
    private String filePath;

    /**
     * æ–‡ä»¶ç±»å‹
     */
    @NotBlank(message = "æ–‡ä»¶ç±»å‹ä¸èƒ½ä¸ºç©º")
    @Size(max = 50, message = "æ–‡ä»¶ç±»å‹é•¿åº¦ä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦")
    @Column(name = "file_type", nullable = false, length = 50)
    private String fileType;

    /**
     * æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
     */
    @NotNull(message = "æ–‡ä»¶å¤§å°ä¸èƒ½ä¸ºç©º")
    @Min(value = 0, message = "æ–‡ä»¶å¤§å°ä¸èƒ½ä¸ºè´Ÿæ•°")
    @Column(name = "file_size", nullable = false)
    private Long fileSize;

    /**
     * æ–‡ä»¶MD5å€¼
     */
    @NotBlank(message = "æ–‡ä»¶MD5ä¸èƒ½ä¸ºç©º")
    @Size(min = 32, max = 32, message = "MD5é•¿åº¦å¿…é¡»ä¸º32ä½")
    @Column(name = "md5_hash", nullable = false, length = 32)
    private String md5Hash;

    /**
     * æ–‡ä»¶SHA256å€¼
     */
    @Size(min = 64, max = 64, message = "SHA256é•¿åº¦å¿…é¡»ä¸º64ä½")
    @Column(name = "sha256_hash", length = 64)
    private String sha256Hash;

    /**
     * MIMEç±»å‹
     */
    @Size(max = 100, message = "MIMEç±»å‹é•¿åº¦ä¸èƒ½è¶…è¿‡100ä¸ªå­—ç¬¦")
    @Column(name = "mime_type", length = 100)
    private String mimeType;

    /**
     * ä¸šåŠ¡ç±»å‹
     */
    @Size(max = 50, message = "ä¸šåŠ¡ç±»å‹é•¿åº¦ä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦")
    @Column(name = "business_type", length = 50)
    private String businessType;

    /**
     * ä¸šåŠ¡ID
     */
    @Size(max = 100, message = "ä¸šåŠ¡IDé•¿åº¦ä¸èƒ½è¶…è¿‡100ä¸ªå­—ç¬¦")
    @Column(name = "business_id", length = 100)
    private String businessId;

    /**
     * ä¸Šä¼ ç”¨æˆ·ID
     */
    @NotNull(message = "ä¸Šä¼ ç”¨æˆ·IDä¸èƒ½ä¸ºç©º")
    @Column(name = "upload_user_id", nullable = false)
    private Long uploadUserId;

    /**
     * ä¸Šä¼ IP
     */
    @Size(max = 50, message = "ä¸Šä¼ IPé•¿åº¦ä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦")
    @Column(name = "upload_ip", length = 50)
    private String uploadIp;

    /**
     * ä¸Šä¼ ç”¨æˆ·ä»£ç†
     */
    @Column(name = "upload_user_agent", columnDefinition = "TEXT")
    private String uploadUserAgent;

    /**
     * ä¸‹è½½æ¬¡æ•°
     */
    @Min(value = 0, message = "ä¸‹è½½æ¬¡æ•°ä¸èƒ½ä¸ºè´Ÿæ•°")
    @Column(name = "download_count", columnDefinition = "INT DEFAULT 0")
    private Integer downloadCount = 0;

    /**
     * æŸ¥çœ‹æ¬¡æ•°
     */
    @Min(value = 0, message = "æŸ¥çœ‹æ¬¡æ•°ä¸èƒ½ä¸ºè´Ÿæ•°")
    @Column(name = "view_count", columnDefinition = "INT DEFAULT 0")
    private Integer viewCount = 0;

    /**
     * æœ€åè®¿é—®æ—¶é—´
     */
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")
    @Column(name = "last_access_time")
    private LocalDateTime lastAccessTime;

    /**
     * æ–‡ä»¶çŠ¶æ€ï¼š1-æ­£å¸¸ï¼Œ2-éš”ç¦»ï¼Œ3-åˆ é™¤
     */
    @Min(value = 1, message = "æ–‡ä»¶çŠ¶æ€å€¼æ— æ•ˆ")
    @Max(value = 3, message = "æ–‡ä»¶çŠ¶æ€å€¼æ— æ•ˆ")
    @Column(name = "file_status", columnDefinition = "TINYINT DEFAULT 1")
    private Integer fileStatus = 1;

    /**
     * ç—…æ¯’æ‰«æçŠ¶æ€ï¼š0-æœªæ‰«æï¼Œ1-å®‰å…¨ï¼Œ2-å¨èƒ
     */
    @Min(value = 0, message = "ç—…æ¯’æ‰«æçŠ¶æ€å€¼æ— æ•ˆ")
    @Max(value = 2, message = "ç—…æ¯’æ‰«æçŠ¶æ€å€¼æ— æ•ˆ")
    @Column(name = "virus_scan_status", columnDefinition = "TINYINT DEFAULT 0")
    private Integer virusScanStatus = 0;

    /**
     * ç—…æ¯’æ‰«ææ—¶é—´
     */
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")
    @Column(name = "virus_scan_time")
    private LocalDateTime virusScanTime;

    /**
     * å­˜å‚¨ç±»å‹ï¼šlocal,oss,minio
     */
    @Size(max = 20, message = "å­˜å‚¨ç±»å‹é•¿åº¦ä¸èƒ½è¶…è¿‡20ä¸ªå­—ç¬¦")
    @Column(name = "storage_type", length = 20, columnDefinition = "VARCHAR(20) DEFAULT 'local'")
    private String storageType = "local";

    /**
     * å­˜å‚¨æ¡¶åç§°
     */
    @Size(max = 100, message = "å­˜å‚¨æ¡¶åç§°é•¿åº¦ä¸èƒ½è¶…è¿‡100ä¸ªå­—ç¬¦")
    @Column(name = "storage_bucket", length = 100)
    private String storageBucket;

    // æ–‡ä»¶çŠ¶æ€æšä¸¾
    public enum FileStatus {
        NORMAL(1, "æ­£å¸¸"),
        QUARANTINE(2, "éš”ç¦»"),
        DELETED(3, "åˆ é™¤");

        private final int code;
        private final String description;

        FileStatus(int code, String description) {
            this.code = code;
            this.description = description;
        }

        public int getCode() { return code; }
        public String getDescription() { return description; }
    }

    // ç—…æ¯’æ‰«æçŠ¶æ€æšä¸¾
    public enum VirusScanStatus {
        NOT_SCANNED(0, "æœªæ‰«æ"),
        SAFE(1, "å®‰å…¨"),
        THREAT(2, "å¨èƒ");

        private final int code;
        private final String description;

        VirusScanStatus(int code, String description) {
            this.code = code;
            this.description = description;
        }

        public int getCode() { return code; }
        public String getDescription() { return description; }
    }

    // å­˜å‚¨ç±»å‹æšä¸¾
    public enum StorageType {
        LOCAL("local", "æœ¬åœ°å­˜å‚¨"),
        OSS("oss", "é˜¿é‡Œäº‘OSS"),
        MINIO("minio", "MinIO");

        private final String code;
        private final String description;

        StorageType(String code, String description) {
            this.code = code;
            this.description = description;
        }

        public String getCode() { return code; }
        public String getDescription() { return description; }
    }
}
```

## ğŸ“ é…ç½®æ–‡ä»¶

### 1. æ–‡ä»¶ä¸Šä¼ é…ç½®

```yaml
# application.yml æ–°å¢é…ç½®
campus:
  file:
    # åŸºç¡€é…ç½®
    upload-path: /data/campus/uploads/
    temp-path: /data/campus/temp/
    max-file-size: 100MB
    max-request-size: 500MB
    
    # å…è®¸çš„æ–‡ä»¶ç±»å‹
    allowed-types:
      - jpg
      - jpeg
      - png
      - gif
      - bmp
      - pdf
      - doc
      - docx
      - xls
      - xlsx
      - ppt
      - pptx
      - txt
      - zip
      - rar
      - 7z
      - mp4
      - avi
      - mov
    
    # ç¦æ­¢çš„æ–‡ä»¶ç±»å‹
    forbidden-types:
      - exe
      - bat
      - cmd
      - com
      - scr
      - vbs
      - js
      - jar
    
    # å­˜å‚¨é…ç½®
    storage:
      type: local  # local, oss, minio
      local:
        base-path: /data/campus/uploads/
        url-prefix: /files/
      oss:
        endpoint: https://oss-cn-hangzhou.aliyuncs.com
        bucket: campus-files
        access-key-id: ${OSS_ACCESS_KEY_ID}
        access-key-secret: ${OSS_ACCESS_KEY_SECRET}
      minio:
        endpoint: http://localhost:9000
        bucket: campus-files
        access-key: ${MINIO_ACCESS_KEY}
        secret-key: ${MINIO_SECRET_KEY}
    
    # å®‰å…¨é…ç½®
    security:
      enable-virus-scan: true
      virus-scan-timeout: 30000  # 30ç§’
      enable-content-check: true
      max-filename-length: 255
      enable-watermark: false
    
    # ç¼“å­˜é…ç½®
    cache:
      enable-file-cache: true
      cache-expire-time: 3600  # 1å°æ—¶
      max-cache-size: 1GB
    
    # æ¸…ç†é…ç½®
    cleanup:
      enable-auto-cleanup: true
      temp-file-expire: 86400  # 24å°æ—¶
      deleted-file-retain: 2592000  # 30å¤©
      cleanup-schedule: "0 2 * * *"  # æ¯å¤©å‡Œæ™¨2ç‚¹
```

## ğŸ”§ æœåŠ¡å±‚å®ç°

### 1. æ–‡ä»¶æœåŠ¡æ¥å£

```java
// ä½ç½®ï¼šsrc/main/java/com/campus/application/service/FileService.java
package com.campus.application.service;

import com.campus.domain.entity.system.FileInfo;
import org.springframework.web.multipart.MultipartFile;
import jakarta.servlet.http.HttpServletResponse;

import java.util.List;

public interface FileService {

    /**
     * ä¸Šä¼ æ–‡ä»¶
     */
    FileUploadResult uploadFile(MultipartFile file, String businessType, String businessId);

    /**
     * æ‰¹é‡ä¸Šä¼ æ–‡ä»¶
     */
    List<FileUploadResult> batchUploadFiles(List<MultipartFile> files, String businessType, String businessId);

    /**
     * ä¸‹è½½æ–‡ä»¶
     */
    void downloadFile(Long fileId, HttpServletResponse response);

    /**
     * é¢„è§ˆæ–‡ä»¶
     */
    void previewFile(Long fileId, HttpServletResponse response);

    /**
     * åˆ é™¤æ–‡ä»¶
     */
    boolean deleteFile(Long fileId);

    /**
     * æ‰¹é‡åˆ é™¤æ–‡ä»¶
     */
    BatchOperationResult batchDeleteFiles(List<Long> fileIds);

    /**
     * è·å–ä¸šåŠ¡ç›¸å…³æ–‡ä»¶
     */
    List<FileInfo> getFilesByBusiness(String businessType, String businessId);

    /**
     * è·å–æ–‡ä»¶ä¿¡æ¯
     */
    FileInfo getFileInfo(Long fileId);

    /**
     * æ›´æ–°æ–‡ä»¶ä¿¡æ¯
     */
    FileInfo updateFileInfo(Long fileId, UpdateFileRequest request);

    /**
     * æ–‡ä»¶æœç´¢
     */
    PageResult<FileInfo> searchFiles(FileSearchQuery query);

    /**
     * è·å–æ–‡ä»¶è®¿é—®URL
     */
    String getFileAccessUrl(Long fileId, Integer expireMinutes);
}
```

### 2. æ–‡ä»¶ä¸Šä¼ ç»“æœç±»

```java
// ä½ç½®ï¼šsrc/main/java/com/campus/application/dto/FileUploadResult.java
package com.campus.application.dto;

import lombok.Data;
import lombok.Builder;

@Data
@Builder
public class FileUploadResult {
    private boolean success;
    private String message;
    private Long fileId;
    private String fileName;
    private String fileUrl;
    private Long fileSize;
    private String fileType;
    private String md5Hash;
    private String errorCode;
}
```

### 3. æ–‡ä»¶æœåŠ¡å®ç°

```java
// ä½ç½®ï¼šsrc/main/java/com/campus/application/service/impl/FileServiceImpl.java
package com.campus.application.service.impl;

import com.campus.application.service.FileService;
import com.campus.domain.entity.system.FileInfo;
import com.campus.domain.repository.FileInfoRepository;
import com.campus.shared.util.FileUtil;
import com.campus.shared.util.SecurityUtil;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;

import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.time.LocalDateTime;
import java.util.UUID;

@Slf4j
@Service
@RequiredArgsConstructor
public class FileServiceImpl implements FileService {

    private final FileInfoRepository fileInfoRepository;
    private final FilePermissionService filePermissionService;
    private final VirusScanService virusScanService;

    @Value("${campus.file.upload-path}")
    private String uploadPath;

    @Value("${campus.file.max-file-size}")
    private long maxFileSize;

    @Override
    @Transactional
    public FileUploadResult uploadFile(MultipartFile file, String businessType, String businessId) {
        try {
            // 1. æ–‡ä»¶éªŒè¯
            validateFile(file);

            // 2. ç”Ÿæˆå­˜å‚¨æ–‡ä»¶å
            String storedFileName = generateStoredFileName(file.getOriginalFilename());

            // 3. åˆ›å»ºå­˜å‚¨è·¯å¾„
            String relativePath = createStoragePath(businessType, businessId);
            Path fullPath = Paths.get(uploadPath, relativePath);
            Files.createDirectories(fullPath.getParent());

            // 4. ä¿å­˜æ–‡ä»¶
            Path filePath = fullPath.resolve(storedFileName);
            file.transferTo(filePath.toFile());

            // 5. è®¡ç®—æ–‡ä»¶å“ˆå¸Œ
            String md5Hash = FileUtil.calculateMD5(filePath.toFile());
            String sha256Hash = FileUtil.calculateSHA256(filePath.toFile());

            // 6. ç—…æ¯’æ‰«æ
            boolean virusScanResult = virusScanService.scanFile(filePath.toFile());

            // 7. ä¿å­˜æ–‡ä»¶ä¿¡æ¯
            FileInfo fileInfo = createFileInfo(file, storedFileName, relativePath + "/" + storedFileName,
                                             md5Hash, sha256Hash, businessType, businessId, virusScanResult);
            fileInfo = fileInfoRepository.save(fileInfo);

            // 8. è®¾ç½®é»˜è®¤æƒé™
            filePermissionService.setDefaultPermissions(fileInfo.getId(), SecurityUtil.getCurrentUserId());

            return FileUploadResult.builder()
                    .success(true)
                    .message("æ–‡ä»¶ä¸Šä¼ æˆåŠŸ")
                    .fileId(fileInfo.getId())
                    .fileName(fileInfo.getFileName())
                    .fileUrl(generateFileUrl(fileInfo))
                    .fileSize(fileInfo.getFileSize())
                    .fileType(fileInfo.getFileType())
                    .md5Hash(fileInfo.getMd5Hash())
                    .build();

        } catch (Exception e) {
            log.error("æ–‡ä»¶ä¸Šä¼ å¤±è´¥", e);
            return FileUploadResult.builder()
                    .success(false)
                    .message("æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼š" + e.getMessage())
                    .errorCode("UPLOAD_FAILED")
                    .build();
        }
    }

    private void validateFile(MultipartFile file) {
        if (file.isEmpty()) {
            throw new IllegalArgumentException("æ–‡ä»¶ä¸èƒ½ä¸ºç©º");
        }

        if (file.getSize() > maxFileSize) {
            throw new IllegalArgumentException("æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶");
        }

        String fileName = file.getOriginalFilename();
        if (fileName == null || fileName.trim().isEmpty()) {
            throw new IllegalArgumentException("æ–‡ä»¶åä¸èƒ½ä¸ºç©º");
        }

        String fileExtension = FileUtil.getFileExtension(fileName);
        if (!FileUtil.isAllowedFileType(fileExtension)) {
            throw new IllegalArgumentException("ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼š" + fileExtension);
        }

        if (FileUtil.isForbiddenFileType(fileExtension)) {
            throw new IllegalArgumentException("ç¦æ­¢ä¸Šä¼ çš„æ–‡ä»¶ç±»å‹ï¼š" + fileExtension);
        }
    }

    private String generateStoredFileName(String originalFileName) {
        String extension = FileUtil.getFileExtension(originalFileName);
        return UUID.randomUUID().toString().replace("-", "") + "." + extension;
    }

    private String createStoragePath(String businessType, String businessId) {
        LocalDateTime now = LocalDateTime.now();
        return String.format("%s/%s/%d/%02d/%02d",
                businessType != null ? businessType : "general",
                businessId != null ? businessId : "common",
                now.getYear(), now.getMonthValue(), now.getDayOfMonth());
    }
}
```

## ğŸ® æ§åˆ¶å™¨å®ç°

### 1. æ–‡ä»¶ç®¡ç†æ§åˆ¶å™¨

```java
// ä½ç½®ï¼šsrc/main/java/com/campus/interfaces/rest/v1/system/FileApiController.java
package com.campus.interfaces.rest.v1.system;

import com.campus.application.service.FileService;
import com.campus.shared.response.ApiResponse;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import jakarta.servlet.http.HttpServletResponse;
import java.util.List;

@Tag(name = "æ–‡ä»¶ç®¡ç†", description = "æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ã€ç‰ˆæœ¬ç®¡ç†ç­‰åŠŸèƒ½")
@RestController
@RequestMapping("/api/v1/files")
@RequiredArgsConstructor
public class FileApiController {

    private final FileService fileService;

    @Operation(summary = "ä¸Šä¼ æ–‡ä»¶", description = "æ”¯æŒå•ä¸ªæ–‡ä»¶ä¸Šä¼ ")
    @PostMapping(value = "/upload", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    @PreAuthorize("hasAuthority('file:upload')")
    public ResponseEntity<ApiResponse<FileUploadResult>> uploadFile(
            @RequestParam("file") MultipartFile file,
            @RequestParam(value = "businessType", required = false) String businessType,
            @RequestParam(value = "businessId", required = false) String businessId) {

        FileUploadResult result = fileService.uploadFile(file, businessType, businessId);
        return ResponseEntity.ok(ApiResponse.success(result));
    }

    @Operation(summary = "æ‰¹é‡ä¸Šä¼ æ–‡ä»¶", description = "æ”¯æŒå¤šä¸ªæ–‡ä»¶åŒæ—¶ä¸Šä¼ ")
    @PostMapping(value = "/batch-upload", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    @PreAuthorize("hasAuthority('file:upload')")
    public ResponseEntity<ApiResponse<List<FileUploadResult>>> batchUploadFiles(
            @RequestParam("files") List<MultipartFile> files,
            @RequestParam(value = "businessType", required = false) String businessType,
            @RequestParam(value = "businessId", required = false) String businessId) {

        List<FileUploadResult> results = fileService.batchUploadFiles(files, businessType, businessId);
        return ResponseEntity.ok(ApiResponse.success(results));
    }

    @Operation(summary = "ä¸‹è½½æ–‡ä»¶", description = "æ ¹æ®æ–‡ä»¶IDä¸‹è½½æ–‡ä»¶")
    @GetMapping("/download/{fileId}")
    @PreAuthorize("hasAuthority('file:download')")
    public void downloadFile(@PathVariable Long fileId, HttpServletResponse response) {
        fileService.downloadFile(fileId, response);
    }

    @Operation(summary = "é¢„è§ˆæ–‡ä»¶", description = "åœ¨çº¿é¢„è§ˆæ–‡ä»¶å†…å®¹")
    @GetMapping("/preview/{fileId}")
    @PreAuthorize("hasAuthority('file:view')")
    public void previewFile(@PathVariable Long fileId, HttpServletResponse response) {
        fileService.previewFile(fileId, response);
    }

    @Operation(summary = "åˆ é™¤æ–‡ä»¶", description = "æ ¹æ®æ–‡ä»¶IDåˆ é™¤æ–‡ä»¶")
    @DeleteMapping("/{fileId}")
    @PreAuthorize("hasAuthority('file:delete')")
    public ResponseEntity<ApiResponse<Boolean>> deleteFile(@PathVariable Long fileId) {
        boolean result = fileService.deleteFile(fileId);
        return ResponseEntity.ok(ApiResponse.success(result));
    }

    @Operation(summary = "è·å–æ–‡ä»¶ä¿¡æ¯", description = "æ ¹æ®æ–‡ä»¶IDè·å–è¯¦ç»†ä¿¡æ¯")
    @GetMapping("/{fileId}")
    @PreAuthorize("hasAuthority('file:view')")
    public ResponseEntity<ApiResponse<FileInfo>> getFileInfo(@PathVariable Long fileId) {
        FileInfo fileInfo = fileService.getFileInfo(fileId);
        return ResponseEntity.ok(ApiResponse.success(fileInfo));
    }

    @Operation(summary = "è·å–ä¸šåŠ¡æ–‡ä»¶åˆ—è¡¨", description = "æ ¹æ®ä¸šåŠ¡ç±»å‹å’ŒIDè·å–ç›¸å…³æ–‡ä»¶")
    @GetMapping("/business")
    @PreAuthorize("hasAuthority('file:view')")
    public ResponseEntity<ApiResponse<List<FileInfo>>> getFilesByBusiness(
            @RequestParam String businessType,
            @RequestParam String businessId) {

        List<FileInfo> files = fileService.getFilesByBusiness(businessType, businessId);
        return ResponseEntity.ok(ApiResponse.success(files));
    }

    @Operation(summary = "æœç´¢æ–‡ä»¶", description = "æ ¹æ®æ¡ä»¶æœç´¢æ–‡ä»¶")
    @GetMapping("/search")
    @PreAuthorize("hasAuthority('file:view')")
    public ResponseEntity<ApiResponse<PageResult<FileInfo>>> searchFiles(
            @ModelAttribute FileSearchQuery query) {

        PageResult<FileInfo> result = fileService.searchFiles(query);
        return ResponseEntity.ok(ApiResponse.success(result));
    }

    @Operation(summary = "è·å–æ–‡ä»¶è®¿é—®é“¾æ¥", description = "ç”Ÿæˆä¸´æ—¶è®¿é—®é“¾æ¥")
    @GetMapping("/{fileId}/access-url")
    @PreAuthorize("hasAuthority('file:view')")
    public ResponseEntity<ApiResponse<String>> getFileAccessUrl(
            @PathVariable Long fileId,
            @RequestParam(defaultValue = "60") Integer expireMinutes) {

        String url = fileService.getFileAccessUrl(fileId, expireMinutes);
        return ResponseEntity.ok(ApiResponse.success(url));
    }
}
```

## ğŸ“‹ å®æ–½æ£€æŸ¥æ¸…å•

### âœ… ç¬¬ä¸€é˜¶æ®µä»»åŠ¡

- [ ] åˆ›å»ºæ•°æ®åº“è¡¨ç»“æ„
- [ ] å®ç°æ–‡ä»¶å®ä½“ç±»
- [ ] é…ç½®æ–‡ä»¶ä¸Šä¼ å‚æ•°
- [ ] å®ç°æ–‡ä»¶æœåŠ¡æ¥å£
- [ ] å®ç°æ–‡ä»¶æ§åˆ¶å™¨
- [ ] æ·»åŠ æ–‡ä»¶æƒé™éªŒè¯
- [ ] å®ç°ç—…æ¯’æ‰«æåŠŸèƒ½
- [ ] æ·»åŠ æ–‡ä»¶è®¿é—®æ—¥å¿—
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] ç¼–å†™APIæ–‡æ¡£

### ğŸ”§ é…ç½®æ£€æŸ¥

- [ ] æ–‡ä»¶å­˜å‚¨è·¯å¾„é…ç½®
- [ ] æ–‡ä»¶å¤§å°é™åˆ¶é…ç½®
- [ ] å…è®¸æ–‡ä»¶ç±»å‹é…ç½®
- [ ] å®‰å…¨æ‰«æé…ç½®
- [ ] æƒé™æ§åˆ¶é…ç½®

### ğŸ§ª æµ‹è¯•éªŒè¯

- [ ] å•æ–‡ä»¶ä¸Šä¼ æµ‹è¯•
- [ ] æ‰¹é‡æ–‡ä»¶ä¸Šä¼ æµ‹è¯•
- [ ] æ–‡ä»¶ä¸‹è½½æµ‹è¯•
- [ ] æ–‡ä»¶é¢„è§ˆæµ‹è¯•
- [ ] æƒé™æ§åˆ¶æµ‹è¯•
- [ ] ç—…æ¯’æ‰«ææµ‹è¯•
- [ ] æ€§èƒ½å‹åŠ›æµ‹è¯•

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»ï¼š
- æŠ€æœ¯è´Ÿè´£äººï¼š[å§“å]
- é‚®ç®±ï¼š[é‚®ç®±åœ°å€]
- æ–‡æ¡£æ›´æ–°æ—¶é—´ï¼š2025-06-20
