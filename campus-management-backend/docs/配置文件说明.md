# 智慧校园管理系统配置文件说明

## 配置文件结构

### 1. application.yml (主配置文件)
- **作用**: 包含所有环境通用的基础配置
- **默认环境**: 开发环境 (dev)
- **日志级别**: 默认WARN级别，最小化日志输出
- **包含配置**:
  - 服务器配置 (端口8080)
  - 数据源配置
  - JPA/Hibernate配置
  - Thymeleaf模板配置
  - 静态资源配置
  - 文件上传配置
  - JWT配置
  - 自定义业务配置

### 2. application-dev.yml (开发环境)
- **端口**: 8081
- **日志级别**: WARN级别，减少但保留必要的调试信息
- **特殊配置**:
  - Thymeleaf缓存禁用
  - 日志文件: logs/campus-management-dev.log
  - 管理端点: health, info

### 3. application-prod.yml (生产环境)
- **端口**: 8080
- **日志级别**: ERROR级别，极简日志输出
- **特殊配置**:
  - JPA ddl-auto: validate (不自动更新数据库)
  - Hibernate性能优化 (批处理、缓存)
  - Thymeleaf缓存启用
  - 日志文件: logs/campus-management.log
  - 管理端点: 仅health

## 日志级别优化

### 主配置文件 (默认)
```yaml
logging:
  level:
    com.campus: WARN          # 应用程序警告级别
    org.springframework: ERROR # Spring框架错误级别
    org.hibernate: ERROR      # Hibernate错误级别
    root: WARN               # 根日志警告级别
```

### 开发环境
- 应用程序: WARN级别
- 框架组件: ERROR级别
- 日志文件大小: 10MB，保留5个历史文件

### 生产环境
- 所有组件: ERROR级别
- 极简控制台输出格式
- 日志文件大小: 100MB，保留3个历史文件

## 环境切换

### 开发环境启动
```bash
java -jar campus-management.jar --spring.profiles.active=dev
```

### 生产环境启动
```bash
java -jar campus-management.jar --spring.profiles.active=prod
```

## 配置优化效果

1. **减少日志输出**: 所有环境都采用更严格的日志级别
2. **合并重复配置**: 通用配置统一到主文件
3. **环境特定优化**: 
   - 开发环境: 禁用缓存，适度日志
   - 生产环境: 启用缓存，最小日志
4. **性能优化**: 生产环境启用Hibernate批处理和缓存
5. **安全优化**: 生产环境最小化管理端点暴露

## JWT认证配置

### 配置参数说明
```yaml
jwt:
  secret: campus-management-jwt-secret-key-2024  # JWT签名密钥
  expiration: 7200000        # 普通Token过期时间 (2小时)
  refresh-expiration: 604800000  # 刷新Token过期时间 (7天)
  header: Authorization      # Token请求头名称
  prefix: Bearer            # Token前缀
  # 管理后台专用配置
  admin:
    expiration: 14400000     # 管理后台Token过期时间 (4小时)
    auto-refresh: true       # 是否自动刷新Token
    refresh-threshold: 1800000  # 自动刷新阈值 (30分钟)
```

### 认证机制
1. **管理后台** (`/admin/**`): 使用JWT Token认证
   - 登录成功后生成管理后台专用Token (4小时有效期)
   - 支持自动刷新，剩余30分钟时自动刷新
   - 前端JavaScript自动管理Token状态

2. **API接口** (`/api/**`): 使用标准JWT Token认证
   - 普通Token (2小时有效期)
   - 支持手动刷新

### Token管理API
- `GET /admin/token-status` - 获取Token状态信息
- `POST /admin/refresh-token` - 手动刷新Token
- `GET /admin/current-user` - 获取当前用户信息

### 前端集成
在管理后台模板中引入JWT管理器：
```html
<script src="/js/jwt-manager.js"></script>
```

## 注意事项

1. 默认激活开发环境，生产部署时需要显式指定prod环境
2. 生产环境使用validate模式，需要手动管理数据库结构变更
3. 日志文件会自动创建在项目根目录的logs文件夹中
4. 如需临时启用SQL日志调试，可以在对应环境文件中设置 `show-sql: true`
5. **JWT Token过期时间可通过配置文件调整**
6. 管理后台支持Token自动刷新，无需手动重新登录
7. Token过期后会自动跳转到登录页面
