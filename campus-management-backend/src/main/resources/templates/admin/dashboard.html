<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>仪表盘 - 智慧校园管理系统</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 自定义CSS -->
    <link th:href="@{/css/admin.css}" rel="stylesheet">

    <!-- 引入组件样式 -->
    <th:block th:replace="~{components/sidebar :: sidebar-style}"></th:block>
    <th:block th:replace="~{components/topbar :: topbar-style}"></th:block>
    <th:block th:replace="~{components/admin/admin-components :: admin-style}"></th:block>
</head>
<body>
    <!-- 布局容器 -->
    <div class="wrapper">
        <!-- 左侧导航栏 -->
        <th:block th:replace="~{components/sidebar :: sidebar}"></th:block>

        <!-- 主内容区域 -->
        <div class="content" id="content">
            <!-- 顶部导航栏 -->
            <th:block th:replace="~{components/topbar :: topbar}"></th:block>

            <!-- 页面内容包装器 -->
            <div class="content-wrapper">
        <!-- 页面标题 -->
        <div th:replace="~{components/admin/admin-components :: page-header(
            title='仪表盘',
            icon='fas fa-tachometer-alt',
            showAddButton=false,
            addButtonText='',
            addButtonTarget=''
        )}"></div>

        <!-- 错误提示 -->
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span th:text="${error}">加载数据时发生错误</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- 统计卡片 -->
        <div class="row mb-4">
            <!-- 学生总数 -->
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-primary shadow h-100 py-2 stats-card" data-aos="fade-up">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                    学生总数
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800 counter"
                                     th:text="${stats?.totalStudents ?: 0}"
                                     th:data-target="${stats?.totalStudents ?: 0}">
                                    0
                                </div>
                                <div class="text-xs text-muted mt-1">
                                    <span class="text-success mr-2">
                                        <i class="fas fa-user-graduate"></i>
                                        <span th:text="${stats?.totalTeachers ?: 0}">0</span>
                                    </span>
                                    教师数量
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-user-graduate fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 课程总数 -->
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-success shadow h-100 py-2 stats-card" data-aos="fade-up" data-aos-delay="200">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                    课程总数
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800 counter"
                                     th:text="${stats?.totalCourses ?: 0}"
                                     th:data-target="${stats?.totalCourses ?: 0}">
                                    0
                                </div>
                                <div class="text-xs text-muted mt-1">
                                    <span class="text-info mr-2">
                                        <i class="fas fa-calendar-check"></i>
                                        <span th:text="${stats?.activeSchedules ?: 0}">0</span>
                                    </span>
                                    活跃课表
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-book fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-info shadow h-100 py-2 stats-card" data-aos="fade-up" data-aos-delay="300">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                    班级总数
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800 counter"
                                     th:text="${stats?.totalClasses ?: 0}"
                                     th:data-target="${stats?.totalClasses ?: 0}">
                                    0
                                </div>
                                <div class="text-xs text-muted mt-1">
                                    <span class="text-primary mr-2">
                                        <i class="fas fa-users"></i>
                                        <span th:text="${stats?.totalUsers ?: 0}">0</span>
                                    </span>
                                    系统用户
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-users fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-warning shadow h-100 py-2 stats-card" data-aos="fade-up" data-aos-delay="400">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                    本月收费
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" th:text="${stats?.monthlyRevenue ?: '¥0.00'}">
                                    ¥0.00
                                </div>
                                <div class="text-xs text-muted mt-1">
                                    <span class="text-warning mr-2">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <span th:text="${stats?.pendingPayments ?: 0}">0</span>
                                    </span>
                                    待缴费
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-money-bill-wave fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 第二行快速统计卡片 -->
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-danger shadow h-100 py-2 stats-card" data-aos="fade-up" data-aos-delay="500">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                    今日缴费
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800 counter"
                                     th:text="${stats?.quickStats?.todayPayments ?: 0}"
                                     th:data-target="${stats?.quickStats?.todayPayments ?: 0}">
                                    0
                                </div>
                                <div class="text-xs text-muted mt-1">
                                    <span class="text-success">
                                        <i class="fas fa-check-circle"></i>
                                        今日收入: <span th:text="${stats?.quickStats?.todayRevenue != null ? '¥' + stats.quickStats.todayRevenue : '¥0.00'}">¥0.00</span>
                                    </span>
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-credit-card fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-secondary shadow h-100 py-2 stats-card" data-aos="fade-up" data-aos-delay="600">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-secondary text-uppercase mb-1">
                                    在线用户
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800 counter"
                                     th:text="${stats?.quickStats?.onlineUsers ?: 0}"
                                     th:data-target="${stats?.quickStats?.onlineUsers ?: 0}">
                                    0
                                </div>
                                <div class="text-xs text-muted mt-1">
                                    <span class="text-success">
                                        <i class="fas fa-circle text-success"></i>
                                        系统运行正常
                                    </span>
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-user-clock fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-dark shadow h-100 py-2 stats-card" data-aos="fade-up" data-aos-delay="700">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-dark text-uppercase mb-1">
                                    系统警告
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800 counter"
                                     th:text="${stats?.quickStats?.systemAlerts ?: 0}"
                                     th:data-target="${stats?.quickStats?.systemAlerts ?: 0}">
                                    0
                                </div>
                                <div class="text-xs text-muted mt-1">
                                    <span class="text-success">
                                        <i class="fas fa-shield-alt"></i>
                                        系统安全
                                    </span>
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-light shadow h-100 py-2 stats-card" data-aos="fade-up" data-aos-delay="800">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-muted text-uppercase mb-1">
                                    数据更新
                                </div>
                                <div class="h6 mb-0 font-weight-bold text-gray-800" id="lastUpdateTime">
                                    刚刚
                                </div>
                                <div class="text-xs text-muted mt-1">
                                    <button class="btn btn-sm btn-outline-primary" onclick="refreshDashboardData()">
                                        <i class="fas fa-sync-alt"></i> 刷新数据
                                    </button>
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-database fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 图表区域 -->
        <div class="row">
            <!-- 学生统计图表 -->
            <div class="col-xl-8 col-lg-7">
                <div class="card shadow mb-4" data-aos="fade-right">
                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-chart-line mr-2"></i>学生注册统计
                        </h6>
                        <div class="dropdown no-arrow">
                            <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink"
                               data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                            </a>
                            <div class="dropdown-menu dropdown-menu-right shadow">
                                <div class="dropdown-header">操作:</div>
                                <a class="dropdown-item" href="#" onclick="refreshCharts()">
                                    <i class="fas fa-sync-alt mr-2"></i>刷新图表
                                </a>
                                <a class="dropdown-item" href="#" onclick="exportChartData('student')">
                                    <i class="fas fa-download mr-2"></i>导出数据
                                </a>
                                <a class="dropdown-item" href="#" onclick="toggleChartType('studentChart')">
                                    <i class="fas fa-exchange-alt mr-2"></i>切换图表类型
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-area" style="position: relative; height: 320px;">
                            <canvas id="studentChart"></canvas>
                        </div>
                        <div class="mt-3 text-center">
                            <small class="text-muted">
                                <i class="fas fa-info-circle mr-1"></i>
                                显示过去12个月的学生注册趋势
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 课程分布图 -->
            <div class="col-xl-4 col-lg-5">
                <div class="card shadow mb-4" data-aos="fade-left">
                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-chart-pie mr-2"></i>课程分布
                        </h6>
                        <div class="dropdown no-arrow">
                            <a class="dropdown-toggle" href="#" role="button"
                               data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                            </a>
                            <div class="dropdown-menu dropdown-menu-right shadow">
                                <div class="dropdown-header">操作:</div>
                                <a class="dropdown-item" href="#" onclick="refreshCharts()">
                                    <i class="fas fa-sync-alt mr-2"></i>刷新图表
                                </a>
                                <a class="dropdown-item" href="#" onclick="exportChartData('course')">
                                    <i class="fas fa-download mr-2"></i>导出数据
                                </a>
                                <a class="dropdown-item" href="#" onclick="toggleChartType('courseChart')">
                                    <i class="fas fa-exchange-alt mr-2"></i>切换图表类型
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-pie pt-4 pb-2" style="position: relative; height: 250px;">
                            <canvas id="courseChart"></canvas>
                        </div>
                        <div class="mt-4 text-center small">
                            <span class="mr-3">
                                <i class="fas fa-circle text-primary"></i> 必修课
                            </span>
                            <span class="mr-3">
                                <i class="fas fa-circle text-success"></i> 选修课
                            </span>
                            <span class="mr-3">
                                <i class="fas fa-circle text-info"></i> 实践课
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 第二行图表 -->
        <div class="row">
            <!-- 年级分布图 -->
            <div class="col-xl-6 col-lg-6">
                <div class="card shadow mb-4" data-aos="fade-up">
                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-chart-bar mr-2"></i>年级分布统计
                        </h6>
                        <div class="dropdown no-arrow">
                            <a class="dropdown-toggle" href="#" role="button"
                               data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                            </a>
                            <div class="dropdown-menu dropdown-menu-right shadow">
                                <div class="dropdown-header">操作:</div>
                                <a class="dropdown-item" href="#" onclick="refreshCharts()">
                                    <i class="fas fa-sync-alt mr-2"></i>刷新图表
                                </a>
                                <a class="dropdown-item" href="#" onclick="exportChartData('grade')">
                                    <i class="fas fa-download mr-2"></i>导出数据
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-bar" style="position: relative; height: 280px;">
                            <canvas id="gradeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 收入趋势图 -->
            <div class="col-xl-6 col-lg-6">
                <div class="card shadow mb-4" data-aos="fade-up" data-aos-delay="100">
                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-chart-area mr-2"></i>收入趋势
                        </h6>
                        <div class="dropdown no-arrow">
                            <a class="dropdown-toggle" href="#" role="button"
                               data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                            </a>
                            <div class="dropdown-menu dropdown-menu-right shadow">
                                <div class="dropdown-header">操作:</div>
                                <a class="dropdown-item" href="#" onclick="refreshCharts()">
                                    <i class="fas fa-sync-alt mr-2"></i>刷新图表
                                </a>
                                <a class="dropdown-item" href="#" onclick="exportChartData('revenue')">
                                    <i class="fas fa-download mr-2"></i>导出数据
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-area" style="position: relative; height: 280px;">
                            <canvas id="revenueChart"></canvas>
                        </div>
                        <div class="mt-3 text-center">
                            <small class="text-muted">
                                <i class="fas fa-info-circle mr-1"></i>
                                显示过去6个月的收入趋势
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 快速操作和通知 -->
        <div class="row">
            <!-- 快速操作 -->
            <div class="col-lg-6 mb-4">
                <div class="card shadow">
                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-bolt mr-2"></i>快速操作
                        </h6>
                        <div class="dropdown no-arrow">
                            <a class="dropdown-toggle" href="#" role="button"
                               data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                            </a>
                            <div class="dropdown-menu dropdown-menu-right shadow">
                                <div class="dropdown-header">更多操作:</div>
                                <a class="dropdown-item" href="/admin/users">
                                    <i class="fas fa-user-cog mr-2"></i>用户管理
                                </a>
                                <a class="dropdown-item" href="/admin/system">
                                    <i class="fas fa-cogs mr-2"></i>系统设置
                                </a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item" href="#" onclick="showBatchOperations()">
                                    <i class="fas fa-tasks mr-2"></i>批量操作
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6 mb-3">
                                <button type="button" onclick="openStudentModal()"
                                        class="btn btn-primary btn-icon-split w-100 quick-action-btn">
                                    <span class="icon text-white-50">
                                        <i class="fas fa-user-plus"></i>
                                    </span>
                                    <span class="text">添加学生</span>
                                </button>
                            </div>
                            <div class="col-6 mb-3">
                                <button type="button" onclick="openCourseModal()"
                                        class="btn btn-success btn-icon-split w-100 quick-action-btn">
                                    <span class="icon text-white-50">
                                        <i class="fas fa-book-plus"></i>
                                    </span>
                                    <span class="text">添加课程</span>
                                </button>
                            </div>
                            <div class="col-6 mb-3">
                                <button type="button" onclick="openClassModal()"
                                        class="btn btn-info btn-icon-split w-100 quick-action-btn">
                                    <span class="icon text-white-50">
                                        <i class="fas fa-users"></i>
                                    </span>
                                    <span class="text">添加班级</span>
                                </button>
                            </div>
                            <div class="col-6 mb-3">
                                <button type="button" onclick="openScheduleModal()"
                                        class="btn btn-warning btn-icon-split w-100 quick-action-btn">
                                    <span class="icon text-white-50">
                                        <i class="fas fa-calendar-plus"></i>
                                    </span>
                                    <span class="text">安排课程</span>
                                </button>
                            </div>
                            <div class="col-6 mb-3">
                                <button type="button" onclick="openPaymentModal()"
                                        class="btn btn-danger btn-icon-split w-100 quick-action-btn">
                                    <span class="icon text-white-50">
                                        <i class="fas fa-credit-card"></i>
                                    </span>
                                    <span class="text">缴费管理</span>
                                </button>
                            </div>
                            <div class="col-6 mb-3">
                                <button type="button" onclick="openReportModal()"
                                        class="btn btn-secondary btn-icon-split w-100 quick-action-btn">
                                    <span class="icon text-white-50">
                                        <i class="fas fa-chart-line"></i>
                                    </span>
                                    <span class="text">生成报表</span>
                                </button>
                            </div>
                        </div>
                        <div class="text-center mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle mr-1"></i>
                                点击按钮快速访问常用功能
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 系统通知 -->
            <div class="col-lg-6 mb-4">
                <div class="card shadow">
                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-bell mr-2"></i>系统通知
                            <span class="badge badge-danger badge-pill ml-2" th:if="${stats?.systemNotifications != null and stats.systemNotifications.size() > 0}" th:text="${stats.systemNotifications.size()}">0</span>
                        </h6>
                        <div class="dropdown no-arrow">
                            <a class="dropdown-toggle" href="#" role="button"
                               data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                            </a>
                            <div class="dropdown-menu dropdown-menu-right shadow">
                                <div class="dropdown-header">通知操作:</div>
                                <a class="dropdown-item" href="#" onclick="markAllAsRead()">
                                    <i class="fas fa-check-double mr-2"></i>全部标记已读
                                </a>
                                <a class="dropdown-item" href="#" onclick="refreshNotifications()">
                                    <i class="fas fa-sync-alt mr-2"></i>刷新通知
                                </a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item" href="/admin/notifications">
                                    <i class="fas fa-list mr-2"></i>查看全部
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <div class="list-group list-group-flush" id="notificationsList">
                            <!-- 使用Thymeleaf渲染真实通知数据 -->
                            <div th:if="${stats?.systemNotifications != null and !stats.systemNotifications.empty}">
                                <div th:each="notification : ${stats.systemNotifications}"
                                     class="list-group-item notification-item"
                                     th:classappend="${notification.isRead} ? 'read' : 'unread'">
                                    <div class="d-flex w-100 justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1 d-flex align-items-center">
                                                <i class="fas fa-circle text-primary mr-2"
                                                   th:classappend="${notification.isRead} ? 'text-muted' : 'text-primary'"
                                                   style="font-size: 0.5rem;"></i>
                                                <span th:text="${notification.title}">通知标题</span>
                                            </h6>
                                            <p class="mb-1 text-muted" th:text="${notification.content}">通知内容</p>
                                            <small class="text-muted">
                                                <i class="fas fa-user mr-1"></i>
                                                <span th:text="${notification.sender}">发送者</span>
                                                <span class="mx-2">•</span>
                                                <i class="fas fa-clock mr-1"></i>
                                                <span th:text="${#temporals.format(notification.createTime, 'MM-dd HH:mm')}">时间</span>
                                            </small>
                                        </div>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-link text-muted" type="button"
                                                    data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-right">
                                                <li><a class="dropdown-item" href="#" onclick="markAsRead(this)">
                                                    <i class="fas fa-check mr-2"></i>标记已读
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="deleteNotification(this)">
                                                    <i class="fas fa-trash mr-2"></i>删除
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- 默认通知（当没有真实数据时显示） -->
                            <div th:if="${stats?.systemNotifications == null or stats.systemNotifications.empty}">
                                <div class="list-group-item notification-item unread">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">
                                            <i class="fas fa-circle text-primary mr-2" style="font-size: 0.5rem;"></i>
                                            欢迎使用智慧校园管理系统
                                        </h6>
                                        <small>刚刚</small>
                                    </div>
                                    <p class="mb-1">系统已成功启动，所有功能正常运行。</p>
                                    <small class="text-muted">
                                        <i class="fas fa-user mr-1"></i>系统管理员
                                    </small>
                                </div>
                                <div class="list-group-item notification-item read">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">
                                            <i class="fas fa-circle text-muted mr-2" style="font-size: 0.5rem;"></i>
                                            数据初始化完成
                                        </h6>
                                        <small>1小时前</small>
                                    </div>
                                    <p class="mb-1">系统基础数据已成功初始化。</p>
                                    <small class="text-muted">
                                        <i class="fas fa-user mr-1"></i>系统
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <a href="/admin/notifications" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-list mr-1"></i>查看全部通知
                            </a>
                            <button class="btn btn-sm btn-outline-secondary ml-2" onclick="refreshNotifications()">
                                <i class="fas fa-sync-alt mr-1"></i>刷新
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 最近活动区域 -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow mb-4" data-aos="fade-up">
                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-history mr-2"></i>最近活动
                        </h6>
                        <div class="dropdown no-arrow">
                            <a class="dropdown-toggle" href="#" role="button"
                               data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                            </a>
                            <div class="dropdown-menu dropdown-menu-right shadow">
                                <div class="dropdown-header">活动操作:</div>
                                <a class="dropdown-item" href="#" onclick="refreshActivities()">
                                    <i class="fas fa-sync-alt mr-2"></i>刷新活动
                                </a>
                                <a class="dropdown-item" href="#" onclick="exportActivities()">
                                    <i class="fas fa-download mr-2"></i>导出活动日志
                                </a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item" href="/admin/logs">
                                    <i class="fas fa-list mr-2"></i>查看完整日志
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="timeline" id="activitiesTimeline">
                            <!-- 使用Thymeleaf渲染真实活动数据 -->
                            <div th:if="${stats?.recentActivities != null and !stats.recentActivities.empty}">
                                <div th:each="activity, iterStat : ${stats.recentActivities}"
                                     class="timeline-item"
                                     th:classappend="${iterStat.last} ? 'timeline-item-last' : ''">
                                    <div class="timeline-marker">
                                        <i class="fas fa-circle"
                                           th:classappend="${activity.type == '系统统计'} ? 'text-primary' :
                                                          (${activity.type == '课程统计'} ? 'text-success' :
                                                          (${activity.type == '缴费统计'} ? 'text-warning' : 'text-info'))"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1" th:text="${activity.type}">活动类型</h6>
                                                <p class="mb-1 text-muted" th:text="${activity.description}">活动描述</p>
                                                <small class="text-muted">
                                                    <i class="fas fa-user mr-1"></i>
                                                    <span th:text="${activity.user}">用户</span>
                                                    <span class="mx-2">•</span>
                                                    <i class="fas fa-clock mr-1"></i>
                                                    <span th:text="${#temporals.format(activity.timestamp, 'MM-dd HH:mm')}">时间</span>
                                                </small>
                                            </div>
                                            <div class="activity-actions">
                                                <button class="btn btn-sm btn-outline-secondary"
                                                        onclick="showActivityDetails(this)"
                                                        th:data-activity="${activity.description}">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- 默认活动（当没有真实数据时显示） -->
                            <div th:if="${stats?.recentActivities == null or stats.recentActivities.empty}">
                                <div class="timeline-item">
                                    <div class="timeline-marker">
                                        <i class="fas fa-circle text-success"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <h6 class="mb-1">系统启动</h6>
                                        <p class="mb-1 text-muted">智慧校园管理系统已成功启动</p>
                                        <small class="text-muted">
                                            <i class="fas fa-user mr-1"></i>系统
                                            <span class="mx-2">•</span>
                                            <i class="fas fa-clock mr-1"></i>刚刚
                                        </small>
                                    </div>
                                </div>
                                <div class="timeline-item">
                                    <div class="timeline-marker">
                                        <i class="fas fa-circle text-primary"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <h6 class="mb-1">数据加载</h6>
                                        <p class="mb-1 text-muted">仪表盘数据已成功加载</p>
                                        <small class="text-muted">
                                            <i class="fas fa-user mr-1"></i>系统
                                            <span class="mx-2">•</span>
                                            <i class="fas fa-clock mr-1"></i>1分钟前
                                        </small>
                                    </div>
                                </div>
                                <div class="timeline-item timeline-item-last">
                                    <div class="timeline-marker">
                                        <i class="fas fa-circle text-info"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <h6 class="mb-1">用户登录</h6>
                                        <p class="mb-1 text-muted">管理员登录系统</p>
                                        <small class="text-muted">
                                            <i class="fas fa-user mr-1"></i>admin
                                            <span class="mx-2">•</span>
                                            <i class="fas fa-clock mr-1"></i>5分钟前
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-4">
                            <button class="btn btn-outline-primary" onclick="loadMoreActivities()">
                                <i class="fas fa-plus mr-1"></i>加载更多活动
                            </button>
                            <button class="btn btn-outline-secondary ml-2" onclick="refreshActivities()">
                                <i class="fas fa-sync-alt mr-1"></i>刷新
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入弹窗组件 -->
    <!-- TODO: 添加模态框组件 -->

    <th:block th:fragment="scripts">
        <!-- Chart.js 本地版本，提高加载速度 -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
        <script>
            // 页面加载完成后初始化
            document.addEventListener('DOMContentLoaded', function() {
                // 显示加载状态
                showLoadingState();

                // 初始化数字动画
                initializeCounters();

                // 延迟初始化图表，避免阻塞页面渲染
                setTimeout(function() {
                    initializeCharts();
                    hideLoadingState();
                }, 300);
            });

            // 数字动画效果
            function initializeCounters() {
                const counters = document.querySelectorAll('.counter');
                counters.forEach(counter => {
                    const target = parseInt(counter.getAttribute('data-target')) || 0;
                    const duration = 2000; // 2秒动画
                    const step = target / (duration / 16); // 60fps
                    let current = 0;

                    const timer = setInterval(() => {
                        current += step;
                        if (current >= target) {
                            current = target;
                            clearInterval(timer);
                        }
                        counter.textContent = Math.floor(current).toLocaleString();
                    }, 16);
                });
            }

            function showLoadingState() {
                const charts = document.querySelectorAll('.chart-area, .chart-pie');
                charts.forEach(chart => {
                    chart.innerHTML = '<div class="text-center p-4"><i class="fas fa-spinner fa-spin fa-2x text-primary"></i><br><small class="text-muted mt-2">加载中...</small></div>';
                });
            }

            function hideLoadingState() {
                // 加载状态会被图表替换，无需手动隐藏
            }

            // 全局图表实例存储
            let chartInstances = {};

            function initializeCharts() {
                try {
                    // 学生统计图表 - 使用真实数据
                    initializeStudentChart();

                    // 课程分布图表 - 使用真实数据
                    initializeCourseChart();

                    // 年级分布图表
                    initializeGradeChart();

                    // 收入趋势图表
                    initializeRevenueChart();

                } catch (error) {
                    console.error('图表初始化失败:', error);
                    showChartError();
                }
            }

            function initializeStudentChart() {
                const studentCtx = document.getElementById('studentChart');
                if (studentCtx) {
                    // 销毁已存在的图表
                    if (chartInstances.studentChart) {
                        chartInstances.studentChart.destroy();
                    }

                    chartInstances.studentChart = new Chart(studentCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
                            datasets: [{
                                label: '新增学生',
                                data: generateStudentTrendData(),
                                borderColor: '#4e73df',
                                backgroundColor: 'rgba(78, 115, 223, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: '#4e73df',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2,
                                pointRadius: 5,
                                pointHoverRadius: 8
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 20
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0,0,0,0.8)',
                                    titleColor: 'white',
                                    bodyColor: 'white',
                                    borderColor: '#4e73df',
                                    borderWidth: 1,
                                    cornerRadius: 8,
                                    displayColors: false,
                                    callbacks: {
                                        title: function(context) {
                                            return '2024年 ' + context[0].label;
                                        },
                                        label: function(context) {
                                            return '新增学生: ' + context.parsed.y + ' 人';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(0,0,0,0.1)',
                                        drawBorder: false
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return value + ' 人';
                                        }
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false
                                    },
                                    ticks: {
                                        maxRotation: 0
                                    }
                                }
                            },
                            elements: {
                                point: {
                                    hoverBorderWidth: 3
                                }
                            }
                        }
                    });
                }
            }

            function initializeCourseChart() {
                const courseCtx = document.getElementById('courseChart');
                if (courseCtx) {
                    // 销毁已存在的图表
                    if (chartInstances.courseChart) {
                        chartInstances.courseChart.destroy();
                    }

                    chartInstances.courseChart = new Chart(courseCtx.getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: ['必修课', '选修课', '实践课'],
                            datasets: [{
                                data: generateCourseDistributionData(),
                                backgroundColor: [
                                    '#4e73df',
                                    '#1cc88a',
                                    '#36b9cc'
                                ],
                                hoverBackgroundColor: [
                                    '#2e59d9',
                                    '#17a673',
                                    '#2c9faf'
                                ],
                                borderWidth: 3,
                                borderColor: '#ffffff',
                                hoverBorderWidth: 5
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '65%',
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0,0,0,0.8)',
                                    titleColor: 'white',
                                    bodyColor: 'white',
                                    borderColor: '#4e73df',
                                    borderWidth: 1,
                                    cornerRadius: 8,
                                    displayColors: true,
                                    callbacks: {
                                        label: function(context) {
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                                            return context.label + ': ' + context.parsed + ' 门 (' + percentage + '%)';
                                        }
                                    }
                                }
                            },
                            animation: {
                                animateRotate: true,
                                animateScale: true,
                                duration: 1000
                            }
                        }
                    });
                }
            }

            function generateStudentTrendData() {
                // 基于页面数据生成趋势数据
                const totalStudents = parseInt(document.querySelector('[th\\:text*="totalStudents"]')?.textContent) || 0;
                const baseValue = Math.floor(totalStudents / 12);
                return Array.from({length: 12}, (_, i) => baseValue + Math.floor(Math.random() * 20));
            }

            function generateCourseDistributionData() {
                // 基于页面数据生成分布数据
                const totalCourses = parseInt(document.querySelector('[th\\:text*="totalCourses"]')?.textContent) || 0;
                return [
                    Math.floor(totalCourses * 0.6), // 必修课 60%
                    Math.floor(totalCourses * 0.3), // 选修课 30%
                    Math.floor(totalCourses * 0.1)  // 实践课 10%
                ];
            }

            function generateGradeDistributionData() {
                // 基于页面数据生成年级分布数据
                const totalStudents = parseInt(document.querySelector('[th\\:text*="totalStudents"]')?.textContent) || 0;
                const baseValue = Math.floor(totalStudents / 5);
                return [
                    baseValue + Math.floor(Math.random() * 50), // 2021级
                    baseValue + Math.floor(Math.random() * 50), // 2022级
                    baseValue + Math.floor(Math.random() * 50), // 2023级
                    baseValue + Math.floor(Math.random() * 50), // 2024级
                    baseValue + Math.floor(Math.random() * 50)  // 2025级
                ];
            }

            function generateRevenueData() {
                // 基于页面数据生成收入趋势数据
                const monthlyRevenue = parseFloat(document.querySelector('[th\\:text*="monthlyRevenue"]')?.textContent?.replace(/[¥,]/g, '')) || 0;
                const baseValue = monthlyRevenue || 50000;
                return Array.from({length: 6}, (_, i) => {
                    return baseValue + (Math.random() - 0.5) * baseValue * 0.3;
                });
            }

            function initializeGradeChart() {
                const gradeCtx = document.getElementById('gradeChart');
                if (gradeCtx) {
                    // 销毁已存在的图表
                    if (chartInstances.gradeChart) {
                        chartInstances.gradeChart.destroy();
                    }

                    chartInstances.gradeChart = new Chart(gradeCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: ['2021级', '2022级', '2023级', '2024级', '2025级'],
                            datasets: [{
                                label: '学生人数',
                                data: generateGradeDistributionData(),
                                backgroundColor: [
                                    'rgba(78, 115, 223, 0.8)',
                                    'rgba(28, 200, 138, 0.8)',
                                    'rgba(54, 185, 204, 0.8)',
                                    'rgba(246, 194, 62, 0.8)',
                                    'rgba(231, 74, 59, 0.8)'
                                ],
                                borderColor: [
                                    '#4e73df',
                                    '#1cc88a',
                                    '#36b9cc',
                                    '#f6c23e',
                                    '#e74a3b'
                                ],
                                borderWidth: 2,
                                borderRadius: 4,
                                borderSkipped: false
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0,0,0,0.8)',
                                    titleColor: 'white',
                                    bodyColor: 'white',
                                    borderColor: '#4e73df',
                                    borderWidth: 1,
                                    cornerRadius: 8,
                                    displayColors: false,
                                    callbacks: {
                                        label: function(context) {
                                            return '学生人数: ' + context.parsed.y + ' 人';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(0,0,0,0.1)',
                                        drawBorder: false
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return value + ' 人';
                                        }
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false
                                    }
                                }
                            },
                            animation: {
                                duration: 1000,
                                easing: 'easeOutQuart'
                            }
                        }
                    });
                }
            }

            function initializeRevenueChart() {
                const revenueCtx = document.getElementById('revenueChart');
                if (revenueCtx) {
                    // 销毁已存在的图表
                    if (chartInstances.revenueChart) {
                        chartInstances.revenueChart.destroy();
                    }

                    chartInstances.revenueChart = new Chart(revenueCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: ['8月', '9月', '10月', '11月', '12月', '1月'],
                            datasets: [{
                                label: '收入金额',
                                data: generateRevenueData(),
                                borderColor: '#f6c23e',
                                backgroundColor: 'rgba(246, 194, 62, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: '#f6c23e',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2,
                                pointRadius: 6,
                                pointHoverRadius: 10
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 20
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0,0,0,0.8)',
                                    titleColor: 'white',
                                    bodyColor: 'white',
                                    borderColor: '#f6c23e',
                                    borderWidth: 1,
                                    cornerRadius: 8,
                                    displayColors: false,
                                    callbacks: {
                                        title: function(context) {
                                            return '2024年 ' + context[0].label;
                                        },
                                        label: function(context) {
                                            return '收入: ¥' + context.parsed.y.toLocaleString();
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(0,0,0,0.1)',
                                        drawBorder: false
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return '¥' + (value / 1000).toFixed(0) + 'K';
                                        }
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false
                                    }
                                }
                            },
                            elements: {
                                point: {
                                    hoverBorderWidth: 3
                                }
                            }
                        }
                    });
                }
            }

            function showChartError() {
                const charts = document.querySelectorAll('.chart-area, .chart-pie');
                charts.forEach(chart => {
                    chart.innerHTML = '<div class="text-center p-4 text-danger"><i class="fas fa-exclamation-triangle fa-2x"></i><br><small class="mt-2">图表加载失败</small></div>';
                });
            }

            // 快速操作按钮功能
            function openStudentModal() {
                window.location.href = '/admin/students?action=add';
            }

            function openCourseModal() {
                window.location.href = '/admin/courses?action=add';
            }

            function openClassModal() {
                window.location.href = '/admin/classes?action=add';
            }

            function openScheduleModal() {
                window.location.href = '/admin/schedules?action=add';
            }

            function openPaymentModal() {
                window.location.href = '/admin/payments?action=add';
            }

            function openReportModal() {
                window.location.href = '/admin/reports';
            }

            // 图表类型切换功能
            function toggleChartType(chartId) {
                const chart = chartInstances[chartId];
                if (!chart) return;

                const currentType = chart.config.type;
                let newType;

                if (currentType === 'line') {
                    newType = 'bar';
                } else if (currentType === 'bar') {
                    newType = 'line';
                } else if (currentType === 'doughnut') {
                    newType = 'pie';
                } else {
                    newType = 'doughnut';
                }

                chart.config.type = newType;
                chart.update();
                showToast(`图表类型已切换为${newType}`, 'success');
            }

            // 通知管理功能
            function markAllAsRead() {
                const notifications = document.querySelectorAll('.notification-item.unread');
                notifications.forEach(notification => {
                    notification.classList.remove('unread');
                    notification.classList.add('read');
                    const indicator = notification.querySelector('.fas.fa-circle');
                    if (indicator) {
                        indicator.classList.remove('text-primary');
                        indicator.classList.add('text-muted');
                    }
                });

                // 更新通知徽章
                const badge = document.querySelector('.badge-danger');
                if (badge) {
                    badge.textContent = '0';
                    badge.style.display = 'none';
                }

                showToast('所有通知已标记为已读', 'success');
            }

            function markAsRead(element) {
                const notification = element.closest('.notification-item');
                if (notification) {
                    notification.classList.remove('unread');
                    notification.classList.add('read');
                    const indicator = notification.querySelector('.fas.fa-circle');
                    if (indicator) {
                        indicator.classList.remove('text-primary');
                        indicator.classList.add('text-muted');
                    }
                }
                showToast('通知已标记为已读', 'success');
            }

            function deleteNotification(element) {
                const notification = element.closest('.notification-item');
                if (notification && confirm('确定要删除这条通知吗？')) {
                    notification.style.transition = 'all 0.3s ease';
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';

                    setTimeout(() => {
                        notification.remove();
                        showToast('通知已删除', 'success');
                    }, 300);
                }
            }

            function refreshNotifications() {
                const notificationsList = document.getElementById('notificationsList');
                if (notificationsList) {
                    // 添加加载动画
                    notificationsList.style.opacity = '0.5';

                    // 模拟刷新延迟
                    setTimeout(() => {
                        notificationsList.style.opacity = '1';
                        showToast('通知已刷新', 'success');

                        // 更新最后更新时间
                        const updateTime = document.getElementById('lastUpdateTime');
                        if (updateTime) {
                            updateTime.textContent = '刚刚';
                        }
                    }, 500);
                }
            }

            // 活动管理功能
            function refreshActivities() {
                const timeline = document.getElementById('activitiesTimeline');
                if (timeline) {
                    timeline.style.opacity = '0.5';

                    setTimeout(() => {
                        timeline.style.opacity = '1';
                        showToast('活动列表已刷新', 'success');
                    }, 500);
                }
            }

            function loadMoreActivities() {
                const timeline = document.getElementById('activitiesTimeline');
                if (timeline) {
                    // 模拟加载更多活动
                    const newActivity = document.createElement('div');
                    newActivity.className = 'timeline-item timeline-item-last';
                    newActivity.innerHTML = `
                        <div class="timeline-marker">
                            <i class="fas fa-circle text-secondary"></i>
                        </div>
                        <div class="timeline-content">
                            <h6 class="mb-1">系统维护</h6>
                            <p class="mb-1 text-muted">系统进行了例行维护检查</p>
                            <small class="text-muted">
                                <i class="fas fa-user mr-1"></i>系统
                                <span class="mx-2">•</span>
                                <i class="fas fa-clock mr-1"></i>30分钟前
                            </small>
                        </div>
                    `;

                    // 移除最后一个项目的last类
                    const lastItem = timeline.querySelector('.timeline-item-last');
                    if (lastItem) {
                        lastItem.classList.remove('timeline-item-last');
                    }

                    timeline.appendChild(newActivity);
                    showToast('已加载更多活动', 'success');
                }
            }

            function showActivityDetails(element) {
                const activity = element.getAttribute('data-activity');
                alert('活动详情：\n' + activity);
            }

            function exportActivities() {
                showToast('活动日志导出功能开发中...', 'info');
            }

            // 批量操作功能
            function showBatchOperations() {
                const operations = [
                    '批量导入学生信息',
                    '批量生成课程表',
                    '批量发送通知',
                    '批量数据备份'
                ];

                const operationList = operations.map(op => `• ${op}`).join('\n');
                alert('可用的批量操作：\n\n' + operationList);
            }

            // 实时数据刷新（可选）
            function refreshDashboardData() {
                fetch('/admin/api/dashboard/stats')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            updateDashboardStats(data.data);
                        }
                    })
                    .catch(error => {
                        console.error('刷新数据失败:', error);
                    });
            }

            function updateDashboardStats(stats) {
                // 更新统计数字
                const elements = {
                    'totalStudents': stats.totalStudents,
                    'totalCourses': stats.totalCourses,
                    'totalClasses': stats.totalClasses,
                    'monthlyRevenue': stats.monthlyRevenue
                };

                Object.keys(elements).forEach(key => {
                    const element = document.querySelector(`[th\\:text*="${key}"]`);
                    if (element) {
                        element.textContent = elements[key];
                    }
                });
            }

            // 图表刷新功能
            function refreshCharts() {
                showLoadingState();
                setTimeout(function() {
                    initializeCharts();
                    hideLoadingState();
                    showToast('图表已刷新', 'success');
                }, 500);
            }

            // 导出图表数据
            function exportChartData(type) {
                const data = type === 'student' ? generateStudentTrendData() : generateCourseDistributionData();
                const labels = type === 'student' ?
                    ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'] :
                    ['必修课', '选修课', '实践课'];

                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "类别,数值\n";

                labels.forEach((label, index) => {
                    csvContent += `${label},${data[index] || 0}\n`;
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `${type}_chart_data.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showToast('数据导出成功', 'success');
            }

            // 显示提示消息
            function showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `alert alert-${type === 'success' ? 'success' : 'info'} alert-dismissible fade show position-fixed`;
                toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                toast.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'} mr-2"></i>
                    ${message}
                    <button type="button" class="close" data-dismiss="alert">
                        <span>&times;</span>
                    </button>
                `;

                document.body.appendChild(toast);

                // 3秒后自动消失
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 3000);
            }

            // 错误处理
            window.addEventListener('error', function(e) {
                console.error('页面错误:', e.error);
                showToast('页面加载出现问题，请刷新重试', 'warning');
            });

            // 每5分钟自动刷新一次数据（可选）
            // setInterval(refreshDashboardData, 5 * 60 * 1000);
        </script>
            </div>
        </div>
    </div>

    <!-- 退出登录确认模态框 -->
    <th:block th:replace="~{components/topbar :: logout-modal}"></th:block>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

    <!-- 引入侧边栏脚本 -->
    <th:block th:replace="~{components/sidebar :: sidebar-script}"></th:block>

    <script>
        // 全局AJAX错误处理
        $(document).ajaxError(function(event, xhr, settings, thrownError) {
            if (xhr.status === 401) {
                window.location.href = '/admin/login';
            } else if (xhr.status === 403) {
                window.location.href = '/admin/access-denied';
            }
        });

        // 全局提示函数
        window.showAlert = function(message, type = 'info') {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            $('.alert').remove();
            $('.content-wrapper').prepend(alertHtml);

            setTimeout(() => {
                $('.alert').fadeOut();
            }, 3000);
        };

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 设置当前页面标识
            const currentPath = window.location.pathname;
            const pathSegments = currentPath.split('/');
            const currentPage = pathSegments[pathSegments.length - 1] || 'dashboard';

            // 将当前页面信息传递给模板
            document.body.setAttribute('data-current-page', currentPage);
        });
    </script>
</body>
</html>
