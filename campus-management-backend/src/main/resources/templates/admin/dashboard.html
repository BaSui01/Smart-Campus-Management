<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{layout/admin :: html}">

<head th:replace="~{layout/admin :: head}">
    <title>仪表盘 - 智慧校园管理系统</title>

    <!-- 页面特定样式 -->
    <th:block th:fragment="page-styles">
        <link th:href="@{/css/admin/dashboard.css}" rel="stylesheet">
        <link th:href="@{/css/components/charts.css}" rel="stylesheet">
        <link th:href="@{/css/components/stats-cards.css}" rel="stylesheet">
    </th:block>
</head>

<body>
    <!-- 页面内容 -->
    <th:block th:fragment="page-content">
        <!-- 页面标题区域 -->
        <div class="page-header-section">
            <div class="d-flex justify-content-between align-items-center">
                <div class="page-title-group">
                    <h1 class="page-title">
                        <i class="fas fa-tachometer-alt me-2 text-primary"></i>
                        仪表盘
                    </h1>
                    <p class="page-subtitle">智慧校园管理系统概览</p>
                </div>

                <!-- 页面操作按钮 -->
                <div class="page-actions">
                    <button type="button" class="btn btn-outline-primary" onclick="Dashboard.refreshData()">
                        <i class="fas fa-sync-alt me-2"></i>刷新数据
                    </button>
                    <button type="button" class="btn btn-outline-info" onclick="Dashboard.runDiagnostics()">
                        <i class="fas fa-stethoscope me-2"></i>系统诊断
                    </button>

                    <!-- 快速操作下拉菜单 -->
                    <div class="dropdown">
                        <button class="btn btn-primary dropdown-toggle" type="button"
                                data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-plus me-2"></i>快速操作
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" th:href="@{/admin/students}">
                                <i class="fas fa-user-graduate me-2"></i>学生管理
                            </a></li>
                            <li><a class="dropdown-item" th:href="@{/admin/courses}">
                                <i class="fas fa-book me-2"></i>课程管理
                            </a></li>
                            <li><a class="dropdown-item" th:href="@{/admin/academic/classes}">
                                <i class="fas fa-users me-2"></i>班级管理
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" th:href="@{/admin/settings}">
                                <i class="fas fa-cogs me-2"></i>系统设置
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="Dashboard.runDiagnostics()">
                                <i class="fas fa-stethoscope me-2"></i>系统诊断
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- 错误提示和加载状态 -->
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>系统错误：</strong>
            <span th:text="${error}">加载数据时发生错误</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- 数据加载状态指示器 -->
        <div id="dataLoadingIndicator" class="loading-state" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">正在加载...</span>
            </div>
            <h5>正在加载仪表盘数据</h5>
            <p>请稍候，正在从服务器获取最新数据...</p>
        </div>

        <!-- 网络错误提示区域 -->
        <div id="networkErrorContainer"></div>

        <!-- 统计卡片 -->
        <div class="row mb-4">
            <!-- 学生总数 -->
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card stats-card h-100 border-0 shadow-sm">
                    <div class="card-body gradient-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="text-white-50 text-uppercase small mb-1">
                                    学生总数
                                </div>
                                <div class="counter text-white"
                                     th:text="${stats?.totalStudents ?: 0}"
                                     th:data-target="${stats?.totalStudents ?: 0}">
                                    0
                                </div>
                                <div class="text-white-50 small mt-2">
                                    <i class="fas fa-chalkboard-teacher me-1"></i>
                                    教师: <span th:text="${stats?.totalTeachers ?: 0}">0</span>
                                </div>
                            </div>
                            <div class="text-white-50">
                                <i class="fas fa-user-graduate fa-3x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 课程总数 -->
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card stats-card h-100 border-0 shadow-sm">
                    <div class="card-body gradient-success text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="text-white-50 text-uppercase small mb-1">
                                    课程总数
                                </div>
                                <div class="counter text-white"
                                     th:text="${stats?.totalCourses ?: 0}"
                                     th:data-target="${stats?.totalCourses ?: 0}">
                                    0
                                </div>
                                <div class="text-white-50 small mt-2">
                                    <i class="fas fa-calendar-check me-1"></i>
                                    活跃: <span th:text="${stats?.activeSchedules ?: 0}">0</span>
                                </div>
                            </div>
                            <div class="text-white-50">
                                <i class="fas fa-book fa-3x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 班级总数 -->
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card stats-card h-100 border-0 shadow-sm">
                    <div class="card-body gradient-info text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="text-white-50 text-uppercase small mb-1">
                                    班级总数
                                </div>
                                <div class="counter text-white"
                                     th:text="${stats?.totalClasses ?: 0}"
                                     th:data-target="${stats?.totalClasses ?: 0}">
                                    0
                                </div>
                                <div class="text-white-50 small mt-2">
                                    <i class="fas fa-user-cog me-1"></i>
                                    用户: <span th:text="${stats?.totalUsers ?: 0}">0</span>
                                </div>
                            </div>
                            <div class="text-white-50">
                                <i class="fas fa-users fa-3x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 本月收费 -->
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card stats-card h-100 border-0 shadow-sm">
                    <div class="card-body gradient-warning text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="text-white-50 text-uppercase small mb-1">
                                    本月收费
                                </div>
                                <div class="h4 mb-0 text-white" th:text="${stats?.monthlyRevenue ?: '¥0.00'}">
                                    ¥0.00
                                </div>
                                <div class="text-white-50 small mt-2">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    待缴: <span th:text="${stats?.pendingPayments ?: 0}">0</span>
                                </div>
                            </div>
                            <div class="text-white-50">
                                <i class="fas fa-money-bill-wave fa-3x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 快速统计信息 -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <div class="text-primary mb-2">
                            <i class="fas fa-credit-card fa-2x"></i>
                        </div>
                        <h5 class="card-title mb-1">今日缴费</h5>
                        <h3 class="text-primary mb-0" th:text="${stats?.quickStats?.todayPayments ?: 0}">0</h3>
                        <small class="text-muted">收入: <span th:text="${stats?.quickStats?.todayRevenue != null ? '¥' + stats.quickStats.todayRevenue : '¥0.00'}">¥0.00</span></small>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <div class="text-success mb-2">
                            <i class="fas fa-user-clock fa-2x"></i>
                        </div>
                        <h5 class="card-title mb-1">在线用户</h5>
                        <h3 class="text-success mb-0" th:text="${stats?.quickStats?.onlineUsers ?: 0}">0</h3>
                        <small class="text-success"><i class="fas fa-circle"></i> 系统正常</small>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <div class="text-warning mb-2">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                        </div>
                        <h5 class="card-title mb-1">系统警告</h5>
                        <h3 class="text-warning mb-0" th:text="${stats?.quickStats?.systemAlerts ?: 0}">0</h3>
                        <small class="text-muted"><i class="fas fa-shield-alt"></i> 系统安全</small>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <div class="text-info mb-2">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                        <h5 class="card-title mb-1">最后更新</h5>
                        <h6 class="text-info mb-0" id="lastUpdateTime">刚刚</h6>
                        <small class="text-muted">数据同步时间</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- 图表区域 -->
        <div class="row mb-4">
            <!-- 学生统计图表 -->
            <div class="col-xl-8 col-lg-7 mb-4">
                <div class="card border-0 shadow-sm chart-container">
                    <div class="card-header bg-white border-0 py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 text-primary">
                                <i class="fas fa-chart-line me-2"></i>学生注册统计
                            </h5>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-cog"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="refreshCharts()">
                                        <i class="fas fa-sync-alt me-2"></i>刷新图表
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportChartData('student')">
                                        <i class="fas fa-download me-2"></i>导出数据
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" onclick="toggleChartType('studentChart')">
                                        <i class="fas fa-exchange-alt me-2"></i>切换图表类型
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-area" style="position: relative; height: 350px;">
                            <canvas id="studentChart"></canvas>
                        </div>
                        <div class="mt-3 text-center">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                显示过去12个月的学生注册趋势
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 课程分布图 -->
            <div class="col-xl-4 col-lg-5 mb-4">
                <div class="card border-0 shadow-sm chart-container">
                    <div class="card-header bg-white border-0 py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 text-primary">
                                <i class="fas fa-chart-pie me-2"></i>课程分布
                            </h5>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-cog"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="refreshCharts()">
                                        <i class="fas fa-sync-alt me-2"></i>刷新图表
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportChartData('course')">
                                        <i class="fas fa-download me-2"></i>导出数据
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" onclick="toggleChartType('courseChart')">
                                        <i class="fas fa-exchange-alt me-2"></i>切换图表类型
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-pie" style="position: relative; height: 280px;">
                            <canvas id="courseChart"></canvas>
                        </div>
                        <div class="mt-3 text-center">
                            <div class="d-flex justify-content-center gap-3 flex-wrap">
                                <span class="badge bg-primary">
                                    <i class="fas fa-circle me-1"></i>必修课
                                </span>
                                <span class="badge bg-success">
                                    <i class="fas fa-circle me-1"></i>选修课
                                </span>
                                <span class="badge bg-info">
                                    <i class="fas fa-circle me-1"></i>实践课
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 第二行图表 -->
        <div class="row mb-4">
            <!-- 年级分布图 -->
            <div class="col-xl-6 col-lg-6 mb-4">
                <div class="card border-0 shadow-sm chart-container">
                    <div class="card-header bg-white border-0 py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 text-primary">
                                <i class="fas fa-chart-bar me-2"></i>年级分布统计
                            </h5>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-cog"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="refreshCharts()">
                                        <i class="fas fa-sync-alt me-2"></i>刷新图表
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportChartData('grade')">
                                        <i class="fas fa-download me-2"></i>导出数据
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-bar" style="position: relative; height: 300px;">
                            <canvas id="gradeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 收入趋势图 -->
            <div class="col-xl-6 col-lg-6 mb-4">
                <div class="card border-0 shadow-sm chart-container">
                    <div class="card-header bg-white border-0 py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 text-primary">
                                <i class="fas fa-chart-area me-2"></i>收入趋势
                            </h5>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-cog"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="refreshCharts()">
                                        <i class="fas fa-sync-alt me-2"></i>刷新图表
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportChartData('revenue')">
                                        <i class="fas fa-download me-2"></i>导出数据
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-area" style="position: relative; height: 300px;">
                            <canvas id="revenueChart"></canvas>
                        </div>
                        <div class="mt-3 text-center">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                显示过去6个月的收入趋势
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 快速操作和通知 -->
        <div class="row">
            <!-- 快速操作 -->
            <div class="col-lg-6 mb-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="mb-0 text-primary">
                            <i class="fas fa-bolt me-2"></i>快速操作
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-6">
                                <a href="/admin/students" class="btn btn-primary w-100 quick-action-btn">
                                    <i class="fas fa-user-graduate d-block mb-2 fa-2x"></i>
                                    <span>学生管理</span>
                                </a>
                            </div>
                            <div class="col-6">
                                <a href="/admin/courses" class="btn btn-success w-100 quick-action-btn">
                                    <i class="fas fa-book d-block mb-2 fa-2x"></i>
                                    <span>课程管理</span>
                                </a>
                            </div>
                            <div class="col-6">
                                <a href="/admin/classes" class="btn btn-info w-100 quick-action-btn">
                                    <i class="fas fa-users d-block mb-2 fa-2x"></i>
                                    <span>班级管理</span>
                                </a>
                            </div>
                            <div class="col-6">
                                <a href="/admin/academic/schedules" class="btn btn-warning w-100 quick-action-btn">
                                    <i class="fas fa-calendar-alt d-block mb-2 fa-2x"></i>
                                    <span>课程安排</span>
                                </a>
                            </div>
                            <div class="col-6">
                                <a href="/admin/payments" class="btn btn-secondary w-100 quick-action-btn">
                                    <i class="fas fa-money-bill-wave d-block mb-2 fa-2x"></i>
                                    <span>缴费管理</span>
                                </a>
                            </div>
                            <div class="col-6">
                                <a href="/admin/settings" class="btn btn-dark w-100 quick-action-btn">
                                    <i class="fas fa-cogs d-block mb-2 fa-2x"></i>
                                    <span>系统设置</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 系统通知 -->
            <div class="col-lg-6 mb-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-0 py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 text-primary">
                                <i class="fas fa-bell me-2"></i>系统通知
                                <span class="badge bg-danger ms-2" th:if="${stats?.systemNotifications != null and stats.systemNotifications.size() > 0}" th:text="${stats.systemNotifications.size()}">0</span>
                            </h5>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-cog"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="markAllAsRead()">
                                        <i class="fas fa-check-double me-2"></i>全部标记已读
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="refreshNotifications()">
                                        <i class="fas fa-sync-alt me-2"></i>刷新通知
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="/admin/notifications">
                                        <i class="fas fa-list me-2"></i>查看全部
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <div class="list-group list-group-flush" id="notificationsList">
                            <!-- 使用Thymeleaf渲染真实通知数据 -->
                            <div th:if="${stats?.systemNotifications != null and !stats.systemNotifications.empty}">
                                <div th:each="notification : ${stats.systemNotifications}"
                                     class="list-group-item notification-item"
                                     th:classappend="${notification.isRead} ? 'read' : 'unread'">
                                    <div class="d-flex w-100 justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1 d-flex align-items-center">
                                                <i class="fas fa-circle text-primary mr-2"
                                                   th:classappend="${notification.isRead} ? 'text-muted' : 'text-primary'"
                                                   style="font-size: 0.5rem;"></i>
                                                <span th:text="${notification.title}">通知标题</span>
                                            </h6>
                                            <p class="mb-1 text-muted" th:text="${notification.content}">通知内容</p>
                                            <small class="text-muted">
                                                <i class="fas fa-user mr-1"></i>
                                                <span th:text="${notification.sender}">发送者</span>
                                                <span class="mx-2">•</span>
                                                <i class="fas fa-clock mr-1"></i>
                                                <span th:text="${#temporals.format(notification.createTime, 'MM-dd HH:mm')}">时间</span>
                                            </small>
                                        </div>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-link text-muted" type="button"
                                                    data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-right">
                                                <li><a class="dropdown-item" href="#" onclick="markAsRead(this)">
                                                    <i class="fas fa-check mr-2"></i>标记已读
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="deleteNotification(this)">
                                                    <i class="fas fa-trash mr-2"></i>删除
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- 默认通知（当没有真实数据时显示） -->
                            <div th:if="${stats?.systemNotifications == null or stats.systemNotifications.empty}">
                                <div class="list-group-item notification-item unread">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">
                                            <i class="fas fa-circle text-primary mr-2" style="font-size: 0.5rem;"></i>
                                            欢迎使用智慧校园管理系统
                                        </h6>
                                        <small>刚刚</small>
                                    </div>
                                    <p class="mb-1">系统已成功启动，所有功能正常运行。</p>
                                    <small class="text-muted">
                                        <i class="fas fa-user mr-1"></i>系统管理员
                                    </small>
                                </div>
                                <div class="list-group-item notification-item read">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">
                                            <i class="fas fa-circle text-muted mr-2" style="font-size: 0.5rem;"></i>
                                            数据初始化完成
                                        </h6>
                                        <small>1小时前</small>
                                    </div>
                                    <p class="mb-1">系统基础数据已成功初始化。</p>
                                    <small class="text-muted">
                                        <i class="fas fa-user mr-1"></i>系统
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <a href="/admin/notifications" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-list mr-1"></i>查看全部通知
                            </a>
                            <button class="btn btn-sm btn-outline-secondary ml-2" onclick="refreshNotifications()">
                                <i class="fas fa-sync-alt mr-1"></i>刷新
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 最近活动区域 -->
        <div class="row">
            <div class="col-12">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white border-0 py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 text-primary">
                                <i class="fas fa-history me-2"></i>最近活动
                            </h5>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-cog"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="refreshActivities()">
                                        <i class="fas fa-sync-alt me-2"></i>刷新活动
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="exportActivities()">
                                        <i class="fas fa-download me-2"></i>导出活动日志
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="/admin/activity-log">
                                        <i class="fas fa-list me-2"></i>查看完整日志
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="timeline" id="activitiesTimeline">
                            <!-- 使用Thymeleaf渲染真实活动数据 -->
                            <div th:if="${stats?.recentActivities != null and !stats.recentActivities.empty}">
                                <div th:each="activity, iterStat : ${stats.recentActivities}"
                                     class="timeline-item"
                                     th:classappend="${iterStat.last} ? 'timeline-item-last' : ''">
                                    <div class="timeline-marker">
                                        <i class="fas fa-circle"
                                           th:classappend="${activity.type == '系统统计'} ? 'text-primary' :
                                                          (${activity.type == '课程统计'} ? 'text-success' :
                                                          (${activity.type == '缴费统计'} ? 'text-warning' : 'text-info'))"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1" th:text="${activity.type}">活动类型</h6>
                                                <p class="mb-1 text-muted" th:text="${activity.description}">活动描述</p>
                                                <small class="text-muted">
                                                    <i class="fas fa-user mr-1"></i>
                                                    <span th:text="${activity.user}">用户</span>
                                                    <span class="mx-2">•</span>
                                                    <i class="fas fa-clock mr-1"></i>
                                                    <span th:text="${#temporals.format(activity.timestamp, 'MM-dd HH:mm')}">时间</span>
                                                </small>
                                            </div>
                                            <div class="activity-actions">
                                                <button class="btn btn-sm btn-outline-secondary"
                                                        onclick="showActivityDetails(this)"
                                                        th:data-activity="${activity.description}">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- 默认活动（当没有真实数据时显示） -->
                            <div th:if="${stats?.recentActivities == null or stats.recentActivities.empty}">
                                <div class="timeline-item">
                                    <div class="timeline-marker">
                                        <i class="fas fa-circle text-success"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <h6 class="mb-1">系统启动</h6>
                                        <p class="mb-1 text-muted">智慧校园管理系统已成功启动</p>
                                        <small class="text-muted">
                                            <i class="fas fa-user mr-1"></i>系统
                                            <span class="mx-2">•</span>
                                            <i class="fas fa-clock mr-1"></i>刚刚
                                        </small>
                                    </div>
                                </div>
                                <div class="timeline-item">
                                    <div class="timeline-marker">
                                        <i class="fas fa-circle text-primary"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <h6 class="mb-1">数据加载</h6>
                                        <p class="mb-1 text-muted">仪表盘数据已成功加载</p>
                                        <small class="text-muted">
                                            <i class="fas fa-user mr-1"></i>系统
                                            <span class="mx-2">•</span>
                                            <i class="fas fa-clock mr-1"></i>1分钟前
                                        </small>
                                    </div>
                                </div>
                                <div class="timeline-item timeline-item-last">
                                    <div class="timeline-marker">
                                        <i class="fas fa-circle text-info"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <h6 class="mb-1">用户登录</h6>
                                        <p class="mb-1 text-muted">管理员登录系统</p>
                                        <small class="text-muted">
                                            <i class="fas fa-user mr-1"></i>admin
                                            <span class="mx-2">•</span>
                                            <i class="fas fa-clock mr-1"></i>5分钟前
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-4">
                            <button class="btn btn-outline-primary" onclick="loadMoreActivities()">
                                <i class="fas fa-plus mr-1"></i>加载更多活动
                            </button>
                            <button class="btn btn-outline-secondary ml-2" onclick="refreshActivities()">
                                <i class="fas fa-sync-alt mr-1"></i>刷新
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <th:block th:fragment="scripts">
        <!-- 引入API客户端 -->
        <script th:src="@{/js/api-client.js}"></script>

        <!-- 引入仪表盘数据管理模块（完全依赖后端数据）-->
        <script th:src="@{/js/modules/dashboard-data.js}"></script>
        
        <!-- 引入仪表盘诊断工具 -->
        <script th:src="@{/js/modules/dashboard-diagnostics.js}"></script>

        <!-- 仪表盘页面初始化脚本 -->
        <script>
            // 页面加载完成后的初始化
            document.addEventListener('DOMContentLoaded', function() {
                // 设置当前页面标识
                document.body.setAttribute('data-current-page', 'dashboard');
                console.log('仪表盘页面已加载，数据管理器将自动初始化');
                
                // 显示数据加载指示器
                showDataLoadingIndicator();
                
                // 监听数据管理器初始化完成事件
                document.addEventListener('dashboardDataReady', function() {
                    hideDataLoadingIndicator();
                    console.log('仪表盘数据管理器初始化完成');
                });
                
                // 监听数据加载错误事件
                document.addEventListener('dashboardDataError', function(event) {
                    hideDataLoadingIndicator();
                    console.error('仪表盘数据加载失败:', event.detail);
                });
            });

            // 显示数据加载指示器
            function showDataLoadingIndicator() {
                const indicator = document.getElementById('dataLoadingIndicator');
                if (indicator) {
                    indicator.style.display = 'block';
                    indicator.classList.add('fade-in');
                }
            }

            // 隐藏数据加载指示器
            function hideDataLoadingIndicator() {
                const indicator = document.getElementById('dataLoadingIndicator');
                if (indicator) {
                    indicator.style.display = 'none';
                    indicator.classList.remove('fade-in');
                }
            }

            // 刷新仪表盘数据 - 使用数据管理器
            function refreshDashboardData() {
                if (window.dashboardData) {
                    window.dashboardData.refreshAllData();
                } else {
                    console.warn('数据管理器未初始化，使用页面刷新');
                    location.reload();
                }
            }

            // 显示活动详情
            function showActivityDetails(button) {
                const activity = button.getAttribute('data-activity');
                if (activity) {
                    alert('活动详情：' + activity);
                }
            }

            // 标记通知为已读
            function markAsRead(button) {
                const item = button.closest('.notification-item');
                if (item) {
                    item.classList.remove('unread');
                    item.classList.add('read');
                    showAlert('通知已标记为已读', 'success');
                }
            }

            // 删除通知
            function deleteNotification(button) {
                const item = button.closest('.notification-item');
                if (item && confirm('确定要删除这条通知吗？')) {
                    item.remove();
                    showAlert('通知已删除', 'info');
                }
            }

            // 标记全部通知为已读
            function markAllAsRead() {
                const unreadItems = document.querySelectorAll('.notification-item.unread');
                unreadItems.forEach(item => {
                    item.classList.remove('unread');
                    item.classList.add('read');
                });
                showAlert(`已标记 ${unreadItems.length} 条通知为已读`, 'success');
            }

            // 导出活动日志
            function exportActivities() {
                showAlert('活动日志导出功能开发中...', 'info');
            }
        </script>
    </th:block>
</body>
</html>
