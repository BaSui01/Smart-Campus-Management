<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/admin :: html}"
      lang="zh-CN">
<head th:replace="~{layout/admin :: head}">
    <th:block th:fragment="head-extra">
        <title>学费管理 - 智慧校园管理系统</title>
        <!-- 网站图标 -->
        <link rel="icon" type="image/svg+xml" th:href="@{/images/favicon.svg}">
        <link rel="alternate icon" th:href="@{/favicon.ico}">
        <link rel="apple-touch-icon" th:href="@{/images/favicon.svg}">
    </th:block>
</head>
<body>
    <div th:fragment="content">
        <!-- 页面标题 -->
        <div th:replace="~{components/admin/admin-components :: page-header(
            title='学费管理',
            icon='fas fa-money-bill',
            showAddButton=true,
            addButtonText='添加缴费项目',
            addButtonTarget='#addFeeItemModal'
        )}"></div>

        <!-- 统计卡片 -->
        <div th:replace="~{components/admin/admin-components :: stat-cards(${feeItemStats})}"></div>

        <!-- 搜索筛选组件 -->
        <div th:replace="~{components/admin/admin-components :: search-filter('/admin/fee-items', ${feeItemFilters})}"></div>

        <!-- 数据表格组件 -->
        <div th:replace="~{components/admin/admin-components :: data-table(${feeItemTableConfig}, ${feeItems})}"></div>
    </div>

    <!-- 引入admin组件样式和脚本 -->
    <th:block th:replace="~{components/admin/admin-components :: admin-style}"></th:block>
    <th:block th:replace="~{components/admin/admin-components :: admin-script}"></th:block>

    <!-- 学费管理特定脚本 -->
    <script th:fragment="page-script">
        // 缴费项目操作函数
        function viewFeeItem(feeItemId) {
            alert('查看缴费项目详情：' + feeItemId);
        }

        function editFeeItem(feeItemId) {
            alert('编辑缴费项目：' + feeItemId);
        }

        function deleteFeeItem(feeItemId) {
            if (confirm('确定要删除该缴费项目吗？')) {
                alert('删除缴费项目：' + feeItemId);
            }
        }

        function viewPaymentRecords(feeItemId) {
            alert('查看缴费记录：' + feeItemId);
        }
    </script>

    <!-- 添加缴费项目模态框 -->
    <div class="modal fade" id="addFeeItemModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加缴费项目</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addFeeItemForm" class="needs-validation" novalidate>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">项目编码 *</label>
                                <input type="text" class="form-control" name="itemCode" required>
                                <div class="invalid-feedback">请输入项目编码</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">项目名称 *</label>
                                <input type="text" class="form-control" name="itemName" required>
                                <div class="invalid-feedback">请输入项目名称</div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label">费用类型 *</label>
                                <select class="form-select" name="feeType" required>
                                    <option value="">请选择费用类型</option>
                                    <option value="学费">学费</option>
                                    <option value="杂费">杂费</option>
                                    <option value="书费">书费</option>
                                    <option value="住宿费">住宿费</option>
                                    <option value="实验费">实验费</option>
                                </select>
                                <div class="invalid-feedback">请选择费用类型</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">金额 *</label>
                                <div class="input-group">
                                    <span class="input-group-text">¥</span>
                                    <input type="number" class="form-control" name="amount" step="0.01" min="0" required>
                                </div>
                                <div class="invalid-feedback">请输入金额</div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label">适用年级</label>
                                <select class="form-select" name="applicableGrade">
                                    <option value="">全年级</option>
                                    <option value="2024级">2024级</option>
                                    <option value="2023级">2023级</option>
                                    <option value="2022级">2022级</option>
                                    <option value="2021级">2021级</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">截止日期</label>
                                <input type="date" class="form-control" name="dueDate">
                            </div>
                        </div>
                        <div class="mt-3">
                            <label class="form-label">项目描述</label>
                            <textarea class="form-control" name="description" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="submitAddFeeItemForm()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function submitAddFeeItemForm() {
            const form = document.getElementById('addFeeItemForm');
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }

            const formData = new FormData(form);
            const feeItemData = {
                itemCode: formData.get('itemCode'),
                itemName: formData.get('itemName'),
                feeType: formData.get('feeType'),
                amount: formData.get('amount'),
                applicableGrade: formData.get('applicableGrade'),
                dueDate: formData.get('dueDate'),
                description: formData.get('description'),
                status: 1 // 默认启用
            };

            fetch('/admin/fee-items/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(feeItemData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('添加缴费项目成功！');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addFeeItemModal'));
                    modal.hide();
                    form.reset();
                    form.classList.remove('was-validated');
                    window.location.reload();
                } else {
                    alert('添加缴费项目失败：' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('添加缴费项目失败，请稍后重试');
            });
        }
    </script>
</body>
</html>
