<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/admin :: html}"
      lang="zh-CN">
<head th:replace="~{layout/admin :: head}">
    <th:block th:fragment="head-extra">
        <title>缴费记录 - 智慧校园管理系统</title>
        <!-- 网站图标 -->
        <link rel="icon" type="image/svg+xml" th:href="@{/images/favicon.svg}">
        <link rel="alternate icon" th:href="@{/favicon.ico}">
        <link rel="apple-touch-icon" th:href="@{/images/favicon.svg}">
        <!-- DataTables CSS -->
        <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    </th:block>
</head>
<body>
    <div th:fragment="content">
        <!-- 页面标题 -->
        <div th:replace="~{components/admin/admin-components :: page-header(
            title='缴费记录管理',
            icon='fas fa-credit-card',
            showAddButton=true,
            addButtonText='添加缴费记录',
            addButtonTarget='#paymentModal'
        )}"></div>

        <!-- 统计卡片 -->
        <div th:replace="~{components/admin/admin-components :: stat-cards(${paymentStats})}"></div>

        <!-- 搜索筛选组件 -->
        <div th:replace="~{components/admin/admin-components :: search-filter('/admin/payments', ${paymentFilters})}"></div>

        <!-- 数据表格组件 -->
        <div th:replace="~{components/admin/admin-components :: data-table(${paymentTableConfig}, ${payments})}"></div>
    </div>

    <!-- 引入admin组件样式和脚本 -->
    <th:block th:replace="~{components/admin/admin-components :: admin-style}"></th:block>
    <th:block th:replace="~{components/admin/admin-components :: admin-script}"></th:block>

    <!-- 缴费记录特定脚本 -->
    <script th:fragment="page-script">
        // 缴费记录操作函数
        function viewPayment(paymentId) {
            alert('查看缴费记录详情：' + paymentId);
        }

        function editPayment(paymentId) {
            alert('编辑缴费记录：' + paymentId);
        }

        function printReceipt(paymentId) {
            alert('打印缴费凭证：' + paymentId);
        }

        function refundPayment(paymentId) {
            if (confirm('确定要退费吗？')) {
                alert('退费处理：' + paymentId);
            }
        }

        function processPayment(paymentId) {
            alert('处理缴费：' + paymentId);
        }

        function sendReminder(paymentId) {
            alert('发送缴费提醒：' + paymentId);
        }

        function sendOverdueNotice(paymentId) {
            alert('发送逾期通知：' + paymentId);
        }

        function viewRefundDetails(paymentId) {
            alert('查看退费详情：' + paymentId);
        }

        function exportPayments() {
            alert('导出缴费记录');
        }

        function refreshData() {
            window.location.reload();
        }
    </script>

    <!-- 缴费记录编辑模态框 -->
    <div class="modal fade" id="paymentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalTitle">添加缴费记录</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="paymentForm">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="studentSelect" class="form-label">学生 <span class="text-danger">*</span></label>
                                    <select class="form-select" id="studentSelect" name="studentId" required>
                                        <option value="">请选择学生</option>
                                        <option value="1">2024001 - 张三</option>
                                        <option value="2">2024002 - 李四</option>
                                        <option value="3">2024003 - 王五</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="feeTypeSelect" class="form-label">缴费项目 <span class="text-danger">*</span></label>
                                    <select class="form-select" id="feeTypeSelect" name="feeType" required>
                                        <option value="">请选择缴费项目</option>
                                        <option value="tuition">学费</option>
                                        <option value="accommodation">住宿费</option>
                                        <option value="textbook">教材费</option>
                                        <option value="insurance">保险费</option>
                                        <option value="other">其他费用</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="amountDue" class="form-label">应缴金额 <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="amountDue" name="amountDue"
                                           step="0.01" min="0" required placeholder="0.00">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="amountPaid" class="form-label">实缴金额</label>
                                    <input type="number" class="form-control" id="amountPaid" name="amountPaid"
                                           step="0.01" min="0" placeholder="0.00">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="paymentMethodSelect" class="form-label">缴费方式</label>
                                    <select class="form-select" id="paymentMethodSelect" name="paymentMethod">
                                        <option value="">请选择缴费方式</option>
                                        <option value="cash">现金</option>
                                        <option value="bank_transfer">银行转账</option>
                                        <option value="alipay">支付宝</option>
                                        <option value="wechat">微信支付</option>
                                        <option value="credit_card">信用卡</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="statusSelect" class="form-label">缴费状态</label>
                                    <select class="form-select" id="statusSelect" name="status">
                                        <option value="pending">待缴费</option>
                                        <option value="paid">已缴费</option>
                                        <option value="overdue">逾期未缴</option>
                                        <option value="refunded">已退费</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="remarks" class="form-label">备注</label>
                            <textarea class="form-control" id="remarks" name="remarks" rows="3"
                                      placeholder="缴费相关备注信息"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="submit" class="btn btn-primary" onclick="submitPaymentForm()">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        function submitPaymentForm() {
            const form = document.getElementById('paymentForm');
            const formData = new FormData(form);

            const paymentData = {
                studentId: formData.get('studentId'),
                feeType: formData.get('feeType'),
                amountDue: formData.get('amountDue'),
                amountPaid: formData.get('amountPaid'),
                paymentMethod: formData.get('paymentMethod'),
                status: formData.get('status'),
                remarks: formData.get('remarks')
            };

            fetch('/admin/payments/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(paymentData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('添加缴费记录成功！');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('paymentModal'));
                    modal.hide();
                    form.reset();
                    window.location.reload();
                } else {
                    alert('添加缴费记录失败：' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('添加缴费记录失败，请稍后重试');
            });
        }
    </script>


</body>
</html>
