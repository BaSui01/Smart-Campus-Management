<!-- 班级添加/编辑弹窗 -->
<div class="modal fade" id="classModal" tabindex="-1" aria-labelledby="classModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="classModalLabel">
                    <i class="fas fa-users"></i> 添加班级
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- 填写说明 -->
                <div class="alert alert-info mb-3" role="alert">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="alert-heading mb-2">
                                <i class="fas fa-lightbulb"></i> 填写提示
                            </h6>
                            <ul class="mb-0 small">
                                <li>班级名称建议包含年级和专业信息</li>
                                <li>班级代码用于系统内部标识</li>
                                <li>班主任可以后续指定</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="alert-heading mb-2">
                                <i class="fas fa-exclamation-triangle"></i> 注意事项
                            </h6>
                            <ul class="mb-0 small">
                                <li>班级代码一旦确定不可修改</li>
                                <li>请确保班级信息准确无误</li>
                                <li>班级容量影响选课限制</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <form id="classModalForm" data-auto-save="class-modal-form">
                    <!-- 基本信息 -->
                    <h6 class="text-primary mb-3">
                        <i class="fas fa-info-circle"></i> 基本信息
                    </h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalClassCode" class="form-label">班级代码 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="modalClassCode" name="classCode" 
                                       placeholder="如：CS2024-1" required>
                                <div class="form-text">建议格式：专业缩写+年级+班号</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalClassName" class="form-label">班级名称 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="modalClassName" name="className" 
                                       placeholder="如：计算机科学2024-1班" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalMajor" class="form-label">所属专业 <span class="text-danger">*</span></label>
                                <select class="form-select" id="modalMajor" name="major" required>
                                    <option value="">请选择专业</option>
                                    <option value="计算机科学与技术">计算机科学与技术</option>
                                    <option value="软件工程">软件工程</option>
                                    <option value="信息安全">信息安全</option>
                                    <option value="数据科学与大数据技术">数据科学与大数据技术</option>
                                    <option value="人工智能">人工智能</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalGrade" class="form-label">年级 <span class="text-danger">*</span></label>
                                <select class="form-select" id="modalGrade" name="grade" required>
                                    <option value="">请选择年级</option>
                                    <option value="2024">2024级</option>
                                    <option value="2023">2023级</option>
                                    <option value="2022">2022级</option>
                                    <option value="2021">2021级</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalDepartment" class="form-label">所属院系 <span class="text-danger">*</span></label>
                                <select class="form-select" id="modalDepartment" name="department" required>
                                    <option value="">请选择院系</option>
                                    <option value="计算机学院">计算机学院</option>
                                    <option value="软件学院">软件学院</option>
                                    <option value="信息学院">信息学院</option>
                                    <option value="数学学院">数学学院</option>
                                    <option value="外语学院">外语学院</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalCapacity" class="form-label">班级容量</label>
                                <input type="number" class="form-control" id="modalCapacity" name="capacity" 
                                       min="20" max="60" value="40" placeholder="如：40">
                                <div class="form-text">建议20-60人</div>
                            </div>
                        </div>
                    </div>

                    <!-- 管理信息 -->
                    <hr>
                    <h6 class="text-primary mb-3">
                        <i class="fas fa-user-tie"></i> 管理信息
                    </h6>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalClassTeacher" class="form-label">班主任</label>
                                <select class="form-select" id="modalClassTeacher" name="classTeacher">
                                    <option value="">请选择班主任</option>
                                    <option value="1">张教授 - 计算机学院</option>
                                    <option value="2">李副教授 - 软件学院</option>
                                    <option value="3">王讲师 - 信息学院</option>
                                    <option value="4">赵教授 - 计算机学院</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalAssistant" class="form-label">辅导员</label>
                                <select class="form-select" id="modalAssistant" name="assistant">
                                    <option value="">请选择辅导员</option>
                                    <option value="1">陈老师 - 学生处</option>
                                    <option value="2">刘老师 - 学生处</option>
                                    <option value="3">杨老师 - 学生处</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalClassroom" class="form-label">固定教室</label>
                                <input type="text" class="form-control" id="modalClassroom" name="classroom" 
                                       placeholder="如：教学楼A-101">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalStatus" class="form-label">班级状态</label>
                                <select class="form-select" id="modalStatus" name="status">
                                    <option value="正常" selected>正常</option>
                                    <option value="暂停招生">暂停招生</option>
                                    <option value="已毕业">已毕业</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 时间信息 -->
                    <hr>
                    <h6 class="text-primary mb-3">
                        <i class="fas fa-calendar-alt"></i> 时间信息
                    </h6>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalStartDate" class="form-label">开班日期</label>
                                <input type="date" class="form-control" id="modalStartDate" name="startDate">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalExpectedGraduation" class="form-label">预计毕业时间</label>
                                <input type="date" class="form-control" id="modalExpectedGraduation" name="expectedGraduation">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="modalDescription" class="form-label">班级描述</label>
                        <textarea class="form-control" id="modalDescription" name="description" rows="2" 
                                  placeholder="请输入班级特色、培养目标等"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> 取消
                </button>
                <button type="button" class="btn btn-outline-secondary" id="resetClassForm">
                    <i class="fas fa-undo"></i> 重置
                </button>
                <button type="button" class="btn btn-primary" id="saveClass">
                    <i class="fas fa-save"></i> 保存班级
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// 班级弹窗相关功能
document.addEventListener('DOMContentLoaded', function() {
    const classModal = document.getElementById('classModal');
    const classForm = document.getElementById('classModalForm');
    const saveBtn = document.getElementById('saveClass');
    const resetBtn = document.getElementById('resetClassForm');

    // 专业和院系联动
    document.getElementById('modalMajor').addEventListener('change', function() {
        const selectedMajor = this.value;
        const departmentSelect = document.getElementById('modalDepartment');
        
        // 根据专业自动选择院系
        const majorDepartmentMap = {
            '计算机科学与技术': '计算机学院',
            '软件工程': '软件学院',
            '信息安全': '信息学院',
            '数据科学与大数据技术': '计算机学院',
            '人工智能': '计算机学院'
        };
        
        if (majorDepartmentMap[selectedMajor]) {
            departmentSelect.value = majorDepartmentMap[selectedMajor];
        }
    });

    // 年级变化时自动设置开班日期和预计毕业时间
    document.getElementById('modalGrade').addEventListener('change', function() {
        const grade = this.value;
        if (grade) {
            const startDate = `${grade}-09-01`;
            const graduationDate = `${parseInt(grade) + 4}-06-30`;
            
            document.getElementById('modalStartDate').value = startDate;
            document.getElementById('modalExpectedGraduation').value = graduationDate;
        }
    });

    // 保存按钮点击事件
    saveBtn.addEventListener('click', function() {
        if (!FormUtils.validateForm(classForm)) {
            return;
        }

        // 设置加载状态
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存中...';

        // 模拟保存
        setTimeout(() => {
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-save"></i> 保存班级';
            
            FormUtils.showAlert('班级信息保存成功！', 'success');
            FormUtils.clearSavedForm('class-modal-form');
            
            // 关闭弹窗
            bootstrap.Modal.getInstance(classModal).hide();
            
            // 重置表单
            classForm.reset();
            FormUtils.resetFormValidation(classForm);
            
            // 刷新班级列表（如果在班级管理页面）
            if (typeof refreshClassList === 'function') {
                refreshClassList();
            }
        }, 2000);
    });

    // 重置按钮点击事件
    resetBtn.addEventListener('click', function() {
        classForm.reset();
        FormUtils.resetFormValidation(classForm);
        FormUtils.clearSavedForm('class-modal-form');
    });

    // 弹窗关闭时重置表单
    classModal.addEventListener('hidden.bs.modal', function() {
        classForm.reset();
        FormUtils.resetFormValidation(classForm);
    });
});

// 打开班级添加弹窗的函数
function openClassModal(classData = null) {
    const modal = new bootstrap.Modal(document.getElementById('classModal'));
    const form = document.getElementById('classModalForm');
    const title = document.getElementById('classModalLabel');
    
    if (classData) {
        // 编辑模式
        title.innerHTML = '<i class="fas fa-users-cog"></i> 编辑班级';
        
        // 填充表单数据
        Object.keys(classData).forEach(key => {
            const field = form.querySelector(`[name="${key}"]`);
            if (field) {
                field.value = classData[key];
            }
        });
    } else {
        // 添加模式
        title.innerHTML = '<i class="fas fa-users"></i> 添加班级';
        form.reset();
    }
    
    modal.show();
}
</script>
