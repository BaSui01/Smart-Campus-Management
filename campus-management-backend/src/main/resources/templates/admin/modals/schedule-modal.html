<!-- 排课添加/编辑弹窗 -->
<div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scheduleModalLabel">
                    <i class="fas fa-calendar-plus"></i> 安排课程
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- 填写说明 -->
                <div class="alert alert-warning mb-3" role="alert">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="alert-heading mb-2">
                                <i class="fas fa-exclamation-triangle"></i> 排课提醒
                            </h6>
                            <ul class="mb-0 small">
                                <li>请确认教师和教室的时间冲突</li>
                                <li>同一班级不能在同一时间有多门课</li>
                                <li>建议提前检查资源可用性</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="alert-heading mb-2">
                                <i class="fas fa-lightbulb"></i> 操作提示
                            </h6>
                            <ul class="mb-0 small">
                                <li>系统会自动检测时间冲突</li>
                                <li>可以设置重复周期</li>
                                <li>支持临时调课功能</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <form id="scheduleModalForm" data-auto-save="schedule-modal-form">
                    <!-- 课程信息 -->
                    <h6 class="text-primary mb-3">
                        <i class="fas fa-book"></i> 课程信息
                    </h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalCourse" class="form-label">选择课程 <span class="text-danger">*</span></label>
                                <select class="form-select" id="modalCourse" name="courseId" required>
                                    <option value="">请选择课程</option>
                                    <option value="1">CS101 - 计算机科学导论</option>
                                    <option value="2">CS102 - 程序设计基础</option>
                                    <option value="3">EL301 - 大学英语</option>
                                    <option value="4">MA201 - 高等数学</option>
                                    <option value="5">CS201 - 数据结构</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalTeacher" class="form-label">授课教师 <span class="text-danger">*</span></label>
                                <select class="form-select" id="modalTeacher" name="teacherId" required>
                                    <option value="">请选择教师</option>
                                    <option value="1">张教授 - 计算机学院</option>
                                    <option value="2">李副教授 - 软件学院</option>
                                    <option value="3">王讲师 - 信息学院</option>
                                    <option value="4">赵教授 - 数学学院</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalClass" class="form-label">上课班级 <span class="text-danger">*</span></label>
                                <select class="form-select" id="modalClass" name="classId" required>
                                    <option value="">请选择班级</option>
                                    <option value="1">计算机科学2024-1班</option>
                                    <option value="2">软件工程2024-1班</option>
                                    <option value="3">信息安全2024-1班</option>
                                    <option value="4">数据科学2024-1班</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalClassroom" class="form-label">教室 <span class="text-danger">*</span></label>
                                <select class="form-select" id="modalClassroom" name="classroomId" required>
                                    <option value="">请选择教室</option>
                                    <option value="1">教学楼A-101 (60人)</option>
                                    <option value="2">教学楼A-102 (80人)</option>
                                    <option value="3">实验楼B-201 (40人)</option>
                                    <option value="4">多媒体楼C-301 (100人)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 时间安排 -->
                    <hr>
                    <h6 class="text-primary mb-3">
                        <i class="fas fa-clock"></i> 时间安排
                    </h6>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalSemester" class="form-label">学期 <span class="text-danger">*</span></label>
                                <select class="form-select" id="modalSemester" name="semester" required>
                                    <option value="">请选择学期</option>
                                    <option value="2024-1">2024年春季学期</option>
                                    <option value="2024-2">2024年秋季学期</option>
                                    <option value="2025-1">2025年春季学期</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalWeekday" class="form-label">星期 <span class="text-danger">*</span></label>
                                <select class="form-select" id="modalWeekday" name="weekday" required>
                                    <option value="">请选择星期</option>
                                    <option value="1">星期一</option>
                                    <option value="2">星期二</option>
                                    <option value="3">星期三</option>
                                    <option value="4">星期四</option>
                                    <option value="5">星期五</option>
                                    <option value="6">星期六</option>
                                    <option value="7">星期日</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalTimeSlot" class="form-label">时间段 <span class="text-danger">*</span></label>
                                <select class="form-select" id="modalTimeSlot" name="timeSlot" required>
                                    <option value="">请选择时间段</option>
                                    <option value="1-2">第1-2节 (08:00-09:40)</option>
                                    <option value="3-4">第3-4节 (10:00-11:40)</option>
                                    <option value="5-6">第5-6节 (14:00-15:40)</option>
                                    <option value="7-8">第7-8节 (16:00-17:40)</option>
                                    <option value="9-10">第9-10节 (19:00-20:40)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalWeeks" class="form-label">上课周次 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="modalWeeks" name="weeks" 
                                       placeholder="如：1-16周" required>
                                <div class="form-text">格式：1-16周 或 1,3,5-8,10周</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalStartDate" class="form-label">开始日期</label>
                                <input type="date" class="form-control" id="modalStartDate" name="startDate">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalEndDate" class="form-label">结束日期</label>
                                <input type="date" class="form-control" id="modalEndDate" name="endDate">
                            </div>
                        </div>
                    </div>

                    <!-- 课程设置 -->
                    <hr>
                    <h6 class="text-primary mb-3">
                        <i class="fas fa-cog"></i> 课程设置
                    </h6>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalCourseType" class="form-label">课程类型</label>
                                <select class="form-select" id="modalCourseType" name="courseType">
                                    <option value="理论课">理论课</option>
                                    <option value="实验课">实验课</option>
                                    <option value="实践课">实践课</option>
                                    <option value="讨论课">讨论课</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalCapacity" class="form-label">容量限制</label>
                                <input type="number" class="form-control" id="modalCapacity" name="capacity" 
                                       min="1" max="200" placeholder="如：40">
                                <div class="form-text">不填则使用教室容量</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalExamType" class="form-label">考核方式</label>
                                <select class="form-select" id="modalExamType" name="examType">
                                    <option value="考试">考试</option>
                                    <option value="考查">考查</option>
                                    <option value="论文">论文</option>
                                    <option value="实践">实践</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalStatus" class="form-label">状态</label>
                                <select class="form-select" id="modalStatus" name="status">
                                    <option value="正常" selected>正常</option>
                                    <option value="暂停">暂停</option>
                                    <option value="调课">调课</option>
                                    <option value="停课">停课</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="modalRemarks" class="form-label">备注</label>
                        <textarea class="form-control" id="modalRemarks" name="remarks" rows="2" 
                                  placeholder="请输入备注信息，如特殊要求、注意事项等"></textarea>
                    </div>

                    <!-- 冲突检测结果 -->
                    <div id="conflictAlert" class="alert alert-danger d-none" role="alert">
                        <h6 class="alert-heading">
                            <i class="fas fa-exclamation-triangle"></i> 发现时间冲突
                        </h6>
                        <div id="conflictDetails"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> 取消
                </button>
                <button type="button" class="btn btn-outline-info" id="checkConflict">
                    <i class="fas fa-search"></i> 检测冲突
                </button>
                <button type="button" class="btn btn-outline-secondary" id="resetScheduleForm">
                    <i class="fas fa-undo"></i> 重置
                </button>
                <button type="button" class="btn btn-primary" id="saveSchedule">
                    <i class="fas fa-save"></i> 保存排课
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// 排课弹窗相关功能
document.addEventListener('DOMContentLoaded', function() {
    const scheduleModal = document.getElementById('scheduleModal');
    const scheduleForm = document.getElementById('scheduleModalForm');
    const saveBtn = document.getElementById('saveSchedule');
    const resetBtn = document.getElementById('resetScheduleForm');
    const checkBtn = document.getElementById('checkConflict');

    // 冲突检测
    checkBtn.addEventListener('click', function() {
        const formData = new FormData(scheduleForm);
        const conflictAlert = document.getElementById('conflictAlert');
        const conflictDetails = document.getElementById('conflictDetails');
        
        // 模拟冲突检测
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 检测中...';
        
        setTimeout(() => {
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-search"></i> 检测冲突';
            
            // 模拟检测结果
            const hasConflict = Math.random() > 0.7; // 30%概率有冲突
            
            if (hasConflict) {
                conflictDetails.innerHTML = `
                    <ul class="mb-0">
                        <li>教师张教授在星期一第1-2节已有课程安排</li>
                        <li>教室A-101在该时间段已被占用</li>
                    </ul>
                `;
                conflictAlert.classList.remove('d-none');
            } else {
                conflictAlert.classList.add('d-none');
                FormUtils.showAlert('未发现时间冲突，可以安排课程！', 'success');
            }
        }, 1500);
    });

    // 保存按钮点击事件
    saveBtn.addEventListener('click', function() {
        if (!FormUtils.validateForm(scheduleForm)) {
            return;
        }

        // 设置加载状态
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存中...';

        // 模拟保存
        setTimeout(() => {
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-save"></i> 保存排课';
            
            FormUtils.showAlert('课程安排保存成功！', 'success');
            FormUtils.clearSavedForm('schedule-modal-form');
            
            // 关闭弹窗
            bootstrap.Modal.getInstance(scheduleModal).hide();
            
            // 重置表单
            scheduleForm.reset();
            FormUtils.resetFormValidation(scheduleForm);
            document.getElementById('conflictAlert').classList.add('d-none');
            
            // 刷新课表（如果在课表管理页面）
            if (typeof refreshScheduleList === 'function') {
                refreshScheduleList();
            }
        }, 2000);
    });

    // 重置按钮点击事件
    resetBtn.addEventListener('click', function() {
        scheduleForm.reset();
        FormUtils.resetFormValidation(scheduleForm);
        FormUtils.clearSavedForm('schedule-modal-form');
        document.getElementById('conflictAlert').classList.add('d-none');
    });

    // 弹窗关闭时重置表单
    scheduleModal.addEventListener('hidden.bs.modal', function() {
        scheduleForm.reset();
        FormUtils.resetFormValidation(scheduleForm);
        document.getElementById('conflictAlert').classList.add('d-none');
    });
});

// 打开排课弹窗的函数
function openScheduleModal(scheduleData = null) {
    const modal = new bootstrap.Modal(document.getElementById('scheduleModal'));
    const form = document.getElementById('scheduleModalForm');
    const title = document.getElementById('scheduleModalLabel');
    
    if (scheduleData) {
        // 编辑模式
        title.innerHTML = '<i class="fas fa-calendar-edit"></i> 编辑排课';
        
        // 填充表单数据
        Object.keys(scheduleData).forEach(key => {
            const field = form.querySelector(`[name="${key}"]`);
            if (field) {
                field.value = scheduleData[key];
            }
        });
    } else {
        // 添加模式
        title.innerHTML = '<i class="fas fa-calendar-plus"></i> 安排课程';
        form.reset();
    }
    
    modal.show();
}
</script>
