<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/admin :: html}"
      lang="zh-CN">
<head th:replace="~{layout/admin :: head}">
    <th:block th:fragment="head-extra">
        <title>缴费管理 - 智慧校园管理系统</title>
        <!-- DataTables CSS -->
        <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
        <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css">
        <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
        
        <!-- 缴费管理专用样式 -->
        <style>
            .payment-badge {
                font-size: 0.75rem;
                padding: 0.3rem 0.6rem;
                font-weight: bold;
            }
            .status-paid { background: linear-gradient(45deg, #28a745, #20c997); }
            .status-pending { background: linear-gradient(45deg, #ffc107, #fd7e14); }
            .status-overdue { background: linear-gradient(45deg, #dc3545, #e83e8c); }
            .status-partial { background: linear-gradient(45deg, #17a2b8, #6f42c1); }
            
            .search-filters {
                background: #f8f9fa;
                border-radius: 0.5rem;
                padding: 1rem;
                margin-bottom: 1rem;
            }
            .batch-actions {
                background: #e3f2fd;
                border-radius: 0.5rem;
                padding: 0.75rem;
                margin-bottom: 1rem;
                display: none;
            }
            .table-container {
                background: white;
                border-radius: 0.5rem;
                box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            }
            .stats-card {
                transition: transform 0.2s ease-in-out;
            }
            .stats-card:hover {
                transform: translateY(-2px);
            }
            .amount-display {
                font-family: 'Courier New', monospace;
                font-weight: bold;
            }
        </style>
    </th:block>
</head>
<body>
    <div th:fragment="content">
        <!-- 页面标题和操作按钮 -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-0">
                    <i class="fas fa-credit-card me-2 text-primary"></i>缴费管理
                </h1>
                <p class="text-muted mb-0">管理学生缴费记录、费用项目和财务统计</p>
            </div>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-info" onclick="refreshPaymentData()">
                    <i class="fas fa-sync-alt me-2"></i>刷新数据
                </button>
                <button type="button" class="btn btn-outline-success" onclick="exportPayments()">
                    <i class="fas fa-download me-2"></i>导出记录
                </button>
                <button type="button" class="btn btn-outline-warning" onclick="showPaymentReport()">
                    <i class="fas fa-chart-bar me-2"></i>财务报表
                </button>
                <button type="button" class="btn btn-primary" onclick="showAddPaymentModal()">
                    <i class="fas fa-plus me-2"></i>录入缴费
                </button>
            </div>
        </div>

        <!-- 错误提示区域 -->
        <div id="alertContainer"></div>

        <!-- 搜索和筛选区域 -->
        <div class="search-filters">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">学生姓名/学号</label>
                    <input type="text" class="form-control" id="searchKeyword" placeholder="输入学生信息搜索">
                </div>
                <div class="col-md-2">
                    <label class="form-label">费用项目</label>
                    <select class="form-select" id="feeItemFilter">
                        <option value="">全部项目</option>
                        <!-- 费用项目将通过AJAX加载 -->
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">缴费状态</label>
                    <select class="form-select" id="statusFilter">
                        <option value="">全部状态</option>
                        <option value="已缴费">已缴费</option>
                        <option value="待缴费">待缴费</option>
                        <option value="逾期">逾期</option>
                        <option value="部分缴费">部分缴费</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">学期</label>
                    <select class="form-select" id="semesterFilter">
                        <option value="">全部学期</option>
                        <option value="2024-1">2024年春季</option>
                        <option value="2024-2">2024年秋季</option>
                        <option value="2025-1">2025年春季</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-primary" onclick="applyFilters()">
                            <i class="fas fa-search me-1"></i>搜索
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="resetFilters()">
                            <i class="fas fa-undo me-1"></i>重置
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 批量操作区域 -->
        <div class="batch-actions" id="batchActions">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span class="fw-bold">已选择 <span id="selectedCount">0</span> 条缴费记录</span>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-sm btn-success" onclick="batchConfirmPayment()">
                        <i class="fas fa-check me-1"></i>批量确认
                    </button>
                    <button type="button" class="btn btn-sm btn-warning" onclick="batchSendReminder()">
                        <i class="fas fa-bell me-1"></i>发送提醒
                    </button>
                    <button type="button" class="btn btn-sm btn-info" onclick="batchExport()">
                        <i class="fas fa-download me-1"></i>批量导出
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">
                        <i class="fas fa-times me-1"></i>取消选择
                    </button>
                </div>
            </div>
        </div>

        <!-- 缴费统计卡片 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card border-0 shadow-sm stats-card">
                    <div class="card-body text-center">
                        <div class="text-success mb-2">
                            <i class="fas fa-money-bill-wave fa-2x"></i>
                        </div>
                        <h5 class="card-title mb-1">总收入</h5>
                        <h3 class="text-success mb-0 amount-display" id="totalIncome">¥0</h3>
                        <small class="text-muted">本学期总收入</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm stats-card">
                    <div class="card-body text-center">
                        <div class="text-primary mb-2">
                            <i class="fas fa-percentage fa-2x"></i>
                        </div>
                        <h5 class="card-title mb-1">缴费率</h5>
                        <h3 class="text-primary mb-0" id="paymentRate">0%</h3>
                        <small class="text-muted">已缴费比例</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm stats-card">
                    <div class="card-body text-center">
                        <div class="text-warning mb-2">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                        </div>
                        <h5 class="card-title mb-1">待缴费</h5>
                        <h3 class="text-warning mb-0 amount-display" id="pendingAmount">¥0</h3>
                        <small class="text-muted">待缴费金额</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm stats-card">
                    <div class="card-body text-center">
                        <div class="text-danger mb-2">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                        <h5 class="card-title mb-1">逾期人数</h5>
                        <h3 class="text-danger mb-0" id="overdueCount">0</h3>
                        <small class="text-muted">逾期未缴费</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- 缴费数据表格 -->
        <div class="table-container">
            <div class="card border-0">
                <div class="card-header bg-white border-0 py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-table me-2"></i>缴费记录
                        </h5>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="toggleColumns()">
                                <i class="fas fa-columns me-1"></i>列显示
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info" onclick="refreshTable()">
                                <i class="fas fa-sync-alt me-1"></i>刷新表格
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="paymentsTable" class="table table-hover table-striped">
                            <thead class="table-light">
                                <tr>
                                    <th width="40">
                                        <input type="checkbox" class="form-check-input" id="selectAll">
                                    </th>
                                    <th>学生姓名</th>
                                    <th>学号</th>
                                    <th>费用项目</th>
                                    <th>应缴金额</th>
                                    <th>已缴金额</th>
                                    <th>缴费状态</th>
                                    <th>缴费时间</th>
                                    <th>截止日期</th>
                                    <th>缴费方式</th>
                                    <th width="200">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 数据将通过AJAX加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 录入缴费模态框 -->
    <div class="modal fade" id="addPaymentModal" tabindex="-1" aria-labelledby="addPaymentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addPaymentModalLabel">
                        <i class="fas fa-plus me-2"></i>录入缴费
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addPaymentForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="studentId" class="form-label">学生 <span class="text-danger">*</span></label>
                                <select class="form-select" id="studentId" name="studentId" required>
                                    <option value="">请选择学生</option>
                                    <!-- 学生选项将通过AJAX加载 -->
                                </select>
                                <div class="invalid-feedback">请选择学生</div>
                            </div>
                            <div class="col-md-6">
                                <label for="feeItemId" class="form-label">费用项目 <span class="text-danger">*</span></label>
                                <select class="form-select" id="feeItemId" name="feeItemId" required>
                                    <option value="">请选择费用项目</option>
                                    <!-- 费用项目将通过AJAX加载 -->
                                </select>
                                <div class="invalid-feedback">请选择费用项目</div>
                            </div>
                            <div class="col-md-6">
                                <label for="amount" class="form-label">缴费金额 <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="amount" name="amount" min="0" step="0.01" required>
                                <div class="invalid-feedback">请输入缴费金额</div>
                            </div>
                            <div class="col-md-6">
                                <label for="paymentMethod" class="form-label">缴费方式 <span class="text-danger">*</span></label>
                                <select class="form-select" id="paymentMethod" name="paymentMethod" required>
                                    <option value="">请选择缴费方式</option>
                                    <option value="现金">现金</option>
                                    <option value="银行转账">银行转账</option>
                                    <option value="支付宝">支付宝</option>
                                    <option value="微信支付">微信支付</option>
                                    <option value="刷卡">刷卡</option>
                                </select>
                                <div class="invalid-feedback">请选择缴费方式</div>
                            </div>
                            <div class="col-md-6">
                                <label for="paymentDate" class="form-label">缴费日期 <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="paymentDate" name="paymentDate" required>
                                <div class="invalid-feedback">请选择缴费日期</div>
                            </div>
                            <div class="col-md-6">
                                <label for="transactionId" class="form-label">交易流水号</label>
                                <input type="text" class="form-control" id="transactionId" name="transactionId" placeholder="请输入交易流水号">
                            </div>
                            <div class="col-12">
                                <label for="remarks" class="form-label">备注</label>
                                <textarea class="form-control" id="remarks" name="remarks" rows="2" placeholder="请输入备注信息"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addPayment()">
                        <i class="fas fa-save me-1"></i>保存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <th:block th:fragment="scripts">
        <!-- DataTables JS -->
        <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
        <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
        <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
        <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
        
        <!-- 缴费管理脚本 -->
        <script th:src="@{/js/modules/payment-management.js}"></script>
        
        <!-- 页面初始化脚本 -->
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // 设置当前页面标识
                document.body.setAttribute('data-current-page', 'payments');
                
                // 初始化缴费管理模块
                if (window.PaymentManagement) {
                    window.PaymentManagement.init();
                } else {
                    console.error('缴费管理模块未加载');
                }
                
                // 设置默认日期为今天
                document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            });
        </script>
    </th:block>
</body>
</html>
