<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle} + ' - 智慧校园管理系统'">安排课程 - 智慧校园管理系统</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- 引入组件样式 -->
    <th:block th:replace="~{components/topbar :: topbar-style}"></th:block>
    <!-- 侧边栏样式 -->
    <link th:href="@{/css/sidebar.css}" rel="stylesheet">
    <!-- 自定义样式 -->
    <link href="/css/admin.css" rel="stylesheet">
    <link href="/css/forms.css" rel="stylesheet">
</head>
<body>
    <div id="wrapper">
        <!-- 侧边栏 -->
        <th:block th:replace="~{components/sidebar :: sidebar}"></th:block>

        <!-- 内容包装器 -->
        <div id="content-wrapper" class="d-flex flex-column">
            <!-- 主要内容 -->
            <div id="content">
                <!-- 顶部导航栏 -->
                <th:block th:replace="~{components/topbar :: topbar}"></th:block>

                <!-- 页面内容开始 -->
                <div class="container-fluid">
                    <!-- 页面标题 -->
                    <div class="d-sm-flex align-items-center justify-content-between mb-4">
                        <h1 class="h3 mb-0 text-gray-800">
                            <i class="fas fa-calendar-plus"></i> 安排课程
                        </h1>
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item"><a th:href="@{/admin/dashboard}">仪表盘</a></li>
                                <li class="breadcrumb-item"><a th:href="@{/admin/schedules}">课程安排</a></li>
                                <li class="breadcrumb-item active">安排课程</li>
                            </ol>
                        </nav>
                    </div>

                    <!-- 课程安排表单 -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card shadow">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-primary">
                                        <i class="fas fa-calendar-alt"></i> 课程安排信息
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <!-- 填写说明 -->
                                    <div class="alert alert-info mb-4" role="alert">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6 class="alert-heading">
                                                    <i class="fas fa-lightbulb"></i> 填写提示
                                                </h6>
                                                <ul class="mb-0 small">
                                                    <li>请先选择课程、班级和教师</li>
                                                    <li>系统会自动检查时间冲突</li>
                                                    <li>总周数根据开始和结束日期自动计算</li>
                                                </ul>
                                            </div>
                                            <div class="col-md-6">
                                                <h6 class="alert-heading">
                                                    <i class="fas fa-exclamation-triangle"></i> 注意事项
                                                </h6>
                                                <ul class="mb-0 small">
                                                    <li>确保教师和教室在该时间段可用</li>
                                                    <li>课程安排一旦确定请谨慎修改</li>
                                                    <li>学期信息影响课程表显示</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>

                                    <form id="scheduleForm" method="post" th:action="@{/admin/schedules}" data-auto-save="schedule-form">
                                        <div class="row">
                                            <!-- 课程信息 -->
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="courseId" class="form-label">选择课程 <span class="text-danger">*</span></label>
                                                    <select class="form-select" id="courseId" name="courseId" required>
                                                        <option value="">请选择课程</option>
                                                        <option th:each="course : ${courses}" th:value="${course.id}" 
                                                                th:text="${course.code} + ' - ' + ${course.name} + ' (' + ${course.credits} + '学分)'"></option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="classId" class="form-label">选择班级 <span class="text-danger">*</span></label>
                                                    <select class="form-select" id="classId" name="classId" required>
                                                        <option value="">请选择班级</option>
                                                        <option th:each="clazz : ${classes}" th:value="${clazz.id}" th:text="${clazz.name}"></option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="teacherId" class="form-label">授课教师 <span class="text-danger">*</span></label>
                                                    <select class="form-select" id="teacherId" name="teacherId" required>
                                                        <option value="">请选择教师</option>
                                                        <option th:each="teacher : ${teachers}" th:value="${teacher.id}" th:text="${teacher.name}"></option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="classroom" class="form-label">教室 <span class="text-danger">*</span></label>
                                                    <select class="form-select" id="classroom" name="classroom" required>
                                                        <option value="">请选择教室</option>
                                                        <option th:each="room : ${classrooms}" th:value="${room}" th:text="${room}"></option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 时间安排 -->
                                        <hr>
                                        <h6 class="text-primary mb-3">
                                            <i class="fas fa-clock"></i> 时间安排
                                        </h6>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="dayOfWeek" class="form-label">星期 <span class="text-danger">*</span></label>
                                                    <select class="form-select" id="dayOfWeek" name="dayOfWeek" required>
                                                        <option value="">请选择星期</option>
                                                        <option value="1">星期一</option>
                                                        <option value="2">星期二</option>
                                                        <option value="3">星期三</option>
                                                        <option value="4">星期四</option>
                                                        <option value="5">星期五</option>
                                                        <option value="6">星期六</option>
                                                        <option value="7">星期日</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="timeSlot" class="form-label">时间段 <span class="text-danger">*</span></label>
                                                    <select class="form-select" id="timeSlot" name="timeSlot" required>
                                                        <option value="">请选择时间段</option>
                                                        <option value="08:00-09:40">第1-2节 (08:00-09:40)</option>
                                                        <option value="10:00-11:40">第3-4节 (10:00-11:40)</option>
                                                        <option value="14:00-15:40">第5-6节 (14:00-15:40)</option>
                                                        <option value="16:00-17:40">第7-8节 (16:00-17:40)</option>
                                                        <option value="19:00-20:40">第9-10节 (19:00-20:40)</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="startDate" class="form-label">开始日期 <span class="text-danger">*</span></label>
                                                    <input type="date" class="form-control" id="startDate" name="startDate" required>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="endDate" class="form-label">结束日期 <span class="text-danger">*</span></label>
                                                    <input type="date" class="form-control" id="endDate" name="endDate" required>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="totalWeeks" class="form-label">总周数</label>
                                                    <input type="number" class="form-control" id="totalWeeks" name="totalWeeks" 
                                                           min="1" max="20" placeholder="如：16" readonly>
                                                    <div class="form-text">根据开始和结束日期自动计算</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="semester" class="form-label">学期</label>
                                                    <input type="text" class="form-control" id="semester" name="semester" 
                                                           placeholder="如：2024年春季学期" value="2024年春季学期">
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 课程设置 -->
                                        <hr>
                                        <h6 class="text-primary mb-3">
                                            <i class="fas fa-cogs"></i> 课程设置
                                        </h6>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="maxStudents" class="form-label">最大选课人数</label>
                                                    <input type="number" class="form-control" id="maxStudents" name="maxStudents" 
                                                           min="1" max="200" placeholder="如：50">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="currentStudents" class="form-label">当前选课人数</label>
                                                    <input type="number" class="form-control" id="currentStudents" name="currentStudents" 
                                                           value="0" readonly>
                                                    <div class="form-text">系统自动统计</div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="status" class="form-label">状态</label>
                                                    <select class="form-select" id="status" name="status">
                                                        <option value="正常" selected>正常</option>
                                                        <option value="暂停">暂停</option>
                                                        <option value="取消">取消</option>
                                                        <option value="已结束">已结束</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">课程特性</label>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="allowDrop" name="allowDrop">
                                                        <label class="form-check-label" for="allowDrop">
                                                            允许退课
                                                        </label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="requireAttendance" name="requireAttendance" checked>
                                                        <label class="form-check-label" for="requireAttendance">
                                                            考勤必修
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label for="remarks" class="form-label">备注</label>
                                            <textarea class="form-control" id="remarks" name="remarks" rows="3" 
                                                      placeholder="请输入课程安排的备注信息"></textarea>
                                        </div>

                                        <!-- 表单按钮 -->
                                        <div class="d-flex justify-content-between">
                                            <a th:href="@{/admin/schedules}" class="btn btn-secondary">
                                                <i class="fas fa-arrow-left"></i> 返回列表
                                            </a>
                                            <div>
                                                <button type="reset" class="btn btn-outline-secondary me-2">
                                                    <i class="fas fa-undo"></i> 重置
                                                </button>
                                                <button type="submit" class="btn btn-primary">
                                                    <i class="fas fa-save"></i> 保存安排
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 页面内容结束 -->
            </div>
        </div>
    </div>

    <!-- 引入组件脚本 -->
    <th:block th:replace="~{components/sidebar :: sidebar-script}"></th:block>
    <th:block th:replace="~{components/topbar :: topbar-script}"></th:block>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 表单工具脚本 -->
    <script src="/js/forms.js"></script>

    <script>
        // 计算总周数
        function calculateWeeks() {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            
            if (startDate && endDate && endDate > startDate) {
                const timeDiff = endDate.getTime() - startDate.getTime();
                const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
                const weeks = Math.ceil(daysDiff / 7);
                document.getElementById('totalWeeks').value = weeks;
            }
        }

        // 监听日期变化
        document.getElementById('startDate').addEventListener('change', calculateWeeks);
        document.getElementById('endDate').addEventListener('change', calculateWeeks);

        // 检查时间冲突
        function checkTimeConflict() {
            const teacherId = document.getElementById('teacherId').value;
            const classroom = document.getElementById('classroom').value;
            const dayOfWeek = document.getElementById('dayOfWeek').value;
            const timeSlot = document.getElementById('timeSlot').value;
            
            if (teacherId && dayOfWeek && timeSlot) {
                // 这里可以添加AJAX请求检查教师时间冲突
                console.log('检查教师时间冲突:', teacherId, dayOfWeek, timeSlot);
            }
            
            if (classroom && dayOfWeek && timeSlot) {
                // 这里可以添加AJAX请求检查教室冲突
                console.log('检查教室冲突:', classroom, dayOfWeek, timeSlot);
            }
        }

        // 监听时间相关字段变化
        document.getElementById('teacherId').addEventListener('change', checkTimeConflict);
        document.getElementById('classroom').addEventListener('change', checkTimeConflict);
        document.getElementById('dayOfWeek').addEventListener('change', checkTimeConflict);
        document.getElementById('timeSlot').addEventListener('change', checkTimeConflict);

        // 表单验证
        document.getElementById('scheduleForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // 基本验证
            const courseId = document.getElementById('courseId').value;
            const classId = document.getElementById('classId').value;
            const teacherId = document.getElementById('teacherId').value;
            const classroom = document.getElementById('classroom').value;
            const dayOfWeek = document.getElementById('dayOfWeek').value;
            const timeSlot = document.getElementById('timeSlot').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!courseId || !classId || !teacherId || !classroom || !dayOfWeek || !timeSlot || !startDate || !endDate) {
                showAlert('请填写所有必填字段', 'danger');
                return;
            }
            
            // 日期验证
            if (new Date(startDate) >= new Date(endDate)) {
                showAlert('结束日期必须晚于开始日期', 'danger');
                return;
            }
            
            showAlert('课程安排保存成功！', 'success');
            
            // 模拟保存成功后跳转
            setTimeout(() => {
                window.location.href = '/admin/schedules';
            }, 1500);
        });

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            document.body.setAttribute('data-current-page', 'schedules');
            
            // 设置默认开始日期为下周一
            const today = new Date();
            const nextMonday = new Date(today);
            nextMonday.setDate(today.getDate() + (1 + 7 - today.getDay()) % 7);
            document.getElementById('startDate').value = nextMonday.toISOString().split('T')[0];
            
            // 设置默认结束日期为16周后
            const endDate = new Date(nextMonday);
            endDate.setDate(nextMonday.getDate() + 16 * 7);
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            
            // 计算初始周数
            calculateWeeks();
        });
    </script>
</body>
</html>
