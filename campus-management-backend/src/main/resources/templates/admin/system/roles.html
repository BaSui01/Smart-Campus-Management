<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/admin}">

<head>
    <!-- 页面特定的CSS -->
    <th:block layout:fragment="styles">
        <link rel="stylesheet" th:href="@{/css/components/data-table.css}">
        <link rel="stylesheet" th:href="@{/css/components/stats-cards.css}">
        <link rel="stylesheet" th:href="@{/css/components/toast.css}">
        <link rel="stylesheet" th:href="@{/css/admin/system.css}">
    </th:block>
</head>

<body>
    <!-- 页面标题 -->
    <th:block layout:fragment="page-title">角色管理</th:block>

    <!-- 面包屑导航 -->
    <th:block layout:fragment="breadcrumb">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/admin/dashboard}">首页</a></li>
                <li class="breadcrumb-item"><a th:href="@{/admin/system}">系统管理</a></li>
                <li class="breadcrumb-item active">角色管理</li>
            </ol>
        </nav>
    </th:block>

    <!-- 页面内容 -->
    <div layout:fragment="content">
        <!-- 页面标题区域 -->
        <div class="page-header-section animated fadeInDown">
            <div class="d-flex justify-content-between align-items-center">
                <div class="page-title-group">
                    <h1 class="page-title">
                        <i class="fas fa-user-tag me-2"></i>角色管理
                    </h1>
                    <p class="page-subtitle">管理系统角色和权限分配，控制用户访问权限</p>
                </div>
                <div class="page-actions">
                    <button type="button" class="btn btn-primary btn-enhanced" id="addRoleBtn">
                        <i class="fas fa-plus me-2"></i>添加角色
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-enhanced" id="refreshBtn">
                        <i class="fas fa-sync-alt me-2"></i>刷新
                    </button>
                </div>
            </div>
        </div>

        <!-- 统计卡片 -->
        <div class="dashboard-stats">
            <div class="row">
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stats-card stats-card-primary animated fadeInUp delay-1">
                        <div class="stats-card-body">
                            <div class="stats-card-content">
                                <div class="stats-card-info">
                                    <div class="stats-card-label">总角色数</div>
                                    <div class="stats-card-value counter" data-target="${roles?.totalElements ?: 0}" th:text="${roles?.totalElements ?: 0}">0</div>
                                    <div class="stats-card-change">
                                        <i class="fas fa-arrow-up text-success"></i>
                                        <span class="text-success">+2</span>
                                        <span class="text-muted">本月新增</span>
                                    </div>
                                </div>
                                <div class="stats-card-icon">
                                    <i class="fas fa-user-tag"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stats-card stats-card-success animated fadeInUp delay-2">
                        <div class="stats-card-body">
                            <div class="stats-card-content">
                                <div class="stats-card-info">
                                    <div class="stats-card-label">系统角色</div>
                                    <div class="stats-card-value counter" data-target="${systemRoleCount ?: 5}" id="systemRoles">5</div>
                                    <div class="stats-card-change">
                                        <i class="fas fa-shield-alt text-info"></i>
                                        <span class="text-info">内置</span>
                                        <span class="text-muted">系统角色</span>
                                    </div>
                                </div>
                                <div class="stats-card-icon">
                                    <i class="fas fa-cog"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stats-card stats-card-warning animated fadeInUp delay-3">
                        <div class="stats-card-body">
                            <div class="stats-card-content">
                                <div class="stats-card-info">
                                    <div class="stats-card-label">自定义角色</div>
                                    <div class="stats-card-value counter" data-target="${customRoleCount ?: 0}" id="customRoles">0</div>
                                    <div class="stats-card-change">
                                        <i class="fas fa-user-plus text-primary"></i>
                                        <span class="text-primary">可编辑</span>
                                        <span class="text-muted">用户创建</span>
                                    </div>
                                </div>
                                <div class="stats-card-icon">
                                    <i class="fas fa-user-plus"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stats-card stats-card-info animated fadeInUp delay-4">
                        <div class="stats-card-body">
                            <div class="stats-card-content">
                                <div class="stats-card-info">
                                    <div class="stats-card-label">权限总数</div>
                                    <div class="stats-card-value counter" data-target="${totalPermissions ?: 80}" id="totalPermissions">80</div>
                                    <div class="stats-card-change">
                                        <i class="fas fa-key text-warning"></i>
                                        <span class="text-warning">完整</span>
                                        <span class="text-muted">权限体系</span>
                                    </div>
                                </div>
                                <div class="stats-card-icon">
                                    <i class="fas fa-key"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 角色数据表格 -->
        <div class="data-table-container animated fadeInUp delay-5">
            <div class="table-toolbar">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="table-info">
                        <h6 class="mb-0">
                            <i class="fas fa-list me-2 text-primary"></i>角色列表
                        </h6>
                        <span class="total-records text-muted">
                            共 <span id="totalRecords" th:text="${roles?.totalElements ?: 0}">0</span> 个角色
                        </span>
                    </div>
                    <div class="table-controls">
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-primary action-btn" id="refreshTableBtn">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary action-btn" id="exportRolesBtn">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="table-wrapper">
                <table class="data-table table-striped table-hover" id="roleTable">
                    <thead class="table-header">
                        <tr>
                            <th class="sortable" data-column="roleName">
                                <div class="column-header">
                                    <span class="column-title">角色名称</span>
                                    <i class="sort-icon fas fa-sort"></i>
                                </div>
                            </th>
                            <th class="sortable" data-column="displayName">
                                <div class="column-header">
                                    <span class="column-title">显示名称</span>
                                    <i class="sort-icon fas fa-sort"></i>
                                </div>
                            </th>
                            <th>描述</th>
                            <th>类型</th>
                            <th class="sortable" data-column="userCount">
                                <div class="column-header">
                                    <span class="column-title">用户数量</span>
                                    <i class="sort-icon fas fa-sort"></i>
                                </div>
                            </th>
                            <th class="sortable" data-column="createTime">
                                <div class="column-header">
                                    <span class="column-title">创建时间</span>
                                    <i class="sort-icon fas fa-sort"></i>
                                </div>
                            </th>
                            <th width="180">操作</th>
                        </tr>
                    </thead>
                    <tbody class="table-body">
                        <tr th:each="role : ${roles.content}" class="table-row-clickable">
                            <td class="data-cell">
                                <code class="role-code" th:text="${role.roleName}">ROLE_ADMIN</code>
                            </td>
                            <td class="data-cell">
                                <div class="fw-bold" th:text="${role.description}">管理员</div>
                            </td>
                            <td class="data-cell text-truncate" th:text="${role.description ?: '无描述'}">系统管理员角色</td>
                            <td class="data-cell">
                                <span class="badge-enhanced badge-primary" th:if="${role.isSystemRole}">系统角色</span>
                                <span class="badge-enhanced badge-secondary" th:unless="${role.isSystemRole}">自定义角色</span>
                            </td>
                            <td class="data-cell">
                                <span class="fw-bold text-primary" th:text="${role.userCount ?: 0}">0</span>
                                <small class="text-muted">个用户</small>
                            </td>
                            <td class="data-cell">
                                <div class="d-flex flex-column">
                                    <small class="text-muted" th:text="${role.createTime != null ? #temporals.format(role.createTime, 'yyyy-MM-dd') : '未知'}">2024-01-01</small>
                                    <small class="text-muted" th:if="${role.createTime != null}" th:text="${#temporals.format(role.createTime, 'HH:mm:ss')}">00:00:00</small>
                                </div>
                            </td>
                            <td class="data-cell">
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-info row-action"
                                            th:onclick="|managePermissions(${role.id}, '${role.description}')|"
                                            title="管理权限">
                                        <i class="fas fa-key"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-warning row-action"
                                            th:onclick="|editRole(${role.id})|"
                                            title="编辑角色">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-primary row-action"
                                            th:onclick="|viewRoleUsers(${role.id})|"
                                            title="查看用户">
                                        <i class="fas fa-users"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-danger row-action"
                                            th:onclick="|deleteRole(${role.id})|"
                                            th:disabled="${role.isSystemRole}"
                                            title="删除角色">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    <!-- 添加角色模态框 -->
    <div class="modal fade modal-enhanced" id="addRoleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus me-2"></i>添加角色
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addRoleForm" class="needs-validation" novalidate>
                        <div class="form-group-enhanced">
                            <label for="roleName" class="form-label required">角色名称</label>
                            <div class="input-group-enhanced">
                                <span class="input-group-text">ROLE_</span>
                                <input type="text" class="form-control" id="roleName" name="roleName" required
                                       placeholder="请输入角色名称">
                            </div>
                            <div class="form-text">角色名称将自动添加ROLE_前缀并转换为大写</div>
                            <div class="invalid-feedback">请输入角色名称</div>
                        </div>
                        <div class="form-group-enhanced">
                            <label for="roleDisplayName" class="form-label required">显示名称</label>
                            <input type="text" class="form-control" id="roleDisplayName" name="roleDisplayName" required
                                   placeholder="请输入显示名称">
                            <div class="form-text">用于界面显示的友好名称</div>
                            <div class="invalid-feedback">请输入显示名称</div>
                        </div>
                        <div class="form-group-enhanced">
                            <label for="roleDescription" class="form-label">角色描述</label>
                            <textarea class="form-control" id="roleDescription" name="roleDescription" rows="3"
                                      placeholder="请输入角色功能描述（可选）"></textarea>
                            <div class="form-text">详细描述该角色的功能和用途</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>取消
                    </button>
                    <button type="button" class="btn btn-primary btn-enhanced" id="saveRoleBtn">
                        <i class="fas fa-save me-2"></i>保存角色
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑角色模态框 -->
    <div class="modal fade" id="editRoleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑角色</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editRoleForm">
                        <input type="hidden" id="editRoleId">
                        <div class="mb-3">
                            <label for="editRoleName" class="form-label">角色名称</label>
                            <input type="text" class="form-control" id="editRoleName" name="editRoleName">
                            <div class="form-text">系统角色不允许修改名称</div>
                        </div>
                        <div class="mb-3">
                            <label for="editRoleDisplayName" class="form-label">显示名称</label>
                            <input type="text" class="form-control" id="editRoleDisplayName" name="editRoleDisplayName">
                            <div class="form-text">系统角色不允许修改显示名称</div>
                        </div>
                        <div class="mb-3">
                            <label for="editRoleDescription" class="form-label">描述</label>
                            <textarea class="form-control" id="editRoleDescription" name="editRoleDescription" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveEditRoleBtn">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 权限管理模态框 -->
    <div class="modal fade modal-enhanced" id="permissionModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="permissionModalTitle">
                        <i class="fas fa-key me-2"></i>权限管理 - <span id="currentRoleName">角色名称</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="permissionRoleId">

                    <div class="row">
                        <!-- 权限树结构 -->
                        <div class="col-md-8">
                            <div class="card-enhanced">
                                <div class="card-header card-header-transparent">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <i class="fas fa-sitemap me-2"></i>权限分配
                                        </h6>
                                        <div class="btn-group btn-group-sm">
                                            <button type="button" class="btn btn-outline-primary" id="selectAllPermissionsBtn">
                                                <i class="fas fa-check-square me-1"></i>全选
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" id="clearAllPermissionsBtn">
                                                <i class="fas fa-square me-1"></i>清空
                                            </button>
                                            <button type="button" class="btn btn-outline-info" id="expandAllBtn">
                                                <i class="fas fa-expand-alt me-1"></i>展开
                                            </button>
                                            <button type="button" class="btn btn-outline-warning" id="collapseAllBtn">
                                                <i class="fas fa-compress-alt me-1"></i>收起
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="permission-tree" id="permissionTree">
                                        <!-- 权限树将由JavaScript动态生成 -->
                                        <div class="text-center p-4">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">加载中...</span>
                                            </div>
                                            <p class="mt-2 text-muted">正在加载权限数据...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 已选权限摘要 -->
                        <div class="col-md-4">
                            <div class="card-enhanced">
                                <div class="card-header card-header-transparent">
                                    <h6 class="mb-0">
                                        <i class="fas fa-check-circle me-2"></i>权限摘要
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="permission-summary mb-3">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="text-muted">总权限数:</span>
                                            <span class="fw-bold" id="totalPermissionCount">0</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="text-muted">已选权限:</span>
                                            <span class="fw-bold text-primary" id="selectedPermissionCount">0</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-3">
                                            <span class="text-muted">覆盖率:</span>
                                            <span class="fw-bold text-success" id="coveragePercentage">0%</span>
                                        </div>
                                        <div class="progress mb-3">
                                            <div class="progress-bar" role="progressbar" style="width: 0%" id="coverageProgressBar"></div>
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="selected-permissions-list" id="selectedPermissionsList" style="max-height: 300px; overflow-y: auto;">
                                        <p class="text-muted text-center">请选择权限</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-warning" id="resetPermissionsBtn">
                        <i class="fas fa-undo me-2"></i>重置
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>取消
                    </button>
                    <button type="button" class="btn btn-primary btn-enhanced" id="savePermissionsBtn">
                        <i class="fas fa-save me-2"></i>保存权限
                    </button>
                </div>
            </div>
        </div>
    </div>

        </div>

    </div>

    <!-- 页面特定的JavaScript -->
    <th:block layout:fragment="scripts">
        <!-- 引入组件库 -->
        <script th:src="@{/js/components/data-table.js}"></script>
        <script th:src="@{/js/components/form-builder.js}"></script>
        <script th:src="@{/js/components/toast.js}"></script>
        <script th:src="@{/js/common/utils.js}"></script>

        <!-- 引入角色管理模块 -->
        <script th:src="@{/js/modules/role-management.js}"></script>

        <!-- 角色管理页面脚本 -->
        <script>
            // 页面配置
            const pageConfig = {
                apiEndpoints: {
                    roles: '/api/admin/roles',
                    permissions: '/api/admin/permissions',
                    rolePermissions: '/api/admin/roles/{id}/permissions'
                }
            };

            // 页面加载完成后初始化
            document.addEventListener('DOMContentLoaded', function() {
                console.log('角色管理页面开始初始化...');

                // 初始化统计卡片动画
                if (window.Utils && window.Utils.initCounters) {
                    window.Utils.initCounters();
                }

                // 初始化数据表格组件
                if (window.DataTableComponent) {
                    window.roleDataTable = new DataTableComponent({
                        tableId: 'roleTable',
                        apiUrl: pageConfig.apiEndpoints.roles,
                        columns: [
                            { key: 'roleName', title: '角色名称', sortable: true },
                            { key: 'displayName', title: '显示名称', sortable: true },
                            { key: 'description', title: '描述', sortable: false },
                            { key: 'type', title: '类型', sortable: false },
                            { key: 'userCount', title: '用户数量', sortable: true },
                            { key: 'createTime', title: '创建时间', sortable: true },
                            { key: 'actions', title: '操作', sortable: false, width: '180px' }
                        ],
                        enableSelection: false,
                        enableSearch: false,
                        enableExport: true
                    });
                }

                // 初始化表单构建器
                if (window.FormBuilderComponent) {
                    window.roleFormBuilder = new FormBuilderComponent({
                        formId: 'addRoleForm',
                        validationRules: {
                            roleName: { required: true, minLength: 2, maxLength: 50 },
                            roleDisplayName: { required: true, minLength: 2, maxLength: 100 }
                        }
                    });
                }

                // 初始化Toast通知
                if (window.ToastComponent) {
                    window.toast = new ToastComponent({
                        position: 'top-right',
                        autoClose: true,
                        duration: 3000
                    });
                }

                // 绑定事件处理器
                bindEventHandlers();

                // 加载初始数据
                loadInitialData();

                console.log('角色管理页面初始化完成');
            });

            // 绑定事件处理器
            function bindEventHandlers() {
                // 添加角色按钮
                document.getElementById('addRoleBtn')?.addEventListener('click', function() {
                    showAddRoleModal();
                });

                // 刷新按钮
                document.getElementById('refreshBtn')?.addEventListener('click', function() {
                    refreshRoleList();
                });

                // 保存角色按钮
                document.getElementById('saveRoleBtn')?.addEventListener('click', function() {
                    saveRole();
                });

                // 保存权限按钮
                document.getElementById('savePermissionsBtn')?.addEventListener('click', function() {
                    savePermissions();
                });

                // 权限操作按钮
                document.getElementById('selectAllPermissionsBtn')?.addEventListener('click', function() {
                    toggleAllPermissions(true);
                });

                document.getElementById('clearAllPermissionsBtn')?.addEventListener('click', function() {
                    toggleAllPermissions(false);
                });

                document.getElementById('expandAllBtn')?.addEventListener('click', function() {
                    expandAllPermissionNodes();
                });

                document.getElementById('collapseAllBtn')?.addEventListener('click', function() {
                    collapseAllPermissionNodes();
                });

                document.getElementById('resetPermissionsBtn')?.addEventListener('click', function() {
                    resetPermissions();
                });
            }

            // 加载初始数据
            function loadInitialData() {
                // 加载角色列表
                if (window.roleDataTable) {
                    window.roleDataTable.loadData();
                }

                // 更新统计数据
                updateStatistics();
            }
        </script>
    </th:block>
</body>
</html>
