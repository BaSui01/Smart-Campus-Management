<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/admin :: html}"
      lang="zh-CN">
<head th:replace="~{layout/admin :: head}">
    <th:block th:fragment="head-extra">
        <title>用户管理 - 智慧校园管理系统</title>
        <!-- 网站图标 -->
        <link rel="icon" type="image/svg+xml" th:href="@{/images/favicon.svg}">
        <link rel="alternate icon" th:href="@{/favicon.ico}">
        <link rel="apple-touch-icon" th:href="@{/images/favicon.svg}">
    </th:block>
</head>
<body>
    <div th:fragment="content">
        <!-- 页面标题 -->
        <div th:replace="~{components/admin/admin-components :: page-header(
            title='用户管理',
            icon='fas fa-users',
            showAddButton=true,
            addButtonText='添加用户',
            addButtonTarget='#addUserModal'
        )}"></div>

        <!-- 统计卡片 -->
        <div th:replace="~{components/admin/admin-components :: stat-cards(${userStats})}"></div>

        <!-- 搜索筛选组件 -->
        <div th:replace="~{components/admin/admin-components :: search-filter('/admin/users', ${userFilters})}"></div>

        <!-- 数据表格组件 -->
        <div th:replace="~{components/admin/admin-components :: data-table(${userTableConfig}, ${users})}"></div>
    </div>

    <!-- 引入admin组件样式和脚本 -->
    <th:block th:replace="~{components/admin/admin-components :: admin-style}"></th:block>
    <th:block th:replace="~{components/admin/admin-components :: admin-script}"></th:block>

    <!-- 用户管理特定脚本 -->
    <script th:fragment="page-script">
        // 用户操作函数
        function viewUser(userId) {
            fetch(`/admin/users/${userId}/detail`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showUserDetailModal(data.user);
                    } else {
                        alert('获取用户详情失败：' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('获取用户详情失败，请稍后重试');
                });
        }

        function editUser(userId) {
            fetch(`/admin/users/${userId}/detail`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showEditUserModal(data.user);
                    } else {
                        alert('获取用户信息失败：' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('获取用户信息失败，请稍后重试');
                });
        }

        function resetPassword(userId) {
            if (confirm('确定要重置该用户的密码吗？重置后密码将变为默认密码。')) {
                fetch(`/admin/users/${userId}/reset-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('密码重置成功！新密码为：' + data.newPassword);
                    } else {
                        alert('重置密码失败：' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('重置密码失败，请稍后重试');
                });
            }
        }

        function toggleUserStatus(userId) {
            if (confirm('确定要切换该用户的状态吗？')) {
                fetch(`/admin/users/${userId}/toggle-status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('用户状态切换成功！');
                        window.location.reload();
                    } else {
                        alert('切换用户状态失败：' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('切换用户状态失败，请稍后重试');
                });
            }
        }

        // 显示用户详情模态框
        function showUserDetailModal(user) {
            // 简化的模态框实现
            alert(`用户详情：\n用户名：${user.username}\n真实姓名：${user.realName || '未设置'}\n邮箱：${user.email || '未设置'}\n角色：${user.roleName || '未分配'}\n状态：${user.status == 1 ? '正常' : '禁用'}`);
        }

        // 显示编辑用户模态框
        function showEditUserModal(user) {
            // 简化的编辑实现
            const newRealName = prompt('请输入新的真实姓名：', user.realName || '');
            if (newRealName !== null) {
                const userData = {
                    realName: newRealName,
                    email: user.email,
                    phone: user.phone,
                    status: user.status
                };

                fetch(`/admin/users/${user.id}/edit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('更新用户成功！');
                        window.location.reload();
                    } else {
                        alert('更新用户失败：' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('更新用户失败，请稍后重试');
                });
            }
        }
    </script>

    <!-- 添加用户模态框 -->
    <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addUserModalLabel">
                        <i class="fas fa-user-plus"></i> 添加用户
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm" novalidate>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="username" class="form-label">用户名 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="username" name="username" required>
                                    <div class="invalid-feedback">请输入用户名</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="realName" class="form-label">真实姓名 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="realName" name="realName" required>
                                    <div class="invalid-feedback">请输入真实姓名</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="email" class="form-label">邮箱 <span class="text-danger">*</span></label>
                                    <input type="email" class="form-control" id="email" name="email" required>
                                    <div class="invalid-feedback">请输入有效的邮箱地址</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="phone" class="form-label">手机号</label>
                                    <input type="tel" class="form-control" id="phone" name="phone">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="role" class="form-label">角色 <span class="text-danger">*</span></label>
                                    <select class="form-select" id="role" name="role" required>
                                        <option value="">请选择角色</option>
                                        <option value="STUDENT">学生</option>
                                        <option value="TEACHER">教师</option>
                                        <option value="FINANCE">财务</option>
                                        <option value="ADMIN">管理员</option>
                                    </select>
                                    <div class="invalid-feedback">请选择角色</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="status" class="form-label">状态</label>
                                    <select class="form-select" id="status" name="status">
                                        <option value="1" selected>正常</option>
                                        <option value="0">禁用</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="submitAddUserForm()">
                        <i class="fas fa-save"></i> 保存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加用户表单提交脚本 -->
    <script>
        function submitAddUserForm() {
            const form = document.getElementById('addUserForm');
            const formData = new FormData(form);

            // 验证表单
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }

            // 构建用户数据
            const userData = {
                username: formData.get('username'),
                realName: formData.get('realName'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                password: '123456', // 默认密码
                role: formData.get('role'),
                status: parseInt(formData.get('status'))
            };

            // 发送请求
            fetch('/admin/users/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(userData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('添加用户成功！默认密码：123456');
                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
                    modal.hide();
                    // 重置表单
                    form.reset();
                    form.classList.remove('was-validated');
                    // 刷新页面
                    window.location.reload();
                } else {
                    alert('添加用户失败：' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('添加用户失败，请稍后重试');
            });
        }
    </script>
</body>
</html>
