<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<!-- 顶部导航栏 -->
<nav th:fragment="topbar" class="topbar navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container-fluid">
        
        <!-- 左侧：侧边栏切换按钮 -->
        <div class="topbar-left">
            <button class="btn btn-link sidebar-toggle" id="sidebarToggle" type="button">
                <i class="fas fa-bars"></i>
            </button>
            
            <!-- 面包屑导航 (可选) -->
            <nav class="breadcrumb-nav d-none d-md-block" th:if="${breadcrumbs}">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item">
                        <a th:href="@{/admin/dashboard}">
                            <i class="fas fa-home"></i>
                            首页
                        </a>
                    </li>
                    <li class="breadcrumb-item" th:each="crumb : ${breadcrumbs}" 
                        th:classappend="${crumbStat.last ? 'active' : ''}">
                        <a th:if="${!crumbStat.last}" th:href="${crumb.url}" th:text="${crumb.name}">面包屑</a>
                        <span th:if="${crumbStat.last}" th:text="${crumb.name}">当前页面</span>
                    </li>
                </ol>
            </nav>
        </div>

        <!-- 右侧：工具栏 -->
        <div class="topbar-right">
            <ul class="navbar-nav ms-auto">
                
                <!-- 搜索框 -->
                <li class="nav-item dropdown d-none d-lg-block">
                    <form class="search-form" role="search">
                        <div class="input-group">
                            <input type="search" class="form-control search-input" placeholder="搜索..." aria-label="搜索">
                            <button class="btn btn-outline-secondary search-btn" type="submit">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </form>
                </li>

                <!-- 主题切换 -->
                <li class="nav-item dropdown">
                    <button class="btn btn-link nav-link" id="themeToggle" type="button" 
                            data-bs-toggle="tooltip" data-bs-placement="bottom" title="切换主题">
                        <i class="fas fa-moon theme-icon"></i>
                    </button>
                </li>

                <!-- 全屏切换 -->
                <li class="nav-item">
                    <button class="btn btn-link nav-link" id="fullscreenToggle" type="button"
                            data-bs-toggle="tooltip" data-bs-placement="bottom" title="全屏">
                        <i class="fas fa-expand"></i>
                    </button>
                </li>

                <!-- 通知 -->
                <li class="nav-item dropdown" th:if="${@permissionUtil.hasAnyRole('ROLE_SUPER_ADMIN', 'ROLE_ADMIN', 'ROLE_PRINCIPAL', 'ROLE_VICE_PRINCIPAL')}">
                    <a class="nav-link dropdown-toggle" href="#" id="notificationDropdown" role="button"
                       data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-bell"></i>
                        <span class="badge bg-danger notification-count" id="notificationCount">0</span>
                    </a>
                    <div class="dropdown-menu dropdown-menu-end notification-dropdown" aria-labelledby="notificationDropdown">
                        <div class="dropdown-header">
                            <h6 class="mb-0">通知</h6>
                            <small class="text-muted">您有 <span id="unreadCount">0</span> 条未读通知</small>
                        </div>
                        <div class="dropdown-divider"></div>
                        <div class="notification-list" id="notificationList">
                            <!-- 通知列表将通过JavaScript动态加载 -->
                            <div class="dropdown-item text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i>
                                加载中...
                            </div>
                        </div>
                        <div class="dropdown-divider"></div>
                        <div class="dropdown-footer">
                            <a th:href="@{/admin/notifications}" class="dropdown-item text-center">
                                查看所有通知
                            </a>
                        </div>
                    </div>
                </li>

                <!-- 消息 -->
                <li class="nav-item dropdown" th:if="${@permissionUtil.hasAnyRole('ROLE_SUPER_ADMIN', 'ROLE_ADMIN', 'ROLE_PRINCIPAL', 'ROLE_VICE_PRINCIPAL')}">
                    <a class="nav-link dropdown-toggle" href="#" id="messageDropdown" role="button"
                       data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-envelope"></i>
                        <span class="badge bg-primary message-count" id="messageCount">0</span>
                    </a>
                    <div class="dropdown-menu dropdown-menu-end message-dropdown" aria-labelledby="messageDropdown">
                        <div class="dropdown-header">
                            <h6 class="mb-0">消息</h6>
                            <small class="text-muted">您有 <span id="unreadMessageCount">0</span> 条未读消息</small>
                        </div>
                        <div class="dropdown-divider"></div>
                        <div class="message-list" id="messageList">
                            <!-- 消息列表将通过JavaScript动态加载 -->
                            <div class="dropdown-item text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i>
                                加载中...
                            </div>
                        </div>
                        <div class="dropdown-divider"></div>
                        <div class="dropdown-footer">
                            <a th:href="@{/admin/messages}" class="dropdown-item text-center">
                                查看所有消息
                            </a>
                        </div>
                    </div>
                </li>

                <!-- 用户菜单 -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle user-dropdown" href="#" id="userDropdown" role="button"
                       data-bs-toggle="dropdown" aria-expanded="false">
                        <img th:src="@{/images/default-avatar.svg}" alt="用户头像" class="user-avatar">
                        <span class="user-name d-none d-md-inline" 
                              th:text="${session.currentUser?.realName ?: session.currentUser?.username ?: '用户'}">用户</span>
                        <i class="fas fa-chevron-down ms-1"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-end user-menu" aria-labelledby="userDropdown">
                        <div class="dropdown-header">
                            <div class="user-info">
                                <img th:src="@{/images/default-avatar.svg}" alt="用户头像" class="user-avatar-large">
                                <div class="user-details">
                                    <div class="user-name" th:text="${session.currentUser?.realName ?: session.currentUser?.username ?: '用户'}">用户</div>
                                    <div class="user-email" th:text="${session.currentUser?.email ?: ''}">邮箱</div>
                                    <div class="user-role" th:text="${session.userRoles != null and !session.userRoles.isEmpty() ? session.userRoles[0] : '普通用户'}">角色</div>
                                </div>
                            </div>
                        </div>
                        <div class="dropdown-divider"></div>
                        
                        <a th:href="@{/admin/profile}" class="dropdown-item">
                            <i class="fas fa-user me-2"></i>
                            个人资料
                        </a>
                        
                        <a th:href="@{/admin/settings}" class="dropdown-item" 
                           th:if="${@permissionUtil.hasAnyRole('ROLE_SUPER_ADMIN', 'ROLE_ADMIN')}">
                            <i class="fas fa-cogs me-2"></i>
                            系统设置
                        </a>
                        
                        <a th:href="@{/admin/activity-log}" class="dropdown-item">
                            <i class="fas fa-history me-2"></i>
                            活动记录
                        </a>
                        
                        <div class="dropdown-divider"></div>
                        
                        <a href="#" class="dropdown-item text-danger" data-bs-toggle="modal" data-bs-target="#logoutModal">
                            <i class="fas fa-sign-out-alt me-2"></i>
                            退出登录
                        </a>
                    </div>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- 退出登录确认模态框 -->
<div th:fragment="logout-modal" class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logoutModalLabel">
                    <i class="fas fa-sign-out-alt me-2"></i>
                    确认退出
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <i class="fas fa-question-circle text-warning fa-3x mb-3"></i>
                    <p class="mb-0">确定要退出当前登录会话吗？</p>
                    <small class="text-muted">退出后需要重新登录才能访问系统。</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    取消
                </button>
                <a th:href="@{/admin/logout}" class="btn btn-danger">
                    <i class="fas fa-sign-out-alt me-1"></i>
                    确认退出
                </a>
            </div>
        </div>
    </div>
</div>

<!-- 搜索结果模态框 -->
<div th:fragment="search-modal" class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="searchModalLabel">
                    <i class="fas fa-search me-2"></i>
                    搜索结果
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                <div class="search-results" id="searchResults">
                    <!-- 搜索结果将通过JavaScript动态加载 -->
                </div>
            </div>
        </div>
    </div>
</div>

</html>
