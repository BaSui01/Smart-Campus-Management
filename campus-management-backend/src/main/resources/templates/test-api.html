<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIæµ‹è¯•é¡µé¢ - æ™ºæ…§æ ¡å›­ç®¡ç†ç³»ç»Ÿ</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- è‡ªå®šä¹‰CSS -->
    <link th:href="@{/css/admin.css}" rel="stylesheet">

    <!-- å¼•å…¥ç»„ä»¶æ ·å¼ -->
    <th:block th:replace="~{components/sidebar :: sidebar-style}"></th:block>
    <th:block th:replace="~{components/topbar :: topbar-style}"></th:block>
    <th:block th:replace="~{components/admin/admin-components :: admin-style}"></th:block>

    <!-- ä»£ç é«˜äº® -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css">
</head>
<body>
    <!-- å¸ƒå±€å®¹å™¨ -->
    <div class="wrapper">
        <!-- å·¦ä¾§å¯¼èˆªæ  -->
        <th:block th:replace="~{components/sidebar :: sidebar}"></th:block>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="content" id="content">
            <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
            <th:block th:replace="~{components/topbar :: topbar}"></th:block>

            <!-- é¡µé¢å†…å®¹åŒ…è£…å™¨ -->
            <div class="content-wrapper">
                <div th:fragment="content">
        <!-- ä½¿ç”¨admin-componentsçš„é¡µé¢æ ‡é¢˜ç»„ä»¶ -->
        <div th:replace="~{components/admin/admin-components :: page-header(
            title='APIæµ‹è¯•é¡µé¢',
            icon='fas fa-code',
            showAddButton=false,
            addButtonText='',
            addButtonTarget=''
        )}"></div>

        <!-- APIåŠŸèƒ½ç»Ÿè®¡å¡ç‰‡ -->
        <div th:replace="~{components/admin/admin-components :: stat-cards(${apiStats})}"></div>

        <!-- APIåˆ†ç±»å¯¼èˆª -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <nav class="nav nav-pills nav-fill">
                            <a class="nav-link active" href="#" onclick="filterByCategory('all')">å…¨éƒ¨æ¥å£</a>
                            <a class="nav-link" href="#" onclick="filterByCategory('æµ‹è¯•æ¥å£')">æµ‹è¯•æ¥å£</a>
                            <a class="nav-link" href="#" onclick="filterByCategory('ä»ªè¡¨ç›˜API')">ä»ªè¡¨ç›˜API</a>
                            <a class="nav-link" href="#" onclick="filterByCategory('å­¦ç”Ÿç®¡ç†API')">å­¦ç”Ÿç®¡ç†</a>
                            <a class="nav-link" href="#" onclick="filterByCategory('ç­çº§ç®¡ç†API')">ç­çº§ç®¡ç†</a>
                            <a class="nav-link" href="#" onclick="filterByCategory('è¯¾ç¨‹ç®¡ç†API')">è¯¾ç¨‹ç®¡ç†</a>
                            <a class="nav-link" href="#" onclick="filterByCategory('æˆç»©ç®¡ç†API')">æˆç»©ç®¡ç†</a>
                            <a class="nav-link" href="#" onclick="filterByCategory('ç¼´è´¹ç®¡ç†API')">ç¼´è´¹ç®¡ç†</a>
                            <a class="nav-link" href="#" onclick="filterByCategory('ç”¨æˆ·ç®¡ç†API')">ç”¨æˆ·ç®¡ç†</a>
                            <a class="nav-link" href="#" onclick="filterByCategory('è®¤è¯API')">è®¤è¯API</a>
                            <a class="nav-link" href="#" onclick="filterByCategory('ç³»ç»Ÿç®¡ç†API')">ç³»ç»Ÿç®¡ç†</a>
                        </nav>
                    </div>
                </div>
            </div>
        </div>

        <!-- è®¤è¯çŠ¶æ€æç¤º -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert alert-info" id="auth-status">
                    <i class="fas fa-info-circle me-2"></i>
                    <span id="auth-message">æ­£åœ¨æ£€æŸ¥è®¤è¯çŠ¶æ€...</span>
                </div>
            </div>
        </div>

        <!-- å¿«é€Ÿæ“ä½œæŒ‰é’® -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-rocket text-primary me-2"></i>
                                å¿«é€Ÿæ“ä½œ
                            </h5>
                            <div>
                                <button class="btn btn-outline-secondary me-2" onclick="clearAllResults()">
                                    <i class="fas fa-trash me-1"></i>æ¸…ç©ºç»“æœ
                                </button>
                                <button class="btn btn-primary" onclick="testAllApis()" title="æµ‹è¯•GETæ¥å£å’Œå®‰å…¨çš„POSTæ¥å£">
                                    <i class="fas fa-play me-1"></i>æ‰¹é‡æµ‹è¯•
                                </button>
                                <a href="/api/swagger-ui.html" target="_blank" class="btn btn-info ms-2">
                                    <i class="fas fa-book me-1"></i>APIæ–‡æ¡£
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä½¿ç”¨è¯´æ˜ -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            ä½¿ç”¨è¯´æ˜
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary">ğŸ” å•ä¸ªæµ‹è¯•</h6>
                                <ul class="small mb-3">
                                    <li><strong>GETè¯·æ±‚</strong>ï¼šç›´æ¥æµ‹è¯•ï¼Œæ— éœ€é¢å¤–æ•°æ®</li>
                                    <li><strong>POST/PUTè¯·æ±‚</strong>ï¼šè‡ªåŠ¨æä¾›ç¤ºä¾‹æµ‹è¯•æ•°æ®</li>
                                    <li><strong>è®¤è¯æ¥å£</strong>ï¼šè‡ªåŠ¨æºå¸¦admin JWT token</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success">âš¡ æ‰¹é‡æµ‹è¯•</h6>
                                <ul class="small mb-3">
                                    <li><strong>å®‰å…¨æ¥å£</strong>ï¼šåªæµ‹è¯•GETå’Œå®‰å…¨çš„POSTæ¥å£</li>
                                    <li><strong>è‡ªåŠ¨æ•°æ®</strong>ï¼šPOSTè¯·æ±‚è‡ªåŠ¨æä¾›æµ‹è¯•æ•°æ®</li>
                                    <li><strong>å»¶è¿Ÿæ§åˆ¶</strong>ï¼šé¿å…è¯·æ±‚è¿‡å¿«å¯¼è‡´æœåŠ¡å™¨å‹åŠ›</li>
                                </ul>
                            </div>
                        </div>
                        <div class="alert alert-warning mb-0 small">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            <strong>æ³¨æ„ï¼š</strong>POST/PUT/DELETEè¯·æ±‚å¯èƒ½ä¼šä¿®æ”¹æ•°æ®åº“æ•°æ®ï¼Œè¯·è°¨æ…æµ‹è¯•ã€‚å»ºè®®ä¼˜å…ˆæµ‹è¯•GETæ¥å£ã€‚
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- APIæµ‹è¯•å†…å®¹ -->
        <div class="row">
            <!-- APIåˆ—è¡¨ -->
            <div class="col-md-6">
                <div th:replace="~{components/admin/admin-components :: data-table(
                    tableConfig=${apiTableConfig},
                    data=${testApis}
                )}"></div>
            </div>

            <!-- å“åº”ç»“æœ -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-terminal text-info me-2"></i>
                            å“åº”ç»“æœ
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="api-results">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-code fa-3x mb-3"></i>
                                <p>ç‚¹å‡»å·¦ä¾§APIåˆ—è¡¨ä¸­çš„"æµ‹è¯•"æŒ‰é’®æŸ¥çœ‹å“åº”ç»“æœ</p>
                            </div>
                        </div>

                        <!-- åŠ¨æ€ç»“æœå®¹å™¨ -->
                        <div id="api-response-container">
                            <!-- å“åº”ç»“æœå°†åŠ¨æ€æ’å…¥åˆ°è¿™é‡Œ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>




                </div>
            </div>
        </div>
    </div>

    <!-- é€€å‡ºç™»å½•ç¡®è®¤æ¨¡æ€æ¡† -->
    <th:block th:replace="~{components/topbar :: logout-modal}"></th:block>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <!-- ä»£ç é«˜äº® -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <!-- å¼•å…¥ä¾§è¾¹æ è„šæœ¬ -->
    <th:block th:replace="~{components/sidebar :: sidebar-script}"></th:block>
    <!-- å¼•å…¥adminç»„ä»¶è„šæœ¬ -->
    <th:block th:replace="~{components/admin/admin-components :: admin-script}"></th:block>

    <!-- APIæµ‹è¯•é¡µé¢ç‰¹å®šæ ·å¼ -->
    <style>
        .api-item {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }

        .api-item:hover {
            background: #e9ecef;
            transition: background 0.2s;
        }

        .result-container {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background: #ffffff;
        }

        .result-container h6 {
            color: #495057;
            margin-bottom: 10px;
        }

        .result-container pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .badge {
            font-size: 0.75rem;
            min-width: 50px;
        }

        .nav-pills .nav-link {
            border-radius: 20px;
            margin: 0 5px;
        }

        .nav-pills .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .success-response {
            border-left: 4px solid #28a745;
        }

        .error-response {
            border-left: 4px solid #dc3545;
        }
    </style>

    <!-- APIæµ‹è¯•JavaScript -->
    <script>
        // å…¨å±€å˜é‡
        let testResults = {};
        let allApiData = [];

        // æŒ‰åˆ†ç±»ç­›é€‰API
        function filterByCategory(category) {
            const tableRows = document.querySelectorAll('tbody tr');

            // æ›´æ–°å¯¼èˆªæ æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');

            // ç­›é€‰æ˜¾ç¤º
            tableRows.forEach(row => {
                const categoryCell = row.querySelector('td:nth-child(4)');
                if (categoryCell) {
                    const rowCategory = categoryCell.textContent.trim();
                    if (category === 'all' || rowCategory === category) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            });

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateFilterStats(category);
        }

        // æ›´æ–°ç­›é€‰ç»Ÿè®¡ä¿¡æ¯
        function updateFilterStats(category) {
            const visibleRows = document.querySelectorAll('tbody tr[style=""], tbody tr:not([style])');
            const totalCount = visibleRows.length;

            // æ›´æ–°é¡µé¢ä¸Šçš„ç»Ÿè®¡ä¿¡æ¯
            const recordCountElement = document.getElementById('record-count');
            if (recordCountElement) {
                recordCountElement.textContent = totalCount;
            }

            console.log(`å½“å‰åˆ†ç±»: ${category}, æ˜¾ç¤ºæ¥å£æ•°: ${totalCount}`);
        }

        // é€šç”¨APIæµ‹è¯•å‡½æ•°
        async function testApi(method, url, data, resultId) {
            const button = event.target.closest('button');
            await testApiWithButton(method, url, data, resultId, button);
        }

        // è·å–å½“å‰adminç”¨æˆ·çš„JWT token
        function getAdminToken() {
            // å°è¯•ä»å¤šä¸ªæ¥æºè·å–token
            let token = null;

            // 1. ä»localStorageè·å–
            token = localStorage.getItem('adminToken');
            if (token) return token;

            // 2. ä»sessionStorageè·å–
            token = sessionStorage.getItem('adminToken');
            if (token) return token;

            // 3. ä»cookieè·å–
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'adminToken' || name === 'accessToken') {
                    return value;
                }
            }

            return null;
        }

        // å¸¦æŒ‰é’®å‚æ•°çš„APIæµ‹è¯•å‡½æ•°
        async function testApiWithButton(method, url, data, resultId, button) {
            let originalText = '';

            if (button) {
                originalText = button.innerHTML;
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                button.disabled = true;
            }

            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };

                // æ·»åŠ adminè®¤è¯token
                const token = getAdminToken();
                if (token) {
                    options.headers['Authorization'] = `Bearer ${token}`;
                    console.log('APIè¯·æ±‚è¯¦æƒ…:', {
                        url: url,
                        method: method,
                        token: token.substring(0, 20) + '...',
                        headers: options.headers
                    });
                } else {
                    console.warn('æœªæ‰¾åˆ°admin tokenï¼ŒAPIè¯·æ±‚å¯èƒ½å¤±è´¥');
                }

                if (data) {
                    options.body = JSON.stringify(data);
                }

                const response = await fetch(url, options);

                // å°è¯•è§£æJSONå“åº”
                let result;
                try {
                    result = await response.json();
                } catch (e) {
                    // å¦‚æœä¸æ˜¯JSONå“åº”ï¼Œè·å–æ–‡æœ¬å†…å®¹
                    result = {
                        status: response.status,
                        statusText: response.statusText,
                        message: await response.text() || 'æ— å“åº”å†…å®¹'
                    };
                }

                // æ˜¾ç¤ºç»“æœ
                displayResult(resultId, result, response.ok);

                // ä¿å­˜ç»“æœ
                testResults[resultId] = {
                    url: url,
                    method: method,
                    status: response.status,
                    data: result,
                    success: response.ok,
                    timestamp: new Date().toISOString()
                };

            } catch (error) {
                const errorResult = {
                    error: true,
                    message: error.message,
                    timestamp: new Date().toISOString()
                };

                displayResult(resultId, errorResult, false);

                testResults[resultId] = {
                    url: url,
                    method: method,
                    error: error.message,
                    success: false,
                    timestamp: new Date().toISOString()
                };
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (button) {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            }
        }

        // è·å–APIæµ‹è¯•æ•°æ®
        function getTestDataForApi(method, url) {
            // åªä¸ºPOSTã€PUTã€PATCHè¯·æ±‚æä¾›æµ‹è¯•æ•°æ®
            if (!['POST', 'PUT', 'PATCH'].includes(method)) {
                return null;
            }

            // æ ¹æ®URLè·¯å¾„æä¾›ç›¸åº”çš„æµ‹è¯•æ•°æ®
            if (url.includes('/api/auth/login')) {
                return {
                    username: "admin",
                    password: "admin123"
                };
            } else if (url.includes('/api/auth/register')) {
                return {
                    username: "testuser" + Date.now(),
                    password: "test123",
                    email: "test@example.com",
                    realName: "æµ‹è¯•ç”¨æˆ·"
                };
            } else if (url.includes('/api/students')) {
                return {
                    studentNo: "TEST" + Date.now(),
                    realName: "æµ‹è¯•å­¦ç”Ÿ",
                    gender: "ç”·",
                    birthday: "2000-01-01",
                    phone: "13800138000",
                    email: "student@example.com",
                    classId: 1,
                    status: 1
                };
            } else if (url.includes('/api/classes')) {
                return {
                    className: "æµ‹è¯•ç­çº§" + Date.now(),
                    classCode: "TEST" + Date.now(),
                    grade: "2024",
                    majorId: 1,
                    teacherId: 1,
                    maxStudents: 30,
                    status: 1
                };
            } else if (url.includes('/api/courses')) {
                return {
                    courseName: "æµ‹è¯•è¯¾ç¨‹" + Date.now(),
                    courseCode: "TEST" + Date.now(),
                    credits: 3,
                    courseType: "å¿…ä¿®",
                    semester: "2024-1",
                    teacherId: 1,
                    status: 1
                };
            } else if (url.includes('/api/users')) {
                return {
                    username: "testuser" + Date.now(),
                    password: "test123",
                    realName: "æµ‹è¯•ç”¨æˆ·",
                    email: "user@example.com",
                    phone: "13800138000",
                    status: 1
                };
            } else if (url.includes('/api/grades')) {
                return {
                    studentId: 1,
                    courseId: 1,
                    score: 85,
                    semester: "2024-1",
                    examType: "æœŸæœ«è€ƒè¯•"
                };
            } else if (url.includes('/api/payments') || url.includes('/api/fee-items')) {
                return {
                    amount: 1000.00,
                    feeType: "å­¦è´¹",
                    description: "æµ‹è¯•ç¼´è´¹é¡¹ç›®",
                    dueDate: "2024-12-31",
                    status: 1
                };
            }

            // é»˜è®¤æµ‹è¯•æ•°æ®
            return {
                name: "æµ‹è¯•æ•°æ®",
                description: "APIæµ‹è¯•ç”¨æ•°æ®",
                status: 1,
                createTime: new Date().toISOString()
            };
        }

        // æµ‹è¯•å•ä¸ªAPIï¼ˆä»è¡¨æ ¼æ“ä½œæŒ‰é’®è°ƒç”¨ï¼‰
        function testSingleApi(id, buttonElement) {
            // ä»è¡¨æ ¼è¡Œä¸­è·å–APIä¿¡æ¯
            let button = buttonElement;
            if (!button && window.event && window.event.target) {
                button = window.event.target.closest('button');
            }

            if (!button) {
                console.error('æ— æ³•æ‰¾åˆ°æŒ‰é’®å…ƒç´ ');
                return;
            }

            const row = button.closest('tr');
            const cells = row.querySelectorAll('td');

            if (cells.length >= 4) {
                const method = cells[0].textContent.trim();
                const url = cells[1].textContent.trim();
                const description = cells[2].textContent.trim();
                const resultId = 'test-' + url.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();

                // è·å–æµ‹è¯•æ•°æ®
                const testData = getTestDataForApi(method, url);

                // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
                const resultsContainer = document.getElementById('api-response-container');
                resultsContainer.innerHTML = '';

                // åˆ›å»ºç»“æœå®¹å™¨
                const resultContainer = document.createElement('div');
                resultContainer.id = resultId;
                resultContainer.className = 'result-container mb-3';

                let requestInfo = `<strong>è¯·æ±‚æ–¹æ³•:</strong> ${method}<br><strong>è¯·æ±‚URL:</strong> ${url}`;
                if (testData) {
                    requestInfo += `<br><strong>è¯·æ±‚æ•°æ®:</strong><br><pre>${JSON.stringify(testData, null, 2)}</pre>`;
                }

                resultContainer.innerHTML = `
                    <h6>${description} å“åº”ï¼š</h6>
                    <div class="mb-2 text-muted small">${requestInfo}</div>
                    <pre><code class="language-json">æ­£åœ¨è¯·æ±‚...</code></pre>
                `;
                resultsContainer.appendChild(resultContainer);

                // éšè—é»˜è®¤æç¤º
                document.getElementById('api-results').style.display = 'none';

                // è°ƒç”¨APIæµ‹è¯•ï¼ˆä¼ é€’æŒ‰é’®å…ƒç´ å’Œæµ‹è¯•æ•°æ®ï¼‰
                testApiWithButton(method, url, testData, resultId, button);
            }
        }

        // å¤åˆ¶API URL
        function copyApiUrl(id, buttonElement) {
            let button = buttonElement;
            if (!button && window.event && window.event.target) {
                button = window.event.target.closest('button');
            }
            
            if (!button) {
                console.error('æ— æ³•æ‰¾åˆ°æŒ‰é’®å…ƒç´ ');
                return;
            }
            
            const row = button.closest('tr');
            const cells = row.querySelectorAll('td');

            if (cells.length >= 2) {
                const url = window.location.origin + cells[1].textContent.trim();
                navigator.clipboard.writeText(url).then(() => {
                    showToast('APIåœ°å€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                }).catch(() => {
                    showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                });
            }
        }

        // æ˜¾ç¤ºAPIå“åº”ç»“æœ
        function displayResult(resultId, data, isSuccess) {
            const container = document.getElementById(resultId);
            if (!container) return;

            const codeElement = container.querySelector('code');
            if (codeElement) {
                codeElement.textContent = JSON.stringify(data, null, 2);

                // æ·»åŠ æˆåŠŸ/å¤±è´¥æ ·å¼
                container.className = `result-container mb-3 ${isSuccess ? 'success-response' : 'error-response'}`;

                // æ˜¾ç¤ºå®¹å™¨
                container.style.display = 'block';

                // é‡æ–°åº”ç”¨ä»£ç é«˜äº®
                if (window.Prism) {
                    Prism.highlightElement(codeElement);
                }

                // æ»šåŠ¨åˆ°ç»“æœ
                container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // æµ‹è¯•åˆ›å»ºå­¦ç”ŸAPI
        async function testCreateStudent() {
            const studentData = {
                studentNo: "TEST" + Date.now(),
                realName: "æµ‹è¯•å­¦ç”Ÿ",
                gender: "ç”·",
                birthday: "2000-01-01",
                phone: "13800138000",
                email: "test@example.com",
                classId: 1,
                status: 1
            };

            await testApi('POST', '/api/students', studentData, 'students-create');
        }

        // æ¸…ç©ºæ‰€æœ‰ç»“æœ
        function clearAllResults() {
            const resultsContainer = document.getElementById('api-response-container');
            resultsContainer.innerHTML = '';

            // æ˜¾ç¤ºé»˜è®¤æç¤º
            document.getElementById('api-results').style.display = 'block';

            testResults = {};

            // æ˜¾ç¤ºæ¸…ç©ºæˆåŠŸæ¶ˆæ¯
            showToast('æ‰€æœ‰æµ‹è¯•ç»“æœå·²æ¸…ç©º', 'success');
        }

        // æµ‹è¯•æ‰€æœ‰å¯è§çš„å®‰å…¨API
        async function testAllApis() {
            const visibleRows = document.querySelectorAll('tbody tr[style=""], tbody tr:not([style])');
            const safeApis = [];

            visibleRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 4) {
                    const method = cells[0].textContent.trim();
                    const url = cells[1].textContent.trim();
                    const description = cells[2].textContent.trim();

                    // ä¼˜å…ˆæµ‹è¯•GETè¯·æ±‚ï¼Œä¹ŸåŒ…å«ä¸€äº›å®‰å…¨çš„POSTè¯·æ±‚
                    const isSafeApi = method === 'GET' ||
                                     (method === 'POST' && (
                                         url.includes('/api/auth/login') ||
                                         url.includes('/api/test/') ||
                                         url.includes('/search') ||
                                         url.includes('/stats') ||
                                         url.includes('/check')
                                     ));

                    if (isSafeApi) {
                        safeApis.push({
                            method: method,
                            url: url,
                            description: description,
                            resultId: 'test-' + url.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase()
                        });
                    }
                }
            });

            if (safeApis.length === 0) {
                showToast('å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ²¡æœ‰å¯æµ‹è¯•çš„å®‰å…¨æ¥å£', 'warning');
                return;
            }

            showToast(`å¼€å§‹æ‰¹é‡æµ‹è¯• ${safeApis.length} ä¸ªå®‰å…¨æ¥å£...`, 'info');

            // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
            clearAllResults();

            const resultsContainer = document.getElementById('api-response-container');

            for (const api of safeApis) {
                try {
                    // è·å–æµ‹è¯•æ•°æ®ï¼ˆå¦‚æœéœ€è¦ï¼‰
                    const testData = getTestDataForApi(api.method, api.url);

                    // åˆ›å»ºç»“æœå®¹å™¨
                    const resultContainer = document.createElement('div');
                    resultContainer.id = api.resultId;
                    resultContainer.className = 'result-container mb-3';

                    let requestInfo = `<strong>${api.method}</strong> ${api.url}`;
                    if (testData) {
                        requestInfo += ` <small class="text-muted">(æºå¸¦æµ‹è¯•æ•°æ®)</small>`;
                    }

                    resultContainer.innerHTML = `
                        <h6>${api.description} å“åº”ï¼š</h6>
                        <div class="mb-2 text-muted small">${requestInfo}</div>
                        <pre><code class="language-json">æ­£åœ¨è¯·æ±‚...</code></pre>
                    `;
                    resultsContainer.appendChild(resultContainer);

                    // æµ‹è¯•APIï¼ˆä¸ä¼ é€’æŒ‰é’®ï¼Œå› ä¸ºæ˜¯æ‰¹é‡æµ‹è¯•ï¼‰
                    await testApiWithButton(api.method, api.url, testData, api.resultId, null);

                    // æ·»åŠ å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡å¿«
                    await new Promise(resolve => setTimeout(resolve, 500));
                } catch (error) {
                    console.error(`æµ‹è¯• ${api.url} å¤±è´¥:`, error);
                }
            }

            showToast('æ‰¹é‡æµ‹è¯•å®Œæˆï¼', 'success');
        }

        // å¤„ç†è¡¨æ ¼æ“ä½œæŒ‰é’®ï¼ˆå…¼å®¹admin-componentsçš„è°ƒç”¨æ–¹å¼ï¼‰
        function handleAction(button) {
            // æ”¯æŒä¸¤ç§è°ƒç”¨æ–¹å¼ï¼šhandleAction(button) å’Œ handleAction(action, id)
            if (typeof button === 'string') {
                // ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯actionï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯id
                const action = button;
                const id = arguments[1];
                switch(action) {
                    case 'test':
                        testSingleApi(id);
                        break;
                    case 'copy':
                        copyApiUrl(id);
                        break;
                    default:
                        console.log(`æœªçŸ¥æ“ä½œ: ${action}, ID: ${id}`);
                }
            } else {
                // æŒ‰é’®å¯¹è±¡ä½œä¸ºå‚æ•°ï¼ˆadmin-componentsçš„è°ƒç”¨æ–¹å¼ï¼‰
                const functionName = button.getAttribute('data-function');
                const id = button.getAttribute('data-id');
                
                switch(functionName) {
                    case 'test':
                        testSingleApi(id, button);
                        break;
                    case 'copy':
                        copyApiUrl(id, button);
                        break;
                    default:
                        // å°è¯•è°ƒç”¨å…¨å±€å‡½æ•°
                        if (typeof window[functionName] === 'function') {
                            window[functionName](id, button);
                        } else {
                            console.error('Function not found:', functionName);
                        }
                }
            }
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'info') {
            // åˆ›å»ºtoastå…ƒç´ 
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(toast);

            // è‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–ç»Ÿè®¡ä¿¡æ¯ï¼ˆæ˜¾ç¤ºå…¨éƒ¨æ¥å£æ•°é‡ï¼‰
            updateFilterStats('all');
        });

        // ç¡®ä¿å‡½æ•°åœ¨å…¨å±€ä½œç”¨åŸŸä¸­å¯ç”¨
        window.filterByCategory = filterByCategory;
        window.handleAction = handleAction;
        window.testSingleApi = testSingleApi;
        window.copyApiUrl = copyApiUrl;
        window.clearAllResults = clearAllResults;
        window.testAllApis = testAllApis;
        window.testApi = testApi;
        window.testApiWithButton = testApiWithButton;
        window.showToast = showToast;

        // æ›´æ–°è®¤è¯çŠ¶æ€æ˜¾ç¤º
        function updateAuthStatus(isAuthenticated, username, message) {
            const authStatus = document.getElementById('auth-status');
            const authMessage = document.getElementById('auth-message');

            if (isAuthenticated) {
                authStatus.className = 'alert alert-success';
                authMessage.innerHTML = `<i class="fas fa-check-circle me-2"></i>å·²é€šè¿‡ç®¡ç†å‘˜è®¤è¯ (${username}) - APIè¯·æ±‚å°†æºå¸¦è®¤è¯ä»¤ç‰Œ`;
            } else {
                authStatus.className = 'alert alert-warning';
                authMessage.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>è®¤è¯çŠ¶æ€å¼‚å¸¸: ${message || 'æœªçŸ¥é”™è¯¯'} - éƒ¨åˆ†APIå¯èƒ½è¿”å›403é”™è¯¯`;
            }
        }

        // ä»æœåŠ¡å™¨è·å–å½“å‰admin token
        async function fetchAdminToken() {
            try {
                const response = await fetch('/admin/token-status', {
                    method: 'GET',
                    credentials: 'include' // åŒ…å«session cookie
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.valid && data.token) {
                        // å°†tokenä¿å­˜åˆ°sessionStorage
                        sessionStorage.setItem('adminToken', data.token);
                        console.log('Admin tokenå·²è·å–å¹¶ä¿å­˜');
                        updateAuthStatus(true, data.username, 'è®¤è¯æˆåŠŸ');
                        return data.token;
                    } else {
                        console.warn('Tokenæ— æ•ˆæˆ–ä¸å­˜åœ¨:', data.message);
                        updateAuthStatus(false, null, data.message);
                    }
                } else {
                    console.warn('è·å–tokençŠ¶æ€å¤±è´¥:', response.status);
                    updateAuthStatus(false, null, `HTTP ${response.status}`);
                }
            } catch (error) {
                console.warn('è·å–admin tokenå¤±è´¥:', error);
                updateAuthStatus(false, null, error.message);
            }
            return null;
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('APIæµ‹è¯•é¡µé¢å·²åŠ è½½');

            // è·å–admin token
            await fetchAdminToken();

            // è·å–æ‰€æœ‰APIæ•°æ®
            const tableRows = document.querySelectorAll('tbody tr');
            tableRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 4) {
                    allApiData.push({
                        method: cells[0].textContent.trim(),
                        url: cells[1].textContent.trim(),
                        description: cells[2].textContent.trim(),
                        category: cells[3].textContent.trim(),
                        row: row
                    });
                }
            });

            showToast('APIæµ‹è¯•é¡µé¢å·²å‡†å¤‡å°±ç»ª', 'success');
        });
    </script>

</body>
</html>
