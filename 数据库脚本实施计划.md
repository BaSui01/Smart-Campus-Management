# 智慧校园管理平台 - 数据库脚本实施计划

## 📋 实施概述

本文档详细规划了数据库脚本的创建和执行计划，为智慧校园管理平台提供完整的数据库环境搭建方案。

## 🗂️ 文件结构规划

```
database/
├── scripts/                    # SQL脚本目录
│   ├── 01_create_database.sql  # 数据库创建脚本
│   ├── 02_create_tables.sql    # 表结构创建脚本
│   ├── 03_create_indexes.sql   # 索引创建脚本
│   ├── 04_create_views.sql     # 视图创建脚本
│   ├── 05_init_data.sql        # 初始化数据脚本
│   └── 06_test_data.sql        # 测试数据脚本
├── deploy/                     # 部署配置
│   ├── docker-compose.yml      # Docker容器配置
│   ├── mysql.cnf               # MySQL配置文件
│   ├── backup.sh               # 备份脚本
│   └── restore.sh              # 恢复脚本
├── docs/                       # 文档
│   ├── README.md               # 使用说明
│   └── CHANGELOG.md            # 变更记录
└── execute.sh                  # 一键执行脚本
```

## 📜 脚本文件详细内容

### 1. 01_create_database.sql - 数据库创建脚本

```sql
-- =====================================================
-- 智慧校园管理平台 - 数据库创建脚本
-- 版本: 1.0.0
-- 创建时间: 2025-06-03
-- 描述: 创建数据库、用户和基本配置
-- =====================================================

-- 设置字符集
SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- 创建数据库
DROP DATABASE IF EXISTS campus_management;
CREATE DATABASE campus_management
DEFAULT CHARACTER SET utf8mb4
COLLATE utf8mb4_unicode_ci;

-- 使用数据库
USE campus_management;

-- 设置时区
SET time_zone = '+08:00';

-- 创建数据库用户
DROP USER IF EXISTS 'campus_user'@'%';
CREATE USER 'campus_user'@'%' IDENTIFIED BY 'campus_password';

-- 授权
GRANT SELECT, INSERT, UPDATE, DELETE ON campus_management.* TO 'campus_user'@'%';
FLUSH PRIVILEGES;

-- 显示创建结果
SHOW DATABASES LIKE 'campus_management';
SELECT USER();
```

### 2. 02_create_tables.sql - 表结构创建脚本

```sql
-- =====================================================
-- 智慧校园管理平台 - 表结构创建脚本
-- 版本: 1.0.0
-- 创建时间: 2025-06-03
-- 描述: 创建所有业务表结构
-- =====================================================

USE campus_management;
SET FOREIGN_KEY_CHECKS = 0;

-- ===========================================
-- 用户管理模块
-- ===========================================

-- 1. 用户基础表
CREATE TABLE tb_user (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '用户ID',
    username VARCHAR(50) NOT NULL UNIQUE COMMENT '用户名',
    password VARCHAR(255) NOT NULL COMMENT '密码（加密）',
    email VARCHAR(100) UNIQUE COMMENT '邮箱',
    phone VARCHAR(20) COMMENT '手机号',
    real_name VARCHAR(50) COMMENT '真实姓名',
    avatar_url VARCHAR(255) COMMENT '头像URL',
    status TINYINT DEFAULT 1 COMMENT '状态：1-正常，0-禁用',
    last_login_time DATETIME COMMENT '最后登录时间',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) COMMENT='用户基础表';

-- 2. 角色表
CREATE TABLE tb_role (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '角色ID',
    role_code VARCHAR(50) NOT NULL UNIQUE COMMENT '角色编码',
    role_name VARCHAR(100) NOT NULL COMMENT '角色名称',
    description VARCHAR(255) COMMENT '角色描述',
    status TINYINT DEFAULT 1 COMMENT '状态：1-正常，0-禁用',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) COMMENT='角色表';

-- 3. 用户角色关联表
CREATE TABLE tb_user_role (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    role_id BIGINT NOT NULL COMMENT '角色ID',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间'
) COMMENT='用户角色关联表';

-- ... 继续创建其他18张表 ...
-- (由于内容较长，这里省略具体表结构，实际脚本将包含完整的21张表)

SET FOREIGN_KEY_CHECKS = 1;
```

### 3. 03_create_indexes.sql - 索引创建脚本

```sql
-- =====================================================
-- 智慧校园管理平台 - 索引创建脚本
-- 版本: 1.0.0
-- 创建时间: 2025-06-03
-- 描述: 创建性能优化索引
-- =====================================================

USE campus_management;

-- ===========================================
-- 用户管理模块索引
-- ===========================================

-- 用户表索引
ALTER TABLE tb_user ADD INDEX idx_username (username);
ALTER TABLE tb_user ADD INDEX idx_email (email);
ALTER TABLE tb_user ADD INDEX idx_phone (phone);
ALTER TABLE tb_user ADD INDEX idx_status (status);

-- 学生表索引
ALTER TABLE tb_student ADD INDEX idx_student_no (student_no);
ALTER TABLE tb_student ADD INDEX idx_class_id (class_id);
ALTER TABLE tb_student ADD INDEX idx_grade (grade);

-- ===========================================
-- 复合索引（多条件查询优化）
-- ===========================================

-- 学生成绩查询复合索引
ALTER TABLE tb_grade ADD INDEX idx_student_semester_course (student_id, semester, course_id);

-- 消息查询复合索引
ALTER TABLE tb_message ADD INDEX idx_target_status_time (target_type, status, created_time);

-- 考试安排查询复合索引
ALTER TABLE tb_course_schedule ADD INDEX idx_semester_day_time (semester, day_of_week, start_time);

-- 缴费记录查询复合索引
ALTER TABLE tb_payment_record ADD INDEX idx_student_time_status (student_id, payment_time, status);
```

### 4. 04_create_views.sql - 视图创建脚本

```sql
-- =====================================================
-- 智慧校园管理平台 - 视图创建脚本
-- 版本: 1.0.0
-- 创建时间: 2025-06-03
-- 描述: 创建业务查询视图
-- =====================================================

USE campus_management;

-- ===========================================
-- 业务查询视图
-- ===========================================

-- 1. 学生信息概览视图
CREATE VIEW v_student_overview AS
SELECT
    s.id,
    s.student_no,
    u.real_name,
    u.email,
    u.phone,
    s.grade,
    c.class_name,
    c.class_no,
    tu.real_name as head_teacher_name,
    s.enrollment_date,
    s.status as student_status
FROM tb_student s
JOIN tb_user u ON s.user_id = u.id
LEFT JOIN tb_class c ON s.class_id = c.id
LEFT JOIN tb_teacher t ON c.head_teacher_id = t.id
LEFT JOIN tb_user tu ON t.user_id = tu.id;

-- 2. 教师课程安排视图
CREATE VIEW v_teacher_schedule AS
SELECT
    cs.id,
    t.teacher_no,
    tu.real_name as teacher_name,
    c.course_code,
    c.course_name,
    cs.semester,
    cs.day_of_week,
    cs.start_time,
    cs.end_time,
    cs.classroom,
    cl.class_name,
    cs.current_students,
    cs.max_students
FROM tb_course_schedule cs
JOIN tb_teacher t ON cs.teacher_id = t.id
JOIN tb_user tu ON t.user_id = tu.id
JOIN tb_course c ON cs.course_id = c.id
LEFT JOIN tb_class cl ON cs.class_id = cl.id
WHERE cs.status = 1;

-- 3. 用户消息概览视图
CREATE VIEW v_user_message_overview AS
SELECT
    u.id as user_id,
    u.username,
    u.real_name,
    COUNT(mr.id) as total_messages,
    COUNT(CASE WHEN mr.is_read = 0 THEN 1 END) as unread_count,
    COUNT(CASE WHEN mr.is_starred = 1 THEN 1 END) as starred_count,
    MAX(mr.created_time) as latest_message_time
FROM tb_user u
LEFT JOIN tb_message_read mr ON u.id = mr.user_id AND mr.is_deleted = 0
GROUP BY u.id, u.username, u.real_name;
```

### 5. 05_init_data.sql - 初始化数据脚本

```sql
-- =====================================================
-- 智慧校园管理平台 - 初始化数据脚本
-- 版本: 1.0.0
-- 创建时间: 2025-06-03
-- 描述: 插入系统运行必需的基础数据
-- =====================================================

USE campus_management;

-- ===========================================
-- 基础角色数据
-- ===========================================

INSERT INTO tb_role (role_code, role_name, description) VALUES
('ADMIN', '系统管理员', '系统管理员角色，拥有所有权限'),
('TEACHER', '教师', '教师角色，负责教学管理'),
('STUDENT', '学生', '学生角色，进行学习活动'),
('PARENT', '家长', '家长角色，关注学生动态');

-- ===========================================
-- 系统配置数据
-- ===========================================

INSERT INTO tb_system_config (config_key, config_value, config_desc, config_type, is_system) VALUES
('system.name', '智慧校园管理平台', '系统名称', 'STRING', 1),
('system.version', '1.0.0', '系统版本', 'STRING', 1),
('system.logo', '/assets/logo.png', '系统Logo', 'STRING', 1),
('course.max_selection', '10', '学生最大选课数量', 'INT', 1),
('exam.auto_grading', 'true', '是否启用自动批改', 'BOOLEAN', 1),
('email.enabled', 'true', '邮件功能是否启用', 'BOOLEAN', 1),
('email.sender', 'noreply@campus.edu', '系统邮件发送地址', 'STRING', 1),
('notification.batch_size', '100', '批量通知每批处理数量', 'INT', 1),
('file.upload.max_size', '10485760', '文件上传最大大小（字节）', 'INT', 1),
('session.timeout', '7200', '会话超时时间（秒）', 'INT', 1);

-- ===========================================
-- 消息模板数据
-- ===========================================

INSERT INTO tb_message_template (template_code, template_name, template_type, message_type, title_template, content_template, variables, send_channels) VALUES
('GRADE_PUBLISHED', '成绩发布通知', 'SYSTEM', 'NOTICE', '${courseName}成绩已发布', '您好，${studentName}同学！\n\n您的${courseName}课程成绩已发布：\n总成绩：${finalScore}分\n等级：${gradeLevel}\n\n请及时登录系统查看详细成绩信息。', '["studentName","courseName","finalScore","gradeLevel"]', '["SYSTEM","EMAIL"]'),

('EXAM_REMINDER', '考试提醒', 'SYSTEM', 'REMINDER', '${examName}考试提醒', '您好，${studentName}同学！\n\n提醒您：\n考试名称：${examName}\n考试时间：${examDate} ${startTime}-${endTime}\n考试地点：${roomName}\n座位号：${seatNumber}\n\n请提前30分钟到达考场，携带好相关证件。', '["studentName","examName","examDate","startTime","endTime","roomName","seatNumber"]', '["SYSTEM","EMAIL"]'),

('PAYMENT_DUE', '缴费提醒', 'SYSTEM', 'REMINDER', '${itemName}缴费提醒', '您好，${studentName}的家长！\n\n${itemName}缴费即将到期：\n缴费金额：${amount}元\n截止日期：${dueDate}\n\n请及时完成缴费，避免影响学生正常学习。', '["studentName","itemName","amount","dueDate"]', '["SYSTEM","EMAIL"]');

-- ===========================================
-- 默认管理员账户
-- ===========================================

-- 创建默认管理员用户（密码: admin123）
INSERT INTO tb_user (username, password, email, real_name, status) VALUES
('admin', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBaLzQKW5QxJFy', 'admin@campus.edu', '系统管理员', 1);

-- 绑定管理员角色
INSERT INTO tb_user_role (user_id, role_id) VALUES (1, 1);
```

### 6. 06_test_data.sql - 测试数据脚本

```sql
-- =====================================================
-- 智慧校园管理平台 - 测试数据脚本
-- 版本: 1.0.0
-- 创建时间: 2025-06-03
-- 描述: 插入开发调试用的测试数据
-- =====================================================

USE campus_management;

-- ===========================================
-- 测试用户数据
-- ===========================================

-- 创建测试教师
INSERT INTO tb_user (username, password, email, real_name, phone, status) VALUES
('teacher001', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBaLzQKW5QxJFy', 'teacher001@campus.edu', '张老师', '13800001001', 1),
('teacher002', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBaLzQKW5QxJFy', 'teacher002@campus.edu', '李老师', '13800001002', 1);

-- 绑定教师角色
INSERT INTO tb_user_role (user_id, role_id) VALUES (2, 2), (3, 2);

-- 创建教师信息
INSERT INTO tb_teacher (user_id, teacher_no, department, title, hire_date, status) VALUES
(2, 'T001', '计算机科学与技术', '副教授', '2020-09-01', 1),
(3, 'T002', '数学与应用数学', '讲师', '2021-03-01', 1);

-- 创建测试学生
INSERT INTO tb_user (username, password, email, real_name, phone, status) VALUES
('student001', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBaLzQKW5QxJFy', 'student001@campus.edu', '王小明', '13900001001', 1),
('student002', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBaLzQKW5QxJFy', 'student002@campus.edu', '李小红', '13900001002', 1);

-- 绑定学生角色
INSERT INTO tb_user_role (user_id, role_id) VALUES (4, 3), (5, 3);

-- ===========================================
-- 班级和课程测试数据
-- ===========================================

-- 创建测试班级
INSERT INTO tb_class (class_name, class_no, grade, head_teacher_id, max_students, current_students, status) VALUES
('计算机2023-1班', 'CS2023-1', '2023级', 1, 30, 2, 1),
('计算机2023-2班', 'CS2023-2', '2023级', 2, 30, 0, 1);

-- 创建学生信息
INSERT INTO tb_student (user_id, student_no, grade, class_id, enrollment_date, status) VALUES
(4, '2023001001', '2023级', 1, '2023-09-01', 1),
(5, '2023001002', '2023级', 1, '2023-09-01', 1);

-- 更新班级学生数量
UPDATE tb_class SET current_students = 2 WHERE id = 1;

-- 创建测试课程
INSERT INTO tb_course (course_code, course_name, credits, course_type, department, description, status) VALUES
('CS101', 'Java程序设计', 4.0, '必修', '计算机科学与技术', 'Java语言基础及面向对象编程', 1),
('MATH101', '高等数学', 5.0, '必修', '数学与应用数学', '微积分基础理论与应用', 1);
```

## 🐳 Docker 部署配置

### docker-compose.yml

```yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: campus_mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: campus_management
      MYSQL_USER: campus_user
      MYSQL_PASSWORD: campus_password
      TZ: Asia/Shanghai
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./mysql.cnf:/etc/mysql/conf.d/mysql.cnf
      - ./scripts:/docker-entrypoint-initdb.d
    command: --default-authentication-plugin=mysql_native_password
    networks:
      - campus_network

  redis:
    image: redis:7-alpine
    container_name: campus_redis
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - campus_network

volumes:
  mysql_data:
  redis_data:

networks:
  campus_network:
    driver: bridge
```

### mysql.cnf

```ini
[mysqld]
# 基本配置
default-storage-engine=INNODB
character-set-server=utf8mb4
collation-server=utf8mb4_unicode_ci
init_connect='SET NAMES utf8mb4'

# 性能优化
innodb_buffer_pool_size=256M
innodb_log_file_size=64M
innodb_file_per_table=1
innodb_flush_log_at_trx_commit=1

# 时区设置
default-time-zone='+08:00'

# 连接配置
max_connections=200
max_connect_errors=100

[mysql]
default-character-set=utf8mb4

[client]
default-character-set=utf8mb4
```

## 🚀 执行脚本

### execute.sh - 一键执行脚本

```bash
#!/bin/bash

# =====================================================
# 智慧校园管理平台 - 数据库一键部署脚本
# 版本: 1.0.0
# 描述: 自动执行所有数据库脚本
# =====================================================

# 设置颜色输出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 数据库连接配置
DB_HOST="localhost"
DB_PORT="3306"
DB_USER="root"
DB_PASSWORD="root_password"

# 脚本目录
SCRIPT_DIR="./scripts"

# 输出函数
print_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# 检查MySQL连接
check_mysql_connection() {
    print_info "检查MySQL连接..."
    mysql -h $DB_HOST -P $DB_PORT -u $DB_USER -p$DB_PASSWORD -e "SELECT 1;" > /dev/null 2>&1
    if [ $? -eq 0 ]; then
        print_info "MySQL连接成功"
        return 0
    else
        print_error "MySQL连接失败，请检查配置"
        return 1
    fi
}

# 执行SQL脚本
execute_sql_script() {
    local script_file=$1
    local script_name=$(basename $script_file)

    print_info "执行脚本: $script_name"
    mysql -h $DB_HOST -P $DB_PORT -u $DB_USER -p$DB_PASSWORD < $script_file

    if [ $? -eq 0 ]; then
        print_info "脚本 $script_name 执行成功"
        return 0
    else
        print_error "脚本 $script_name 执行失败"
        return 1
    fi
}

# 主执行流程
main() {
    print_info "开始部署智慧校园管理平台数据库..."

    # 检查MySQL连接
    check_mysql_connection
    if [ $? -ne 0 ]; then
        exit 1
    fi

    # 按顺序执行脚本
    scripts=(
        "01_create_database.sql"
        "02_create_tables.sql"
        "03_create_indexes.sql"
        "04_create_views.sql"
        "05_init_data.sql"
        "06_test_data.sql"
    )

    for script in "${scripts[@]}"; do
        script_path="$SCRIPT_DIR/$script"
        if [ -f "$script_path" ]; then
            execute_sql_script "$script_path"
            if [ $? -ne 0 ]; then
                print_error "部署失败，请检查错误信息"
                exit 1
            fi
        else
            print_warning "脚本文件不存在: $script_path"
        fi
    done

    print_info "数据库部署完成！"
    print_info "默认管理员账户: admin / admin123"
}

# 执行主函数
main
```

## 📚 使用说明

### 本地部署

1. **安装MySQL 8.x**
2. **执行脚本**：
   ```bash
   chmod +x execute.sh
   ./execute.sh
   ```

### Docker部署

1. **启动容器**：
   ```bash
   docker-compose up -d
   ```

2. **查看日志**：
   ```bash
   docker-compose logs mysql
   ```

### 验证部署

```sql
-- 连接数据库
mysql -u campus_user -p campus_management

-- 验证表结构
SHOW TABLES;

-- 验证数据
SELECT COUNT(*) FROM tb_user;
SELECT COUNT(*) FROM tb_role;
```

## 🔄 下一步计划

1. **切换模式** - 需要切换到能够创建SQL文件的模式
2. **创建脚本** - 按照上述规划创建具体的SQL脚本文件
3. **测试验证** - 在开发环境中测试脚本的正确性
4. **文档完善** - 补充部署说明和故障排除指南

## ✅ 准备就绪

数据库脚本实施计划已经详细制定，包含了：
- 完整的SQL脚本内容规划
- Docker容器化部署配置
- 一键执行脚本
- 详细的使用说明

现在需要切换到合适的模式来创建具体的SQL脚本文件。
